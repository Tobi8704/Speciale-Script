---
title: "Green Party Parliamentary Representation and Climate Policy"
author: "Tobias"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# 1. Setup and Data Preparation

## 1.1 Package Installation and Loading

```{r package_installation}
# Install pacman if not already installed
if (!require("pacman")) install.packages("pacman")

# Use pacman to load all required packages
pacman::p_load(
  # Data manipulation
  dplyr, tidyr, magrittr, purrr, data.table, readr, lubridate, quantreg, MASS,
  
  # Visualization
  ggplot2, patchwork, scales, RColorBrewer, gridExtra, ggridges, corrplot, ggh4x, modelsummary, kableExtra, UpSetR, reshape2, viridis, plotly,
  
  # Statistical analysis
  rdd, rddtools, rddensity, rdrobust, rdlocrand, AER, ivreg,
  lmtest, sandwich, stargazer, broom, memisc, strucchange, plm,
  
  # Missing data analysis
  naniar,
  
  # Specific data sources
  manifestoR
)

# Load custom RDD functions if available
if (file.exists("gp_rdd_funktioner.R")) {
  source("gp_rdd_funktioner.R")
}

if (file.exists("coefficient_stability_plots.R")) {
  source("coefficient_stability_plots.R")
}

if (file.exists("placebo_tests.R")) {
  source("placebo_tests.R")
} 
```

## 1.2 Helper Functions

```{r helper_functions}
# Function to filter European countries
filter_european_countries <- function(data, country_col = "country_name") {
  european_countries <- c(
    "Austria", "Bulgaria", "Croatia", "Czech Republic", "Denmark", 
    "Estonia", "Finland", "Germany", "Greece", "Ireland", "Italy", 
    "Latvia", "Luxembourg", "Netherlands", "Norway", "Poland", 
    "Portugal", "Romania", "Slovakia", "Slovenia", "Spain", 
    "Sweden", "Switzerland"
  )
  
  filter(data, !!sym(country_col) %in% european_countries)
}

# Funktion til at udføre robusthedstest med forskellige båndbredder
run_rdd_robustness <- function(data, 
                              outcome_var = "miljø_afhængig",
                              running_var = "centered_lagged_pervote_samlet", 
                              bw_list = c(1, 1.5, 2, 2.5, 3),
                              polynomials = c(1, 2, 3, 4),
                              cutpoint = 0,
                              covariates = NULL,
                              group_label = "") {
  
  # Tom liste til resultater
  all_results <- list()
  
  # Håndtering af kovariater
  if (!is.null(covariates)) {
    # Opret kovariat-matrix på forhånd
    covs_matrix <- NULL
    if (length(covariates) > 0) {
      # Forsøg at bygge kovariat-matrix manuelt
      covs_list <- list()
      for (i in 1:length(covariates)) {
        col_name <- covariates[i]
        if (col_name %in% names(data)) {
          covs_list[[i]] <- data[[col_name]]
        } else {
          warning(paste("Kolonne", col_name, "findes ikke i datasættet."))
          covs_list[[i]] <- NULL
        }
      }
      # Fjern NULL værdier
      covs_list <- covs_list[!sapply(covs_list, is.null)]
      
      # Hvis der er nogen kovariater tilbage, lav en matrix
      if (length(covs_list) > 0) {
        covs_matrix <- do.call(cbind, covs_list)
      }
    }
  } else {
    covs_matrix <- NULL
  }
  
  # Loop over polynomier
  for (p in polynomials) {
    
    # HVIS p <= 2, laver vi 'ikke-parametrisk' med faste båndbredder
    if (p <= 2) {
      
      # Loop over båndbredder
      for (bw in bw_list) {
        # Prøv at køre rdrobust med fejlhåndtering
        tryCatch({
          # Kør rdrobust uden kovariater
          if (is.null(covs_matrix)) {
            rd <- rdrobust(
              y = data[[outcome_var]],
              x = data[[running_var]],
              c = cutpoint,
              p = p,
              h = bw
            )
          } else {
            # Kør rdrobust med kovariater
            rd <- rdrobust(
              y = data[[outcome_var]],
              x = data[[running_var]],
              c = cutpoint,
              p = p,
              h = bw,
              covs = covs_matrix
            )
          }
          
          # Gem KUN conventional-estimatet: [1]
          tmp <- data.frame(
            Bandwidth    = bw,
            Polynomial   = p,
            LATE         = formatC(rd$Estimate[1], format = "f", digits = 4),
            StdErr       = formatC(rd$se[1], format = "f", digits = 4),
            p_value      = formatC(rd$pv[1], format = "f", digits = 4),
            N_left_of_c  = rd$N_h[1],
            N_right_of_c = rd$N_h[2]
          )
          
          # Tilføj en kolonne med p-værdi-stjerner
          tmp$p_value_star <- paste0(
            tmp$p_value,
            ifelse(as.numeric(tmp$p_value) < 0.01, "***",
                   ifelse(as.numeric(tmp$p_value) < 0.05, "**",
                          ifelse(as.numeric(tmp$p_value) < 0.1, "*", "")))
          )
          
          # Læg i listen over resultater
          all_results[[paste0("p", p, "_bw", bw)]] <- tmp
          
        }, error = function(e) {
          warning(paste("Fejl ved kørsel af rdrobust med p =", p, "og bw =", bw, ":", e$message))
        })
      }
      
    } else {
      # HVIS p > 2, laver vi "global" og sætter h = NULL (eller en meget stor værdi)
      tryCatch({
        # Kør rdrobust uden kovariater
        if (is.null(covs_matrix)) {
          rd <- rdrobust(
            y = data[[outcome_var]],
            x = data[[running_var]],
            c = cutpoint,
            p = p,
            h = NULL   # lader rdrobust selv vælge båndbredde
          )
        } else {
          # Kør rdrobust med kovariater
          rd <- rdrobust(
            y = data[[outcome_var]],
            x = data[[running_var]],
            c = cutpoint,
            p = p,
            h = NULL,   # lader rdrobust selv vælge båndbredde
            covs = covs_matrix
          )
        }
        
        # Gem KUN conventional-estimatet: [1]
        tmp <- data.frame(
          Bandwidth    = NA,  # "Global" => ingen fastsat h
          Polynomial   = p,
          LATE         = formatC(rd$Estimate[1], format = "f", digits = 4),
          StdErr       = formatC(rd$se[1], format = "f", digits = 4),
          p_value      = formatC(rd$pv[1], format = "f", digits = 4),
          N_left_of_c  = rd$N_h[1],
          N_right_of_c = rd$N_h[2]
        )
        
        # Tilføj en kolonne med p-værdi-stjerner
        tmp$p_value_star <- paste0(
          tmp$p_value,
          ifelse(as.numeric(tmp$p_value) < 0.01, "***",
                 ifelse(as.numeric(tmp$p_value) < 0.05, "**",
                        ifelse(as.numeric(tmp$p_value) < 0.1, "*", "")))
        )
        
        # Læg i listen
        all_results[[paste0("p", p, "_global")]] <- tmp
        
      }, error = function(e) {
        warning(paste("Fejl ved kørsel af rdrobust med p =", p, "og global båndbredde:", e$message))
      })
    }
  }
  
  # Bind alle resultaterne sammen, men tjek at vi har nogle resultater
  if (length(all_results) > 0) {
    results_df <- do.call(rbind, all_results)
    
    # Tilføj en kolonne med gruppelabel, hvis angivet
    if (group_label != "") {
      results_df$Group <- group_label
    }
    
    return(results_df)
  } else {
    warning("Ingen resultater produceret. Tjek data og parametre.")
    return(NULL)
  }
}



# Function to calculate Lowe's RILE score
calculate_rile_lowe <- function(data) {
  right_cols <- c("per104", "per201", "per203", "per305", "per401", "per402", "per407", 
                 "per414", "per505", "per601", "per603", "per605", "per606")
  left_cols <- c("per103", "per105", "per106", "per107", "per202", "per403", "per404", 
                "per406", "per412", "per413", "per504", "per506", "per701")
  
  # Debug: Identify missing columns
  missing_right <- right_cols[!right_cols %in% names(data)]
  missing_left <- left_cols[!left_cols %in% names(data)]
  print(paste("Missing right columns:", paste(missing_right, collapse=", ")))
  print(paste("Missing left columns:", paste(missing_left, collapse=", ")))
  
  # Filter to only include columns that exist in the dataset
  right_cols_exist <- right_cols[right_cols %in% names(data)]
  left_cols_exist <- left_cols[left_cols %in% names(data)]
  
  # Calculate RILE score
  data %>%
    mutate(rile_lowe = log((rowSums(dplyr::select(., dplyr::all_of(right_cols_exist)) + 0.5)) / 
                          (rowSums(dplyr::select(., dplyr::all_of(left_cols_exist)) + 0.5))))
}

# Function to calculate environmental position
calculate_env_position <- function(data) {
  data %>%
    mutate(
      miljø_afhængig = log((per416 + per501 + 0.5) / (per410 + 0.5))
    )
}

# Function to remove duplicates based on specific columns
remove_duplicates <- function(data, group_cols, value_col) {
  data %>%
    dplyr::group_by(dplyr::across(dplyr::all_of(group_cols))) %>%
    dplyr::mutate(max_value = max({{value_col}}, na.rm = TRUE)) %>%
    dplyr::filter({{value_col}} == max_value) %>%
    dplyr::distinct(dplyr::across(dplyr::all_of(group_cols)), .keep_all = TRUE) %>%
    dplyr::ungroup() %>%
    dplyr::select(-"max_value")  # Change to this or the alternate option below
}

# Function to create standard RDD plot
plot_rdd <- function(data, x_var, y_var, group_var, 
                    x_limit = 10, 
                    x_label = "Running Variable", 
                    y_label = "Outcome", 
                    title = "RDD Plot") {
  # Ensure x_var, y_var, and group_var are treated as strings (column names)
  ggplot(data = subset(data, data[[x_var]] <= x_limit)) +
    geom_point(aes(x = .data[[x_var]], y = .data[[y_var]], shape = .data[[group_var]]), size = 2) +
    geom_smooth(data = subset(data, data[[x_var]] < 0),
                aes(x = .data[[x_var]], y = .data[[y_var]]),
                method = 'lm', formula = y ~ poly(x, 3, raw = TRUE), 
                linetype = 1, color = 'black', size = 1) +
    geom_smooth(data = subset(data, data[[x_var]] >= 0),
                aes(x = .data[[x_var]], y = .data[[y_var]]),
                method = 'lm', formula = y ~ poly(x, 3, raw = TRUE), 
                linetype = 1, color = 'black', size = 1) +
    scale_shape_manual(values = c(1, 16)) +  # 1 = tom cirkel, 16 = fyldt cirkel
    geom_vline(xintercept = 0, linetype = 2, size = .6) +
    xlim(-5, x_limit) +  # Sætter x-aksens grænser
    theme_minimal() +
    labs(title = title, x = x_label, y = y_label) +
    theme(legend.position = 'bottom', legend.title = element_blank())
}

# Run RDD analysis with multiple specifications
run_rdrobust_analysis <- function(data, p, bw = NULL, interaction_var = NULL) {
  # Base covariates
  base_covs <- cbind(
    as.numeric(factor(data$country)),
    as.numeric(factor(data$edate))
  )
  
  # Add interaction term if provided
  if(!is.null(interaction_var)) {
    covs <- cbind(
      base_covs,
      data[[interaction_var]],
      data[[interaction_var]] * data$lagged_i_parlament
    )
  } else {
    covs <- base_covs
  }
  
  # Run RD analysis
  rd <- rdrobust(
    y = data$miljø_afhængig,
    x = data$centered_lagged_pervote_samlet,
    c = 0,
    p = p,
    h = bw,
    covs = covs
  )
  
  return(rd)
}

# Function for zoomed-in RDD plots
jump_plot_cutoff <- function(data, force_var, y_var, group_var, polynomial=1, window=2) {
  # Select data within window
  plot_data <- subset(data, abs(data[[force_var]]) <= window)
  
  # Create plot
  p <- ggplot() +
    geom_point(data = plot_data,
              aes_string(x = force_var, y = y_var, shape = group_var),
              size = 2) +
    geom_smooth(data = subset(plot_data, plot_data[[force_var]] < 0),
                aes_string(x = force_var, y = y_var),
                method = 'lm',
                formula = y ~ poly(x, polynomial, raw = TRUE),
                linetype = 1,
                color = 'black',
                size = 1) +
    geom_smooth(data = subset(plot_data, plot_data[[force_var]] >= 0),
                aes_string(x = force_var, y = y_var),
                method = 'lm',
                formula = y ~ poly(x, polynomial, raw = TRUE),
                linetype = 1,
                color = 'black',
                size = 1) +
    scale_x_continuous(name = 'Green Party Vote Share (centered)',
                     limits = c(-window, window),
                     breaks = seq(-window, window, window/2)) +
    geom_vline(xintercept = 0, linetype = 2, size = 0.6) +
    theme_minimal() +
    theme(legend.position = 'bottom', legend.title = element_blank()) +
    labs(title = paste0("RDD Plot (Window = ±", window, ")"),
         y = "Climate Position")
  
  return(p)
}

# Nye funktioner for zero-inflation og kvantil regression ----------------
# Definer nye funktioner for zero-inflation og kvantil regression
# Funktion til at visualisere two-part model resultater
create_two_part_model_visualization <- function(data, outcome_var, running_var, treatment_var, polynomial, bandwidth, covariates) {
  # Del 1: Sandsynlighed for ikke-nul værdier
  binary_formula <- as.formula(paste0("I(", outcome_var, " != 0) ~ ", 
                                     running_var, " * ", treatment_var, " + ", 
                                     paste0(covariates, collapse = " + ")))
  binary_model <- glm(binary_formula, family = binomial, data = data)
  
  # Del 2: Model for ikke-nul værdier
  nonzero_data <- subset(data, data[[outcome_var]] != 0)
  continuous_formula <- as.formula(paste0(outcome_var, " ~ ", 
                                        running_var, " * ", treatment_var, " + ", 
                                        paste0(covariates, collapse = " + ")))
  continuous_model <- lm(continuous_formula, data = nonzero_data)
  
  # Generer prædiktioner for visualisering
  pred_data <- expand.grid(
    temp_running = seq(min(data[[running_var]], na.rm = TRUE), max(data[[running_var]], na.rm = TRUE), length.out = 100),
    temp_treatment = c(0, 1)
  )
  names(pred_data) <- c(running_var, treatment_var)
  
  # Tilføj kovariater med gennemsnitsværdier
  for (cov in covariates) {
    if (is.factor(data[[cov]]) || is.character(data[[cov]])) {
      # For kategoriske variable, brug den hyppigste værdi
      pred_data[[cov]] <- names(sort(table(data[[cov]]), decreasing = TRUE)[1])
    } else {
      # For numeriske variable, brug gennemsnit
      pred_data[[cov]] <- mean(data[[cov]], na.rm = TRUE)
    }
  }
  
  # Beregn prædikterede værdier
  pred_data$binary_pred <- predict(binary_model, newdata = pred_data, type = "response")
  
  # For continuous_model, skal vi håndtere at det kun er for ikke-nul værdier
  # Vi bruger en dummy værdi for kontinuert model prædiktioner
  pred_data$continuous_pred <- 0
  try({
    pred_data$continuous_pred <- predict(continuous_model, newdata = pred_data)
  }, silent = TRUE)
  
  # Beregn samlet effekt (sandsynlighed for ikke-nul * værdi givet ikke-nul)
  pred_data$combined_effect <- pred_data$binary_pred * pred_data$continuous_pred
  
  # Forbered data til plot
  pred_data$treatment_label <- factor(pred_data[[treatment_var]], 
                                    levels = c(0, 1), 
                                    labels = c("Uden behandling", "Med behandling"))
  
  # Lav plot
  library(ggplot2)
  p1 <- ggplot(pred_data, aes(x = .data[[running_var]], y = binary_pred, color = treatment_label)) +
    geom_line() +
    geom_vline(xintercept = 0, linetype = "dashed") +
    labs(title = "Sandsynlighed for ikke-nul klimaposition",
         x = paste0(running_var, " (centreret)"),
         y = "Sandsynlighed",
         color = "Behandlingsstatus") +
    theme_minimal()
  
  p2 <- ggplot(pred_data, aes(x = .data[[running_var]], y = continuous_pred, color = treatment_label)) +
    geom_line() +
    geom_vline(xintercept = 0, linetype = "dashed") +
    labs(title = "Værdi af klimaposition givet ikke-nul",
         x = paste0(running_var, " (centreret)"),
         y = "Værdi",
         color = "Behandlingsstatus") +
    theme_minimal()
  
  p3 <- ggplot(pred_data, aes(x = .data[[running_var]], y = combined_effect, color = treatment_label)) +
    geom_line() +
    geom_vline(xintercept = 0, linetype = "dashed") +
    labs(title = "Samlet effekt: Sandsynlighed * Værdi",
         x = paste0(running_var, " (centreret)"),
         y = "Forventet værdi",
         color = "Behandlingsstatus") +
    theme_minimal()
  
  # Kombiner plots
  if (requireNamespace("gridExtra", quietly = TRUE)) {
    combined_plot <- gridExtra::grid.arrange(p1, p2, p3, ncol = 1,
                                           top = "Two-part model resultater")
    return(combined_plot)
  } else {
    # Returner det vigtigste plot hvis gridExtra ikke er tilgængelig
    return(p3)
  }
}

# Funktion til at visualisere kvantil regressionseffekter
create_quantile_effect_plot <- function(data, outcome_var, running_var, treatment_var, quantiles, covariates, title) {
  library(quantreg)
  library(ggplot2)
  
  # Forbered resultater
  results <- data.frame(
    Quantile = numeric(),
    Estimate = numeric(),
    StdError = numeric(),
    Lower = numeric(),
    Upper = numeric()
  )
  
  # Kør kvantil regression for hver kvantil
  for (q in quantiles) {
    formula_str <- paste0(outcome_var, " ~ ", running_var, " * ", treatment_var)
    if (length(covariates) > 0) {
      formula_str <- paste0(formula_str, " + ", paste0(covariates, collapse = " + "))
    }
    
    rq_model <- rq(as.formula(formula_str), tau = q, data = data)
    coef_summary <- summary(rq_model)
    
    # Få koefficienten for treatment
    coef_idx <- which(rownames(coef_summary$coefficients) == treatment_var)
    if (length(coef_idx) > 0) {
      estimate <- coef_summary$coefficients[coef_idx, 1]
      std_error <- coef_summary$coefficients[coef_idx, 2]
      
      # Beregn konfidensinterval
      lower <- estimate - 1.96 * std_error
      upper <- estimate + 1.96 * std_error
      
      results <- rbind(results, data.frame(
        Quantile = q,
        Estimate = estimate,
        StdError = std_error,
        Lower = lower,
        Upper = upper
      ))
    }
  }
  
  # Lav plot
  p <- ggplot(results, aes(x = Quantile, y = Estimate)) +
    geom_line() +
    geom_ribbon(aes(ymin = Lower, ymax = Upper), alpha = 0.2) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
    labs(title = title,
         x = "Kvantil",
         y = "Estimeret effekt af behandling") +
    theme_minimal()
  
  return(p)
}
```

## 1.3 Data Acquisition

```{r data_acquisition, warning=FALSE}
# Load Manifesto Project Dataset
mp_setapikey(key = "c1f14c8fb84af448bfdb511afd7f415e")
mpds <- mp_maindataset(version = "MPDS2024a")

# Load election and party data
view_election <- read_csv("view_election.csv")
view_party <- read_csv("view_party.csv")

# GDP Per Capita
gdp_per_capita <- read_delim("gdp_per_capita.csv", 
     delim = ";", escape_double = FALSE, col_types = cols(GDP_per_capita = col_number()), 
     locale = locale(decimal_mark = ",", grouping_mark = "."), 
     trim_ws = TRUE)
#View(gdp_per_capita)

gdp_per_capita_growth <- read_delim("gdp_per_capita_growth.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(gdp_capita_growth = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)

inflation_consumer_prices <- read_delim("inflation-consumer_prices.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(`Inflation-consumer prices` = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)

unemployment <- read_delim("unemployment.csv", 
    delim = ";", escape_double = FALSE, col_types = cols(Unemployment = col_number()), 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE)

# Filter for European countries
election_european <- filter_european_countries(view_election)
party_european <- filter_european_countries(view_party)
mpds_european <- filter_european_countries(mpds, "countryname")

# Subsetting to post-1960 data
mpds_european_1960 <- filter(mpds_european, date > 196000)
pg_election_all <- filter(election_european, election_date > "1960-01-01")
pg_parties_all <- party_european  # No date filtering needed
```

## 1.4 Data Integration and Preprocessing

```{r data_processing}
# Merge party and election data
pg_election_parties_europa <- merge(
  pg_election_all, 
  pg_parties_all[, c("party_id", "cmp", "family_id", "family_name", "family_name_short")], 
  by = "party_id", 
  all.x = FALSE, 
  all.y = FALSE
)

# Filter to ecology/green parties (family_id = 19) in parliamentary elections
pg_election_parties_europa_eco <- filter(
  pg_election_parties_europa, 
  family_id == 19 & election_type == "parliament"
)

# Filter to ecological parties in Manifesto data
mpds_european_1960_eco <- filter(mpds_european_1960, parfam == "10")

# Create a correction lookup table for Green parties
party_corrections <- tribble(
  ~party_id, ~country_name, ~cmp,
  308,  "Switzerland",    43120,
  1781, "Portugal",       35120,
  2254, "Norway",         12110,
  2651, "Austria",        42120,
  196,  "Czech Republic", 82110,
  219,  "Estonia",        83110
)

# Apply corrections to green party data
pg_election_parties_europa_eco <- pg_election_parties_europa_eco %>%
  rows_update(party_corrections, by = c("party_id", "country_name"))

# Merge manifesto data with party-election data for green parties
mpds_pg_1960_eco <- merge(
  mpds_european_1960_eco,
  pg_election_parties_europa_eco,
  by.x = c("countryname", "edate", "party"),
  by.y = c("country_name", "election_date", "cmp"),
  all = TRUE
)
```

## 1.5 Electoral Thresholds and Party Size

```{r thresholds_and_party_size}
# Import electoral threshold data
samlede_thresholds <- read_delim("Samlede Thresholds.csv", 
    delim = ";", 
    escape_double = FALSE, 
    locale = locale(decimal_mark = ",", grouping_mark = "."), 
    trim_ws = TRUE) %>%
  mutate(edate = dmy(edate))  # Convert to date format
#View(samlede_thresholds)
print(names(samlede_thresholds))

# Select relevant threshold columns
samlede_thresholds_sub <- samlede_thresholds %>%
  dplyr::select(country, edate, threshold, threshold_lagged)

# Merge thresholds with main manifesto dataset
mpds_european_1960 <- merge(
  mpds_european_1960,
  samlede_thresholds_sub,
  by = c("country", "edate"),
  all.x = FALSE
)

# Calculate average vote share and filter to mainstream parties (>=10% avg)
mpds_european_1960 <- mpds_european_1960 %>% 
  group_by(party) %>% 
  mutate(avg_pervote_main = mean(pervote, na.rm = TRUE)) %>% 
  ungroup() %>%
  filter(avg_pervote_main >= 10)
```

## 1.6 Green Party Parliament Presence and Vote Share

```{r green_party_data}
# Import green party vote share and parliament data
green_party_data <- read_delim(
  "mpds_pg_1960_eco_færdig_tilføjelse_af_ekstra_votes.csv", 
  delim = ";", 
  escape_double = FALSE, 
  col_types = cols(avg_vote_share = col_double()), 
  locale = locale(decimal_mark = ",", grouping_mark = "."), 
  trim_ws = TRUE
) %>%
  mutate(
    edate = as.Date(edate, format = "%d-%m-%Y"),
    edate = format(edate, "%Y/%m/%d")
  )


# Select relevant green party columns
green_party_data_sub <- green_party_data[
  , c("countryname", "edate", "pervote_samlet", "lagged_pervote_samlet", "i_parlament", "lagged_i_parlament")
]

# Merge with mainstream party data
full_dataset <- merge(
  mpds_european_1960,
  green_party_data_sub,
  by = c("countryname", "edate"),
  all.x = FALSE
)

# Fjern rader hvor parfam = 10
full_dataset <- full_dataset %>%
  filter(parfam != "10")

#View(full_dataset)

# Calculate Lowe's RILE score
full_dataset <- calculate_rile_lowe(full_dataset)

# Select final columns and remove duplicates
final_dataset <- full_dataset %>%
  dplyr::select(
    countryname, edate, country, party, oecdmember, eumember, date, 
    partyname, partyabbrev, parfam, absseat, per410, per416, per501, 
    threshold, threshold_lagged, pervote_samlet, lagged_pervote_samlet, 
    i_parlament, lagged_i_parlament, avg_pervote_main, rile, rile_lowe
  ) %>%
  remove_duplicates(
    c("countryname", "edate", "party"),
    pervote_samlet
  )
```

## 1.7 Final Variable Creation og Radical Right Parti Presence

```{r create_final_variables}
# Create all derived variables needed for analysis
final_dataset <- final_dataset %>%
  mutate(
    # Convert to numeric
    pervote_samlet = as.numeric(pervote_samlet),
    lagged_pervote_samlet = as.numeric(lagged_pervote_samlet),
    
    # Create centered variables (running variables for RDD)
    centered_pervote_samlet = pervote_samlet - threshold,
    centered_lagged_pervote_samlet = lagged_pervote_samlet - threshold_lagged,
    
    # Create dependent variable: environmental position
    miljø_afhængig = log((per416 + per501 + 0.5) / (per410 + 0.5)),
    
    miljø_afhængig_alt = log(per416 + per501 + 0.5) - log(per410 + 0.5),
    
    # Create factor variables for parliament presence
    factor_lagged_i_parlament = factor(
      lagged_i_parlament, 
      levels = c(0, 1), 
      labels = c("Green parties w/o seats", "Green parties w seat(s)")
    ),
    factor_i_parlament = factor(
      i_parlament, 
      levels = c(0, 1), 
      labels = c("Green parties w/o seats", "Green parties w seat(s)")
    ),
    
    # Create variables for party size (for H5)
    large_party = ifelse(avg_pervote_main > median(avg_pervote_main, na.rm = TRUE), 1, 0),
    
    # Create variables for left-right orientation (for H4)
    left_party = ifelse(rile_lowe < 0, 1, 0)
  )

# Lagged left_party
final_dataset <- final_dataset %>%
  dplyr::arrange(party, edate) %>%
  dplyr::group_by(party) %>%
  dplyr::mutate(left_party_lag1 = dplyr::lag(`left_party`, n = 1, order_by = edate))

# Lagged large_party
final_dataset <- final_dataset %>%
  dplyr::arrange(party, edate) %>%
  dplyr::group_by(party) %>%
  dplyr::mutate(large_party_lag1 = dplyr::lag(`large_party`, n = 1, order_by = edate))

# Sortér data efter parti og dato
final_dataset <- final_dataset %>% dplyr::arrange(party, edate)

# Beregn first difference inden for hvert parti
final_dataset <- final_dataset %>% 
  dplyr::group_by(party) %>% 
  dplyr::mutate(miljø_afhængig_fd = miljø_afhængig - dplyr::lag(miljø_afhængig)) %>% 
  dplyr::ungroup()



#GDP Per Capita
# Forbered datasættene ved at ekstrahere årstallet fra edate
final_dataset <- dplyr::mutate(final_dataset, 
                                Year = as.numeric(substr(edate, 1, 4)))

# Match datasættene ved hjælp af left_join
# Dette kopierer GDP_per_capita over i final_dataset
final_dataset <- dplyr::left_join(final_dataset, 
                                   gdp_per_capita, 
                                   by = c("countryname" = "countryname", 
                                          "Year" = "Year"))


# Step 1: Identificer valg hvor højreradikale partier var i parlamentet fra MPDataset
rrp_presence <- MPDataset_MPDS2024a %>%
  dplyr::filter(parfam == 70 & absseat > 0) %>%  # Højreradikale partier med mindst ét sæde
  dplyr::group_by(countryname, date) %>%
  dplyr::summarize(has_rrp = 1, .groups = "drop") %>%  # Brug et andet navn til indikatoren
  dplyr::distinct()  # Sikrer unikke valg-land kombinationer

# Step 2: Tilføj variablen til final_dataset
final_dataset <- final_dataset %>%
  dplyr::ungroup() %>%  # Fjern eventuel gruppering først
  dplyr::left_join(rrp_presence, by = c("countryname", "date")) %>%
  dplyr::mutate(rrp_i_p = ifelse(is.na(has_rrp), 0, 1))  # Opret ny kolonne baseret på has_rrp

# Step 3: Lav en lagged version grupperet efter land
final_dataset <- final_dataset %>%
  dplyr::group_by(countryname) %>%
  dplyr::arrange(countryname, date) %>%
  dplyr::mutate(rrp_i_p_lag1 = dplyr::lag(rrp_i_p, n = 1)) %>%
  dplyr::ungroup()


# Vis fordelingen af de nye variabler
print("Fordeling af rrp_i_p:")
print(table(final_dataset$rrp_i_p, useNA = "always"))
print("Fordeling af rrp_i_p_lag1:")
print(table(final_dataset$rrp_i_p_lag1, useNA = "always"))


View(final_dataset[, c("parfam","rrp_i_p_lag1", "rrp_i_p", "countryname", "party", "edate")])

#GDP Per Capita Growth
# Match datasættene ved hjælp af left_join
# Dette kopierer GDP_per_capita over i final_dataset
final_dataset <- dplyr::left_join(final_dataset, 
                                   gdp_per_capita_growth, 
                                   by = c("countryname" = "countryname", 
                                          "Year" = "Year"))

# Lagged gdp_per_capita_growth
final_dataset <- final_dataset %>%
  dplyr::arrange(party, edate) %>%
  dplyr::group_by(party) %>%
  dplyr::mutate(GDP_per_capita_lag1 = dplyr::lag(`gdp_capita_growth`, n = 1, order_by = edate))

View(final_dataset[, c("left_party", "left_party_lag1", "large_party", "large_party_lag1", "countryname", "party", "edate")])
#Unemployment
# Dette kopierer GDP_per_capita over i final_dataset
final_dataset <- dplyr::left_join(final_dataset, 
                                   unemployment, 
                                   by = c("countryname" = "countryname", 
                                          "Year" = "Year"))


#Inflation
# Dette kopierer GDP_per_capita over i final_dataset
final_dataset <- dplyr::left_join(final_dataset, 
                                   inflation_consumer_prices, 
                                   by = c("countryname" = "countryname", 
                                          "Year" = "Year"))

# ============================================================================
# 0. Create economic indicators
# ============================================================================

# Create a composite economic indicator from existing variables in final_dataset
# Standardize each variable first (higher value = better economy)
final_dataset <- final_dataset %>%
  mutate(
    gdp_growth_std = scale(`gdp_capita_growth`),
    inflation_std = -scale(`Inflation-consumer prices`),  # Minus because lower inflation is better
    unemployment_std = -scale(Unemployment)  # Minus because lower unemployment is better
  )

# Calculate an overall economic index (average of standardized values)
final_dataset <- final_dataset %>%
  mutate(
    economic_index = rowMeans(
      cbind(gdp_growth_std, inflation_std, unemployment_std),
      na.rm = TRUE
    ),
    # Create binary variable for good economy based on composite index
    good_economy = ifelse(economic_index > median(economic_index, na.rm = TRUE), 1, 0),
    # Add factor version of the variable for plots and models
    factor_good_economy = factor(good_economy, levels = c(0, 1), 
                                labels = c("Poor economy", "Good economy"))
  )

# Lagged good_economy_lag1
final_dataset <- final_dataset %>%
  dplyr::arrange(party, edate) %>%
  dplyr::group_by(party) %>%
  dplyr::mutate(good_economy_lag1 = dplyr::lag(`good_economy`, n = 1, order_by = edate))

final_dataset <- final_dataset %>%
  mutate(factor_good_economy_lag1 = factor(good_economy_lag1, levels = c(0, 1), 
                                labels = c("Poor economy", "Good economy")))

# Forberedelse af data med BNP-vækst som moderator
final_dataset <- final_dataset %>%
  mutate(
    # Opret binær variabel for høj/lav BNP-vækst baseret på median
    high_gdp_growth = ifelse(`gdp_capita_growth` > median(`gdp_capita_growth`, na.rm = TRUE), 1, 0),
    # Tilføj faktorniveauer for pænere plots og modeller
    factor_high_gdp_growth = factor(high_gdp_growth, levels = c(0, 1), 
                                  labels = c("Lav BNP-vækst", "Høj BNP-vækst"))
  )

# Lagged high_gdp_growth
final_dataset <- final_dataset %>%
  dplyr::arrange(party, edate) %>%
  dplyr::group_by(party) %>%
  dplyr::mutate(high_gdp_growth_lag1 = dplyr::lag(`high_gdp_growth`, n = 1, order_by = edate))

final_dataset <- final_dataset %>%
  mutate(factor_high_gdp_growth_lag1 = factor(high_gdp_growth_lag1, levels = c(0, 1), 
                                  labels = c("Lav BNP-vækst", "Høj BNP-vækst")))

# Create clean dataset for analysis (remove missing values)
clean_data <- na.omit(final_dataset)

#View(final_dataset)

```


# 2. Exploratory Data Analysis

```{r exploratory_plots}
# Opret først hovedmappen Robusthedstests, hvis den ikke allerede eksisterer
dir.create("Diskriptiv Analyse", showWarnings = FALSE)

# 1. Descriptive Statistics ------------------

# 1.1 Summary statistics table for key variables --------------
summary_stats <- final_dataset %>%
  dplyr::select(
    miljø_afhængig, per410, per416, per501, 
    pervote_samlet, lagged_pervote_samlet, 
    i_parlament, lagged_i_parlament,
    rile_lowe, avg_pervote_main, 
    rrp_i_p_lag1, `GDP_per_capita_lag1`, Unemployment, `Inflation-consumer prices`
  ) %>%
  summary()

# Creating a more formatted table
summary_table <- final_dataset %>%
  dplyr::select(
    miljø_afhængig, per410, per416, per501, 
    pervote_samlet, lagged_pervote_samlet, 
    i_parlament, lagged_i_parlament,
    rile_lowe, avg_pervote_main, 
    rrp_i_p_lag1, `GDP_per_capita_lag1`, Unemployment, `Inflation-consumer prices`
  ) %>%
  summarise(across(where(is.numeric), 
                   list(
                     mean = ~mean(., na.rm = TRUE),
                     median = ~median(., na.rm = TRUE),
                     sd = ~sd(., na.rm = TRUE),
                     min = ~min(., na.rm = TRUE),
                     max = ~max(., na.rm = TRUE),
                     n = ~sum(!is.na(.))
                   )))

# Reshape for better presentation
summary_long <- summary_table %>%
  pivot_longer(cols = everything(),
               names_to = c("variable", "stat"),
               names_pattern = "(.*)_(.*)",
               values_to = "value")

summary_wide <- summary_long %>%
  pivot_wider(names_from = stat, values_from = value) %>%
  arrange(variable)

# 1.2 Country-level summary --------------
country_summary <- final_dataset %>%
  group_by(countryname) %>%
  summarise(
    n_observations = n(),
    first_year = min(Year, na.rm = TRUE),
    last_year = max(Year, na.rm = TRUE),
    n_parties = n_distinct(party),
    avg_parties_per_year = n_parties / (last_year - first_year + 1),
    n_green_in_parl = sum(lagged_i_parlament, na.rm = TRUE),
    n_rrp_in_parl = sum(rrp_i_p_lag1, na.rm = TRUE),
    avg_climate_position = mean(miljø_afhængig, na.rm = TRUE)
  )

# 1.3 Electoral threshold variation --------------
threshold_summary <- final_dataset %>%
  group_by(countryname) %>%
  summarise(
    min_threshold = min(threshold, na.rm = TRUE),
    max_threshold = max(threshold, na.rm = TRUE),
    threshold_changed = min_threshold != max_threshold,
    avg_threshold = mean(threshold, na.rm = TRUE)
  )

# 1.4 Green party success rates over time --------------
green_success_time <- final_dataset %>%
  group_by(Year) %>%
  summarise(
    green_parties = sum(!is.na(pervote_samlet)),
    greens_in_parl = sum(i_parlament, na.rm = TRUE),
    success_rate = greens_in_parl / green_parties
  )

# Green party success by country
green_success_country <- final_dataset %>%
  group_by(countryname) %>%
  summarise(
    green_parties = sum(!is.na(pervote_samlet)),
    greens_in_parl = sum(i_parlament, na.rm = TRUE),
    success_rate = greens_in_parl / green_parties
  )

# 1.5 Visualize country coverage --------------
country_coverage_plot <- ggplot(country_summary, aes(x = reorder(countryname, n_observations), y = n_observations)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(
    title = "Number of Observations by Country",
    x = "Country",
    y = "Number of Observations"
  ) +
  theme_minimal()

# 1.6 Time coverage by country --------------
time_coverage <- final_dataset %>%
  group_by(countryname, Year) %>%
  summarise(has_obs = TRUE, .groups = "drop") %>%
  complete(countryname, Year = min(final_dataset$Year, na.rm = TRUE):max(final_dataset$Year, na.rm = TRUE)) %>%
  mutate(has_obs = ifelse(is.na(has_obs), FALSE, TRUE))

time_coverage_plot <- ggplot(time_coverage, aes(x = Year, y = countryname, fill = has_obs)) +
  geom_tile(color = "white") +
  scale_fill_manual(values = c("TRUE" = "steelblue", "FALSE" = "lightgray")) +
  labs(
    title = "Time Coverage by Country",
    x = "Year",
    y = "Country",
    fill = "Has Data"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")



# 2. Outcome Variable Analysis ------------

# 2.1 Distribution of climate position --------------
climate_dist_plot <- ggplot(final_dataset, aes(x = miljø_afhængig)) +
  geom_histogram(aes(y = ..density..), bins = 30, fill = "steelblue", color = "darkblue", alpha = 0.7) +
  geom_density(color = "red", size = 1) +
  labs(
    title = "Distribution of Climate Position Variable",
    x = "Climate Position (miljø_afhængig)",
    y = "Density"
  ) +
  theme_minimal()

# 2.2 Climate position by country --------------
climate_country_plot <- ggplot(final_dataset, aes(x = reorder(countryname, miljø_afhængig, FUN = median, na.rm = TRUE), 
                                               y = miljø_afhængig)) +
  geom_boxplot(fill = "steelblue", alpha = 0.7) +
  coord_flip() +
  labs(
    title = "Climate Position by Country",
    x = "Country",
    y = "Climate Position"
  ) +
  theme_minimal()

# 2.3 Climate position over time --------------
climate_time_plot <- final_dataset %>%
  group_by(Year) %>%
  summarise(
    mean_climate = mean(miljø_afhængig, na.rm = TRUE),
    median_climate = median(miljø_afhængig, na.rm = TRUE),
    lower_ci = mean_climate - 1.96 * sd(miljø_afhængig, na.rm = TRUE) / sqrt(n()),
    upper_ci = mean_climate + 1.96 * sd(miljø_afhængig, na.rm = TRUE) / sqrt(n())
  ) %>%
  ggplot(aes(x = Year, y = mean_climate)) +
  geom_line(size = 1, color = "steelblue") +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.2) +
  geom_line(aes(y = median_climate), linetype = "dashed", color = "darkred") +
  labs(
    title = "Climate Position Over Time",
    x = "Year",
    y = "Average Climate Position",
    caption = "Solid line: mean with 95% CI; Dashed line: median"
  ) +
  theme_minimal()

# 2.4 Components of climate position --------------
components_data <- final_dataset %>%
  dplyr::select(countryname, edate, party, per410, per416, per501) %>%
  pivot_longer(cols = c(per410, per416, per501),
               names_to = "component",
               values_to = "value") %>%
  mutate(component = case_when(
    component == "per410" ~ "Environmental Protection (per410)",
    component == "per416" ~ "Anti-Growth Economy (per416)",
    component == "per501" ~ "Environmental Protection: Positive (per501)",
    TRUE ~ component
  ))

components_plot <- ggplot(components_data, aes(x = value, fill = component)) +
  geom_histogram(bins = 20, alpha = 0.7, position = "identity") +
  facet_wrap(~ component) +
  labs(
    title = "Distribution of Climate Position Components",
    x = "Value",
    y = "Count"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

# 2.5 Climate position zero values analysis --------------
zero_prop <- final_dataset %>%
  dplyr::group_by(countryname) %>%
  summarise(
    total = n(),
    zero_values = sum(miljø_afhængig == 0, na.rm = TRUE),
    prop_zero = zero_values / total
  ) %>%
  arrange(desc(prop_zero))

zero_plot <- ggplot(zero_prop, aes(x = reorder(countryname, prop_zero), y = prop_zero)) +
  geom_bar(stat = "identity", fill = "darkred") +
  coord_flip() +
  labs(
    title = "Proportion of Zero Climate Position Values by Country",
    x = "Country",
    y = "Proportion of Zero Values"
  ) +
  theme_minimal()

# 2.6 Climate position by party family --------------
party_family_climate <- final_dataset %>%
  dplyr::mutate(
    party_family = case_when(
      parfam == "10" ~ "Green",
      parfam == "20" ~ "Socialist/Other left parties",
      parfam == "30" ~ "Social Democratic",
      parfam == "40" ~ "Liberal",
      parfam == "50" ~ "Christian Democratic",
      parfam == "60" ~ "Conservative",
      parfam == "70" ~ "Nationalist",
      parfam == "80" ~ "Agrarian",
      parfam == "90" ~ "Ethnic/Regional",
      parfam == "95" ~ "Special issue parties",
      parfam == "98" ~ "Electoral alliance w/o leader",
      TRUE ~ "Other"
    )
  ) %>%
  filter(!is.na(party_family))

family_climate_plot <- ggplot(party_family_climate, aes(x = reorder(party_family, miljø_afhængig, FUN = median, na.rm = TRUE), 
                                                     y = miljø_afhængig)) +
  geom_boxplot(fill = "steelblue", alpha = 0.7) +
  coord_flip() +
  labs(
    title = "Climate Position by Party Family",
    x = "Party Family",
    y = "Climate Position"
  ) +
  theme_minimal()

# 2.7 Andel nul-værdier for partifamilierne --------------
# Oprettelse af forbedret graf med de rigtige partifamilienavne
zero_climate_by_parfam <- final_dataset %>%
   mutate(
     party_family = case_when(
       parfam == "10" ~ "Green",
       parfam == "20" ~ "Socialist/Other left parties",
       parfam == "30" ~ "Social Democratic",
       parfam == "40" ~ "Liberal",
       parfam == "50" ~ "Christian Democratic",
       parfam == "60" ~ "Conservative",
       parfam == "70" ~ "Nationalist",
       parfam == "80" ~ "Agrarian",
       parfam == "90" ~ "Ethnic/Regional",
       parfam == "95" ~ "Special issue parties",
       parfam == "98" ~ "Electoral alliance w/o leader",
       TRUE ~ "Other"
     )
   ) %>%
   group_by(party_family) %>%
   summarise(
     zero_proportion = mean(miljø_afhængig == 0, na.rm = TRUE)
   ) %>%
   # Sortér fra høj til lav værdi
   arrange(desc(zero_proportion)) %>%
   # Omdanner til faktor med niveauerne i sorteret rækkefølge
   mutate(party_family = factor(party_family, levels = party_family))
 
 ggplot(zero_climate_by_parfam, aes(x = party_family, y = zero_proportion)) +
   geom_bar(stat = "identity", fill = "steelblue") +
   labs(
     title = "Proportion of Zero Climate Position Values by Party Family",
     x = "Party Family",
     y = "Proportion of Zero Values"
   ) +
   theme_minimal() +
   theme(
     panel.grid.major.y = element_blank(),
     panel.grid.minor.y = element_blank(),
     panel.grid.minor.x = element_blank(),
     axis.text.y = element_text(size = 9),
     plot.title = element_text(size = 12, face = "bold"),
     plot.margin = margin(10, 10, 10, 10)
   ) +
   coord_flip() +
   # Bruge decimaler i stedet for procent
   scale_y_continuous(labels = function(x) format(x, decimal.mark = ".", big.mark = ","), 
                     breaks = seq(0, 0.20, by = 0.05),
                     limits = c(0, 0.20))


# 3. Running Variable and Treatment Analysis --------------


# 3.1 Distribution of green party vote share relative to threshold --------------
rv_dist_plot <- ggplot(final_dataset, aes(x = centered_lagged_pervote_samlet)) +
  geom_histogram(binwidth = 0.5, fill = "steelblue", color = "darkblue") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 1) +
  labs(
    title = "Distribution of Green Party Vote Share (Centered at Threshold)",
    x = "Centered Vote Share",
    y = "Count"
  ) +
  theme_minimal()

# 3.2 Density test around threshold (McCrary test) --------------
# Estimér og test tæthedsdiskontinuitet
rdd_result <- rddensity(final_dataset$centered_lagged_pervote_samlet, c = 0)
density_test_summary <- summary(rdd_result)

# Plot med indbygget funktion (korrekt metode ifølge Cattaneo et al.)
rdplotdensity(rdd_result, 
              X = final_dataset$centered_lagged_pervote_samlet,
              type = "both",
              CItype = "region",
              title = "Density Manipulation Test around Threshold",
              xlabel = "Centered Vote Share",
              ylabel = "Density",
              lcol = c("blue", "red"),
              legendTitle = "Density Estimates",
              legendGroups = c("Below threshold", "Above threshold"))

DCdensity(final_dataset$centered_lagged_pervote_samlet, c = 0, ext.out = TRUE)



# 3.3 Relationship between vote share and seat allocation --------------
seat_allocation_plot <- ggplot(final_dataset, aes(x = centered_lagged_pervote_samlet, y = lagged_i_parlament)) +
  geom_jitter(aes(color = factor(lagged_i_parlament)), width = 0, height = 0.05, alpha = 0.5) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  labs(
    title = "Green Party Parliamentary Representation by Vote Share",
    x = "Vote Share (Centered at Threshold)",
    y = "In Parliament"
  ) +
  scale_color_manual(values = c("0" = "darkblue", "1" = "darkred"), 
                     name = "Parliamentary\nStatus",
                     labels = c("Not in Parliament", "In Parliament")) +
  theme_minimal()

# 3.4 Balance check for covariates around threshold --------------
# Create functions for balance check
balance_check_plot <- function(data, var_name, running_var, cutpoint = 0, bandwidth = 2) {
  # Convert running_var from character to actual variable
  running_var_value <- data[[running_var]]
  
  # Create subset without using dplyr filter to avoid grouping issues
  data_subset <- data[abs(running_var_value) <= bandwidth, ]
  
  formula_str <- as.formula(paste0(var_name, " ~ ", running_var, " * I(", 
                                  running_var, " >= ", cutpoint, ")"))
  
  model <- lm(formula_str, data = data_subset)
  model_summary <- summary(model)
  
  # Make sure to handle potential issues with the interaction term
  interaction_pval <- tryCatch({
    coef(model_summary)[4, 4]
  }, error = function(e) {
    NA
  })
  
  ggplot(data, aes_string(x = running_var, y = var_name)) +
    geom_point(alpha = 0.3) +
    geom_smooth(data = subset(data, data[[running_var]] < cutpoint), 
                method = "lm", formula = y ~ x, color = "blue") +
    geom_smooth(data = subset(data, data[[running_var]] >= cutpoint), 
                method = "lm", formula = y ~ x, color = "red") +
    geom_vline(xintercept = cutpoint, linetype = "dashed") +
    labs(
      title = paste("Balance Check:", var_name),
      subtitle = paste("Interaction p-value:", round(interaction_pval, 4)),
      x = "Running Variable",
      y = var_name
    ) +
    theme_minimal()
}

# Run balance checks for key variables
rile_balance <- balance_check_plot(final_dataset, "rile_lowe", "centered_lagged_pervote_samlet")
gdp_balance <- balance_check_plot(final_dataset, "GDP_per_capita_lag1", "centered_lagged_pervote_samlet")
unemp_balance <- balance_check_plot(final_dataset, "Unemployment", "centered_lagged_pervote_samlet")
#gdp_growth_balance <- balance_check_plot(final_dataset, `GDP_per_capita_lag1`, "centered_lagged_pervote_samlet")


# 3.5 Green party representation over time --------------
green_time_plot <- final_dataset %>%
  dplyr::group_by(Year) %>%
  summarise(
    prop_in_parl = mean(lagged_i_parlament, na.rm = TRUE),
    avg_vote_share = mean(lagged_pervote_samlet, na.rm = TRUE)
  ) %>%
  ggplot(aes(x = Year)) +
  geom_line(aes(y = prop_in_parl, color = "Proportion in Parliament"), size = 1) +
  geom_line(aes(y = avg_vote_share / 100, color = "Average Vote Share (scaled)"), size = 1) +
  scale_y_continuous(
    name = "Proportion in Parliament",
    sec.axis = sec_axis(~.*100, name = "Average Vote Share (%)")
  ) +
  scale_color_manual(values = c("Proportion in Parliament" = "darkred", 
                               "Average Vote Share (scaled)" = "darkblue")) +
  labs(
    title = "Green Party Representation Over Time",
    x = "Year",
    color = "Measure"
  ) +
  theme_minimal()


# 4. Moderating Variables Analysis --------------

# 4.1 Radical right presence over time --------------
rrp_time_plot <- final_dataset %>%
  dplyr::group_by(Year) %>%
  summarise(
    prop_rrp = mean(rrp_i_p_lag1, na.rm = TRUE)
  ) %>%
  ggplot(aes(x = Year, y = prop_rrp)) +
  geom_line(size = 1, color = "darkred") +
  geom_point(size = 2, color = "darkred") +
  labs(
    title = "Radical Right Party Presence Over Time",
    x = "Year",
    y = "Proportion of Observations with RRP in Parliament"
  ) +
  theme_minimal()

# 4.2 Economic conditions visualization --------------
# Opret de tre individuelle plots
# Plot for GDP growth
p1 <- final_dataset %>%
  dplyr::group_by(Year) %>%
  summarise(GDP_per_capita_lag1 = mean(`GDP_per_capita_lag1`, na.rm = TRUE)) %>%
  ggplot(aes(x = Year, y = GDP_per_capita_lag1)) +
  geom_line(size = 1, color = "red") +
  geom_point(size = 2, color = "red") +
  labs(title = "GDP Growth", y = "Value") +
  theme_minimal()

# Plot for inflation (med logaritmisk skala)
p2 <- final_dataset %>%
  dplyr::group_by(Year) %>%
  summarise(inflation = mean(`Inflation-consumer prices`, na.rm = TRUE)) %>%
  ggplot(aes(x = Year, y = inflation)) +
  geom_line(size = 1, color = "green") +
  geom_point(size = 2, color = "green") +
  scale_y_log10() +
  labs(title = "Inflation (log scale)", y = "Value") +
  theme_minimal()

# Plot for unemployment
p3 <- final_dataset %>%
  dplyr::group_by(Year) %>%
  summarise(unemployment = mean(Unemployment, na.rm = TRUE)) %>%
  ggplot(aes(x = Year, y = unemployment)) +
  geom_line(size = 1, color = "blue") +
  geom_point(size = 2, color = "blue") +
  labs(title = "Unemployment", y = "Value") +
  theme_minimal()

# Kombiner plots i én række (ligesom i dit eksempel)
econ_indicators_plot <- p1 + p2 + p3 +
  plot_layout(ncol = 3) +
  plot_annotation(
    title = "Economic Indicators Over Time",
    subtitle = "GDP Growth, Inflation (logarithmic scale), and Unemployment",
    theme = theme(plot.title = element_text(size = 14, face = "bold"),
                 plot.subtitle = element_text(size = 10))
  )

# Vis samlet plot
print(econ_indicators_plot)

# Gem plottet hvis nødvendigt
# ggsave("economic_indicators.png", econ_indicators_plot, width = 12, height = 5, dpi = 300)

# 4.3 Left-right party distribution --------------
ideology_dist_plot <- ggplot(final_dataset, aes(x = rile_lowe)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "darkblue", alpha = 0.7) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Distribution of Party Ideology (Lowe's RILE Score)",
    x = "RILE Score (Negative = Left, Positive = Right)",
    y = "Count"
  ) +
  theme_minimal()

# 4.4 Party size distribution --------------
party_size_plot <- ggplot(final_dataset, aes(x = avg_pervote_main)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "darkblue", alpha = 0.7) +
  geom_vline(xintercept = median(final_dataset$avg_pervote_main, na.rm = TRUE), 
            linetype = "dashed", color = "red") +
  # Create a data frame for the label instead of using annotate
  geom_text(data = data.frame(
      x = median(final_dataset$avg_pervote_main, na.rm = TRUE) + 5,
      y = 50,
      label = "Median"
    ), 
    aes(x = x, y = y, label = label),
    color = "red"
  ) +
  labs(
    title = "Distribution of Party Size (Average Vote Share)",
    x = "Average Vote Share (%)",
    y = "Count"
  ) +
  theme_minimal()

# 4.5 Correlation matrix of moderating variables --------------
correlation_data <- final_dataset %>%
  dplyr::select(
    miljø_afhængig, rile_lowe, avg_pervote_main, 
    rrp_i_p_lag1, `GDP_per_capita_lag1`, 
    Unemployment, `Inflation-consumer prices`
  ) %>%
  na.omit()

correlation_plot_with_ggplot <- function() {
  # Beregn korrelationsmatricen
  correlation_matrix <- cor(correlation_data, use = "pairwise.complete.obs")
  
  # Get the number of variables
  num_vars <- ncol(correlation_matrix)
  
  # Create labels for the variables
  label_names <- c(
    "Climate Position", 
    "Left-Right Position", 
    "Avg. Party Vote Share", 
    "Radical Right in Parl.",
    "GDP Growth (Lag)", 
    "Unemployment Rate", 
    "Inflation Rate"
  )[1:num_vars]  # Only take as many as we need
  
  if(length(label_names) == num_vars) {
    # Assign labels to correlation matrix
    colnames(correlation_matrix) <- label_names
    rownames(correlation_matrix) <- label_names
    
    # Reshape correlation matrix for ggplot
    melted_cormat <- reshape2::melt(correlation_matrix)
    
    # VIGTIGT: Fjern alle rækker hvor Var1 eller Var2 indeholder NA
    melted_cormat <- melted_cormat[!is.na(melted_cormat$Var1) & !is.na(melted_cormat$Var2), ]
    
    # Fjern også rækker hvor Var1 eller Var2 er "NA" som string
    melted_cormat <- melted_cormat[!(melted_cormat$Var1 == "NA" | melted_cormat$Var2 == "NA"), ]
    
    # Create the correlation plot with ggplot
    corr_plot <- ggplot(data = melted_cormat, aes(x = Var1, y = Var2, fill = value)) +
      geom_tile() +
      scale_fill_gradient2(low = "#00F0FF", high = "#FF0F00", mid = "white", 
                          midpoint = 0, limit = c(-1,1), space = "Lab", 
                          name="Correlation") +
      theme_minimal() + 
      theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
            plot.title = element_text(hjust = 0.5)) +
      coord_fixed() +
      labs(title = "Correlation Matrix of Key Variables") +
      scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 10)) +
      scale_y_discrete(labels = function(y) stringr::str_wrap(y, width = 10))
    
    return(corr_plot)
  } else {
    print("Label count doesn't match variable count - cannot proceed")
    return(NULL)
  }
}

# Gem korrelationsplottet i en variabel
correlation_plot <- correlation_plot_with_ggplot()


# 5. Preliminary Relationship Exploration --------------

# 5.1 Bivariate relationship plot --------------
bivariate_plot <- ggplot(final_dataset, aes(x = centered_lagged_pervote_samlet, y = miljø_afhængig)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "loess") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Relationship Between Green Party Vote Share and Climate Position",
    x = "Green Party Vote Share (Centered)",
    y = "Climate Position"
  ) +
  theme_minimal()

# 5.2 Conditional means plot --------------
# Funktion til at lave conditional means plot med bin-data og forskellig polynomiegrad
create_conditional_means_plot <- function(data, poly_degree, bin_width = 0.5, x_limit = 10) {
  # Opret bins for data
  data$bin <- cut(data$centered_lagged_pervote_samlet, 
                 breaks = seq(-5, x_limit, by = bin_width),
                 include.lowest = TRUE)
  
  # Beregn gennemsnit for hver bin
  bin_means <- data %>%
    dplyr::group_by(bin, factor_lagged_i_parlament) %>%
    dplyr::summarise(
      mean_miljø = mean(miljø_afhængig, na.rm = TRUE),
      se_miljø = sd(miljø_afhængig, na.rm = TRUE) / sqrt(n()),
      median_bin = median(as.numeric(centered_lagged_pervote_samlet), na.rm = TRUE),
      n = n(),
      .groups = "drop"
    )
  
  # Plot binned means med polynomial fit
  ggplot() +
    # Tilføj punkter for hver bin
    geom_point(data = bin_means, 
              aes(x = median_bin, y = mean_miljø, color = factor_lagged_i_parlament, size = n),
              alpha = 0.7) +
    # Tilføj fejllinjer
    geom_errorbar(data = bin_means,
                 aes(x = median_bin, 
                     ymin = mean_miljø - se_miljø, 
                     ymax = mean_miljø + se_miljø,
                     color = factor_lagged_i_parlament),
                 width = 0.1, alpha = 0.5) +
    # Tilføj polynomial fit til venstre for tærsklen
    geom_smooth(data = subset(bin_means, median_bin < 0),
               aes(x = median_bin, y = mean_miljø),
               method = "lm", formula = paste0("y ~ poly(x, ", poly_degree, ", raw = TRUE)"),
               color = "blue", se = TRUE) +
    # Tilføj polynomial fit til højre for tærsklen
    geom_smooth(data = subset(bin_means, median_bin >= 0),
               aes(x = median_bin, y = mean_miljø),
               method = "lm", formula = paste0("y ~ poly(x, ", poly_degree, ", raw = TRUE)"),
               color = "red", se = TRUE) +
    # Tilføj vertikal linje ved tærsklen
    geom_vline(xintercept = 0, linetype = "dashed") +
    # Juster akser og titler
    coord_cartesian(xlim = c(-5, x_limit)) +
    scale_size_continuous(name = "Antal obs.", range = c(1, 5)) +
    labs(
      title = paste0("Conditional Means Plot (Polynomial Degree ", poly_degree, ")"),
      x = "Green Party Vote Share (Centered)",
      y = "Average Climate Position",
      color = "Parliamentary Status"
    ) +
    theme_minimal()
}

# Opret plots med forskellige polynomiegrader
cm1 <- create_conditional_means_plot(final_dataset, poly_degree = 1)
cm2 <- create_conditional_means_plot(final_dataset, poly_degree = 2)
cm3 <- create_conditional_means_plot(final_dataset, poly_degree = 3)
cm4 <- create_conditional_means_plot(final_dataset, poly_degree = 4)

# Kombiner plots i et 2x2 grid
conditional_means_comparison <- (cm1 + cm2) / (cm3 + cm4) + 
  plot_annotation(
    title = "Conditional Means Visualization: Comparison of Different Polynomial Specifications",
    subtitle = "Effect of Green Party Parliamentary Entry on Climate Position",
    theme = theme(plot.title = element_text(size = 14, face = "bold"),
                 plot.subtitle = element_text(size = 10))
  )

# Vis samlet plot
print(conditional_means_comparison)

# Gem plottet til en fil
ggsave("conditional_means_comparison.png", conditional_means_comparison, width = 12, height = 9, dpi = 300)

# 5.3 Enhanced RDD visualization --------------
# Funktion til at oprette RDD plot med specifik polynomiegrad
create_poly_rdd_plot <- function(data, poly_degree, x_limit = 10) {
  # Beregn y-position for annotationer
  max_y_value <- max(data$miljø_afhængig, na.rm = TRUE)
  annotation_y_position <- max_y_value * 0.9
  
  # Opret plottet
  ggplot(data, aes(x = centered_lagged_pervote_samlet, y = miljø_afhængig)) +
    # Begræns x-aksen til det specificerede interval
    coord_cartesian(xlim = c(-6, x_limit)) +
    # Tilføj punkter
    geom_point(aes(color = factor_lagged_i_parlament), alpha = 0.3, size = 1) +
    # Kurve for data til venstre for tærsklen
    geom_smooth(data = subset(data, centered_lagged_pervote_samlet < 0 & centered_lagged_pervote_samlet > -5),
               method = "lm", 
               formula = paste0("y ~ poly(x, ", poly_degree, ", raw = TRUE)"), 
               color = "blue", se = TRUE) +
    # Kurve for data til højre for tærsklen
    geom_smooth(data = subset(data, centered_lagged_pervote_samlet >= 0 & centered_lagged_pervote_samlet < x_limit),
               method = "lm", 
               formula = paste0("y ~ poly(x, ", poly_degree, ", raw = TRUE)"), 
               color = "red", se = TRUE) +
    # Tilføj vertikal linje ved tærsklen
    geom_vline(xintercept = 0, linetype = "dashed") +
    # Brug geom_text i stedet for annotate for at undgå fejl
    geom_text(aes(x = -3.5, y = annotation_y_position, label = "Green Party Below Threshold"), 
              color = "darkblue", size = 3, inherit.aes = FALSE) +
    geom_text(aes(x = 5, y = annotation_y_position, label = "Green Party Above Threshold"), 
              color = "darkred", size = 3, inherit.aes = FALSE) +
    # Titler og aksenavne
    labs(
      title = paste0("Polynomial Degree ", poly_degree),
      x = "Green Party Vote Share (Centered)",
      y = "Climate Position"
    ) +
    # Fjern farvenøglen da vi har tekstforklaringer
    theme_minimal() +
    theme(legend.position = "none")
}

# Kode til at køre i R med dit faktiske datasæt:
# Antagelse: final_dataset er dit datasæt med de nødvendige kolonner

# Opret individuelle plots med forskellige polynomiegrader
p1 <- create_poly_rdd_plot(final_dataset, poly_degree = 1)  # Lineær
p2 <- create_poly_rdd_plot(final_dataset, poly_degree = 2)  # Kvadratisk
p3 <- create_poly_rdd_plot(final_dataset, poly_degree = 3)  # Kubisk
p4 <- create_poly_rdd_plot(final_dataset, poly_degree = 4)  # Kvartisk

# Kombiner plots i et 2x2 grid
polynomial_comparison <- (p1 + p2) / (p3 + p4) + 
  plot_annotation(
    title = "RDD Visualization: Comparison of Different Polynomial Specifications",
    subtitle = "Effect of Green Party Parliamentary Entry on Climate Position",
    theme = theme(plot.title = element_text(size = 14, face = "bold"),
                 plot.subtitle = element_text(size = 10))
  )

# Vis samlet plot
print(polynomial_comparison)

# Gem plottet til en fil med høj opløsning
ggsave("rdd_polynomial_comparison.png", polynomial_comparison, width = 10, height = 8, dpi = 300)

# Kode til at eksperimentere med forskellige båndbredder
# Dette vil vise, hvordan estimaterne varierer med forskellige båndbredder
create_bandwidth_plot <- function(data, poly_degree = 1, bandwidth) {
  # Filtrér data baseret på båndbredde
  filtered_data <- data[abs(data$centered_lagged_pervote_samlet) <= bandwidth, ]
  
  # Opret plottet
  ggplot(filtered_data, aes(x = centered_lagged_pervote_samlet, y = miljø_afhængig)) +
    geom_point(aes(color = factor_lagged_i_parlament), alpha = 0.3, size = 1) +
    geom_smooth(data = subset(filtered_data, centered_lagged_pervote_samlet < 0),
               method = "lm", 
               formula = paste0("y ~ poly(x, ", poly_degree, ", raw = TRUE)"), 
               color = "blue", se = TRUE) +
    geom_smooth(data = subset(filtered_data, centered_lagged_pervote_samlet >= 0),
               method = "lm", 
               formula = paste0("y ~ poly(x, ", poly_degree, ", raw = TRUE)"), 
               color = "red", se = TRUE) +
    geom_vline(xintercept = 0, linetype = "dashed") +
    labs(
      title = paste0("Bandwidth = ±", bandwidth, ", Polynomial Degree ", poly_degree),
      x = "Green Party Vote Share (Centered)",
      y = "Climate Position"
    ) +
    theme_minimal() +
    theme(legend.position = "none")
}

# Opret plots med forskellige båndbredder (for lineær model)
b1 <- create_bandwidth_plot(final_dataset, poly_degree = 1, bandwidth = 1)
b2 <- create_bandwidth_plot(final_dataset, poly_degree = 1, bandwidth = 2)
b3 <- create_bandwidth_plot(final_dataset, poly_degree = 1, bandwidth = 3)
b4 <- create_bandwidth_plot(final_dataset, poly_degree = 1, bandwidth = 5)

# Kombiner båndbredde-plots
bandwidth_comparison <- (b1 + b2) / (b3 + b4) + 
  plot_annotation(
    title = "RDD Visualization: Comparison of Different Bandwidths",
    subtitle = "Effect of Green Party Parliamentary Entry on Climate Position (Linear Model)",
    theme = theme(plot.title = element_text(size = 14, face = "bold"),
                 plot.subtitle = element_text(size = 10))
  )

# Vis båndbredde-sammenligningsplot
print(bandwidth_comparison)

# Gem båndbredde-plottet
ggsave("rdd_bandwidth_comparison.png", bandwidth_comparison, width = 10, height = 8, dpi = 300)

# 5.4 Faceted RDD plots by moderating variables --------------
# By RRP presence
rrp_facet_plot <- ggplot(
  final_dataset %>% filter(!is.na(rrp_i_p_lag1)),
  aes(x = centered_lagged_pervote_samlet, y = miljø_afhængig)) +
  geom_point(alpha = 0.3) +
  geom_smooth(data = subset(final_dataset %>% filter(!is.na(rrp_i_p_lag1)), centered_lagged_pervote_samlet < 0),
             method = "lm", formula = y ~ poly(x, 2, raw = TRUE), 
             color = "blue") +
  geom_smooth(data = subset(final_dataset %>% filter(!is.na(rrp_i_p_lag1)), centered_lagged_pervote_samlet >= 0),
             method = "lm", formula = y ~ poly(x, 2, raw = TRUE), 
             color = "red") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  facet_wrap(~ factor(rrp_i_p_lag1, labels = c("No RRP in Parliament", "RRP in Parliament"))) +
  labs(
    title = "Effect of Green Party Entry by Radical Right Presence",
    x = "Green Party Vote Share (Centered)",
    y = "Climate Position"
  ) +
  theme_minimal()

# By GDP Per Capita conditions
# Filtrer NA-værdierne ud og lav kun plot for good/poor economy
gdp_facet_plot <- ggplot(
  # Filtrer NA-værdier fra factor_high_gdp_growth_lag1
  final_dataset %>% filter(!is.na(factor_high_gdp_growth_lag1)), 
  aes(x = centered_lagged_pervote_samlet, y = miljø_afhængig)) +
  geom_point(alpha = 0.3) +
  # Opdater subsetting til også at filtrere NA væk
  geom_smooth(data = subset(final_dataset, 
                          !is.na(factor_high_gdp_growth_lag1) & centered_lagged_pervote_samlet < 0),
             method = "lm", formula = y ~ poly(x, 2, raw = TRUE), 
             color = "blue") +
  geom_smooth(data = subset(final_dataset, 
                          !is.na(factor_high_gdp_growth_lag1) & centered_lagged_pervote_samlet >= 0),
             method = "lm", formula = y ~ poly(x, 2, raw = TRUE), 
             color = "red") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  facet_wrap(~ factor_high_gdp_growth_lag1) +
  labs(
    title = "Effect of Green Party Entry by GDP Per Capita Conditions",
    x = "Green Party Vote Share (Centered)",
    y = "Climate Position"
  ) +
  theme_minimal()

print(gdp_facet_plot)

# By economic conditions
# Filtrer NA-værdierne ud og lav kun plot for good/poor economy
economy_facet_plot <- ggplot(
  # Filtrer NA-værdier fra factor_good_economy_lag1
  final_dataset %>% filter(!is.na(factor_good_economy_lag1)), 
  aes(x = centered_lagged_pervote_samlet, y = miljø_afhængig)) +
  geom_point(alpha = 0.3) +
  # Opdater subsetting til også at filtrere NA væk
  geom_smooth(data = subset(final_dataset, 
                          !is.na(factor_good_economy_lag1) & centered_lagged_pervote_samlet < 0),
             method = "lm", formula = y ~ poly(x, 2, raw = TRUE), 
             color = "blue") +
  geom_smooth(data = subset(final_dataset, 
                          !is.na(factor_good_economy_lag1) & centered_lagged_pervote_samlet >= 0),
             method = "lm", formula = y ~ poly(x, 2, raw = TRUE), 
             color = "red") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  facet_wrap(~ factor_good_economy_lag1) +
  labs(
    title = "Effect of Green Party Entry by Economic Conditions",
    x = "Green Party Vote Share (Centered)",
    y = "Climate Position"
  ) +
  theme_minimal()

# Vis plottet
print(economy_facet_plot)

# By party ideology
ideology_facet_plot <- ggplot(
  final_dataset %>% filter(!is.na(left_party_lag1)), 
  aes(x = centered_lagged_pervote_samlet, y = miljø_afhængig)) +
  geom_point(alpha = 0.3) +
  geom_smooth(data = function(d) subset(d, centered_lagged_pervote_samlet < 0),
             method = "lm", formula = y ~ poly(x, 2, raw = TRUE), 
             color = "blue") +
  geom_smooth(data = function(d) subset(d, centered_lagged_pervote_samlet >= 0),
             method = "lm", formula = y ~ poly(x, 2, raw = TRUE), 
             color = "red") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  facet_wrap(~ factor(left_party_lag1, labels = c("Right-wing Parties", "Left-wing Parties"))) +
  labs(
    title = "Effect of Green Party Entry by Party Ideology",
    x = "Green Party Vote Share (Centered)",
    y = "Climate Position"
  ) +
  theme_minimal()

# By party size
size_facet_plot <- ggplot(
  final_dataset %>% filter(!is.na(large_party_lag1)),
  aes(x = centered_lagged_pervote_samlet, y = miljø_afhængig)) +
  geom_point(alpha = 0.3) +
  geom_smooth(data = subset(final_dataset %>% filter(!is.na(large_party_lag1)), centered_lagged_pervote_samlet < 0),
             method = "lm", formula = y ~ poly(x, 2, raw = TRUE), 
             color = "blue") +
  geom_smooth(data = subset(final_dataset %>% filter(!is.na(large_party_lag1)), centered_lagged_pervote_samlet >= 0),
             method = "lm", formula = y ~ poly(x, 2, raw = TRUE), 
             color = "red") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  facet_wrap(~ factor(large_party_lag1, labels = c("Small Parties", "Large Parties"))) +
  labs(
    title = "Effect of Green Party Entry by Party Size",
    x = "Green Party Vote Share (Centered)",
    y = "Climate Position"
  ) +
  theme_minimal()

# 5.5 Placebo outcomes check --------------
# Identify placebo outcomes (variables that shouldn't be affected by threshold crossing)
placebo_vars <- c("rile_lowe", "parfam")

# Example for one placebo outcome
placebo_plot <- ggplot(final_dataset, aes(x = centered_lagged_pervote_samlet, y = rile_lowe)) +
  geom_point(alpha = 0.3) +
  geom_smooth(data = subset(final_dataset, centered_lagged_pervote_samlet < 0),
             method = "lm", formula = y ~ poly(x, 2, raw = TRUE), 
             color = "blue") +
  geom_smooth(data = subset(final_dataset, centered_lagged_pervote_samlet >= 0),
             method = "lm", formula = y ~ poly(x, 2, raw = TRUE), 
             color = "red") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  labs(
    title = "Placebo Outcome Check: Party Ideology (RILE)",
    x = "Green Party Vote Share (Centered)",
    y = "Party Ideology (RILE Score)"
  ) +
  theme_minimal()


# 6. Additional Analyses --------------

# 6.1 Missing data analysis --------------
# Definer de specifikke variable du er interesseret i
key_variables <- c("miljø_afhængig", "centered_lagged_pervote_samlet", "rrp_i_p_lag1", 
                  "high_gdp_growth_lag1", "Unemployment", "large_party_lag1", 
                  "left_party_lag1", "Inflation-consumer prices", "GDP_per_capita_lag1", "rile_lowe")

# Opret et mapping for mere læsbare variabelnavne
variable_labels <- c(
  "miljø_afhængig" = "Klima Position",
  "centered_lagged_pervote_samlet" = "Grønt Partis Stemmeandel (centreret)",
  "rrp_i_p_lag1" = "Højreradikalt Parti i Parlament",
  "high_gdp_growth_lag1" = "Høj BNP-vækst",
  "Unemployment" = "Arbejdsløshed",
  "large_party_lag1" = "Stort Parti",
  "left_party_lag1" = "Venstreorienteret Parti",
  "Inflation-consumer prices" = "Inflation",
  "GDP_per_capita_lag1" = "BNP per indbygger vækst",
  "rile_lowe" = "Ideologisk Position (RILE)"
)

# Tjek om variable findes i datasættet
existing_vars <- key_variables[key_variables %in% names(final_dataset)]
if(length(existing_vars) < length(key_variables)) {
  missing_vars <- key_variables[!key_variables %in% names(final_dataset)]
  cat("Advarsel: Følgende variable findes ikke i datasættet:", 
      paste(missing_vars, collapse=", "), "\n")
}

# Undersøg missing values i de udvalgte variable
missing_counts <- sapply(final_dataset[, existing_vars], function(x) sum(is.na(x)))
missing_percentages <- round(missing_counts / nrow(final_dataset) * 100, 2)

# Lav en dataframe med resultaterne
missing_summary <- data.frame(
  Variabel = names(missing_counts),
  Pænt_Navn = variable_labels[names(missing_counts)],
  Antal_Missing = missing_counts,
  Procent_Missing = missing_percentages
)

# Håndter eventuelle NA-værdier i Pænt_Navn
missing_summary$Pænt_Navn[is.na(missing_summary$Pænt_Navn)] <- missing_summary$Variabel[is.na(missing_summary$Pænt_Navn)]

# Sorter efter procent missing
missing_summary <- missing_summary[order(-missing_summary$Procent_Missing), ]

# Gem som CSV-fil
write.csv(missing_summary, "Figurer-EDA/key_variables_missing_summary.csv", row.names = FALSE)

# Bar plot med forbedret layout
bar_plot_missing <- ggplot(missing_summary, aes(x = reorder(Pænt_Navn, -Procent_Missing), y = Procent_Missing)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  theme_minimal() +
  labs(
    title = "Manglende værdier i nøglevariable",
    x = "",
    y = "Procent manglende værdier (%)"
  ) +
  theme(
    axis.text.y = element_text(size = 11),
    axis.text.x = element_text(size = 10),
    panel.grid.major.y = element_blank(),
    plot.title = element_text(size = 14, face = "bold"),
    plot.margin = margin(15, 15, 15, 15)
  )

# Gem bar plot
ggsave("Figurer-EDA/key_variables_missing_barplot.png", bar_plot_missing, width = 12, height = 7, dpi = 300)

# Missing data pattern med forbedret layout
# Brug alle observationer for disse få variable
missing_matrix <- is.na(final_dataset[, existing_vars])

# Giv kolonner de pæne navne
colnames(missing_matrix) <- variable_labels[colnames(missing_matrix)]
# Håndter eventuelle NA-værdier i kolonnenavne
colnames(missing_matrix)[is.na(colnames(missing_matrix))] <- existing_vars[is.na(colnames(missing_matrix))]

# Brug et større, men mindre tæt sample for bedre visning
sample_size <- min(300, nrow(final_dataset))
sample_rows <- sample(1:nrow(final_dataset), sample_size)
sample_data <- final_dataset[sample_rows, existing_vars]

# Konverter til long format for ggplot
missing_long <- melt(missing_matrix)
names(missing_long) <- c("Observation", "Variabel", "Er_Missing")

# Vigtig ændring: Omorganiser observation-nummereringen for at undgå huller
# Dette vil placere observationerne tæt på hinanden i plottet
missing_long$Observation <- factor(missing_long$Observation, levels = unique(missing_long$Observation))
missing_long$Observation <- as.numeric(as.factor(missing_long$Observation))

# Forbedret visualisering uden x-akse tal
heatmap_plot_missing <- ggplot(missing_long, 
                      aes(x = Observation, y = Variabel, fill = Er_Missing)) +
  geom_tile(color = "white", size = 0.1) +
  scale_fill_manual(values = c("lightblue", "red"), 
                   labels = c("Har værdi", "Mangler"),
                   name = "Status") +
  # Fjern x-akse tal helt
  scale_x_continuous(breaks = NULL) +
  theme_minimal() +
  theme(
    axis.text.x = element_blank(),  # Fjern x-akse tekst
    axis.ticks.x = element_blank(),  # Fjern x-akse streger
    axis.text.y = element_text(size = 8),
    panel.grid = element_blank(),
    legend.position = "bottom"
  ) +
  labs(
    title = "Missing Data Pattern for Nøglevariable",
    subtitle = paste0("Baseret på stikprøve af ", sample_size, " observationer ud af ", 
                    nrow(final_dataset), " i alt (", 
                    round(sample_size/nrow(final_dataset)*100), "%)"),
    x = "Observationer (stikprøve)",
    y = ""
  )

# Gem heatmap med bedre dimensioner
ggsave("Figurer-EDA/key_variables_heatmap.png", heatmap_plot_missing, width = 14, height = 8, dpi = 300)

# Co-occurrence med forbedrede variabelnavne
co_occurrence <- t(missing_matrix) %*% missing_matrix / nrow(missing_matrix)

# Konverter til dataframe for ggplot
melted_co_occurrence <- melt(co_occurrence)
names(melted_co_occurrence) <- c("Var1", "Var2", "Co_occurrence")

# Plot co-occurrence heatmap med forbedret layout
co_occurrence_plot <- ggplot(melted_co_occurrence, aes(x = Var1, y = Var2, fill = Co_occurrence)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "red") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
    axis.text.y = element_text(size = 10),
    plot.title = element_text(size = 14, face = "bold"),
    plot.margin = margin(15, 15, 15, 15)
  ) +
  labs(
    title = "Co-occurrence af Missing Værdier i Nøglevariable",
    subtitle = "Viser hvor ofte par af variable mangler værdier sammen",
    x = "",
    y = "",
    fill = "Co-occurrence"
  )

# Gem co-occurrence plot med bedre dimensioner
ggsave("Figurer-EDA/key_variables_co_occurrence.png", co_occurrence_plot, width = 11, height = 9, dpi = 300)

# Vis output
cat("Missing værdier i nøglevariable:\n")
print(missing_summary[, c("Pænt_Navn", "Antal_Missing", "Procent_Missing")])
cat("\nAnalyseresultater med forbedrede visualiseringer er gemt i Figurer-EDA mappen.\n")

# 6.2 Zero inflation analysis by party characteristics --------------
zero_inflation_analysis <- final_dataset %>%
  dplyr::mutate(has_zero = miljø_afhængig == 0) %>%
  dplyr::group_by(parfam) %>%
  summarise(
    total = n(),
    n_zero = sum(has_zero, na.rm = TRUE),
    prop_zero = n_zero / total
  ) %>%
  arrange(desc(prop_zero))

zero_by_parfam_plot <- ggplot(zero_inflation_analysis, 
                             aes(x = reorder(parfam, prop_zero), y = prop_zero)) +
  geom_bar(stat = "identity", fill = "darkred") +
  coord_flip() +
  labs(
    title = "Proportion of Zero Climate Position Values by Party Family",
    x = "Party Family",
    y = "Proportion of Zero Values"
  ) +
  theme_minimal()

# 6.3 Temporal evolution of climate position by party family --------------
party_family_time <- final_dataset %>%
  dplyr::mutate(
    party_family = case_when(
      parfam == "10" ~ "Green",
      parfam == "20" ~ "Communist/Socialist",
      parfam == "30" ~ "Social Democratic",
      parfam == "40" ~ "Liberal",
      parfam == "50" ~ "Christian Democratic",
      parfam == "60" ~ "Conservative",
      parfam == "70" ~ "Nationalist",
      parfam == "80" ~ "Agrarian",
      parfam == "90" ~ "Ethnic/Regional",
      parfam == "95" ~ "Special issue parties",
      parfam == "98" ~ "Electoral alliance w/o leader",
      TRUE ~ "Other"
    )
  ) %>%
  dplyr::filter(!is.na(party_family)) %>%
  dplyr::group_by(Year, party_family) %>%
  summarise(
    mean_climate = mean(miljø_afhængig, na.rm = TRUE),
    .groups = "drop"
  )

family_time_plot <- ggplot(party_family_time, aes(x = Year, y = mean_climate, color = party_family)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  labs(
    title = "Climate Position Over Time by Party Family",
    x = "Year",
    y = "Mean Climate Position",
    color = "Party Family"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

# 6.4 Climate position by country with time trends --------------
country_time_trends <- final_dataset %>%
  dplyr::group_by(countryname, Year) %>%
  summarise(
    mean_climate = mean(miljø_afhængig, na.rm = TRUE),
    .groups = "drop"
  )

country_trends_plot <- ggplot(country_time_trends, aes(x = Year, y = mean_climate, color = countryname)) +
  geom_line() +
  geom_point(size = 1) +
  labs(
    title = "Climate Position Time Trends by Country",
    x = "Year",
    y = "Mean Climate Position",
    color = "Country"
  ) +
  theme_minimal() +
  theme(legend.position = "right") +
  guides(color = guide_legend(ncol = 2))

# 6.5 Event marker timeline --------------
# Create a dataframe of major climate events
climate_events <- data.frame(
  year = c(1992, 1997, 2005, 2009, 2015, 2016),
  event = c("Rio Earth Summit", "Kyoto Protocol", "Kyoto Protocol Enforcement", 
           "Copenhagen Accord", "Paris Agreement", "Paris Agreement Enforcement")
)

# Forbedret version af climate_events_plot med bedre placering af event labels
climate_events_plot <- climate_time_plot +
  # Tilføj lodrette linjer for klimabegivenheder
  geom_vline(data = climate_events, aes(xintercept = year), 
            linetype = "dotted", color = "darkgreen") +
  # Tilføj labels med forbedret rotation og placering
  geom_text(data = climate_events, 
           aes(x = year, 
               y = 3.3,  # Placer teksten højere oppe for at give mere plads
               label = event), 
           angle = 90,  # Lodret rotation af teksten
           hjust = 1,   # Justér tekstens placering (1 = bunden af teksten er på y-koordinaten)
           size = 3,    # Mindre tekststørrelse
           color = "darkgreen") +
  # Udvid y-aksens grænse for at give plads til labels
  ylim(-1.5, 3.5) +  # Øg den øvre grænse for at give plads til tekstlabels
  # Forbedret tema med mere plads i top og bund
  theme(
    plot.margin = margin(t = 50, r = 10, b = 10, l = 10, unit = "pt"),
    axis.text.x = element_text(angle = 0, hjust = 0.5)  # Vandret x-akse tekst
  )

# 6.6 Distribution of climate position by parliamentary status --------------
parl_status_dist <- ggplot(final_dataset, aes(x = miljø_afhængig, fill = factor_lagged_i_parlament)) +
  geom_density(alpha = 0.5) +
  labs(
    title = "Distribution of Climate Position by Green Party Parliamentary Status",
    x = "Climate Position",
    y = "Density",
    fill = "Green Party Status"
  ) +
  theme_minimal()

# 6.7 Climate position before and after green party entry --------------
before_after_analysis <- final_dataset %>%
  # Focus on observations around the threshold
  filter(abs(centered_lagged_pervote_samlet) <= 2) %>%
  mutate(threshold_status = ifelse(centered_lagged_pervote_samlet >= 0, "Above", "Below"))

before_after_plot <- ggplot(before_after_analysis, aes(x = threshold_status, y = miljø_afhængig, fill = threshold_status)) +
  geom_boxplot() +
  labs(
    title = "Climate Position Below vs. Above Threshold",
    x = "Threshold Status",
    y = "Climate Position",
    fill = "Threshold Status"
  ) +
  theme_minimal()

# 6.8 Climate position vs. economic indicators --------------
economy_scatter <- ggplot(final_dataset, aes(x = `GDP_per_capita_lag1`, y = miljø_afhængig)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "loess") +
  facet_wrap(~ factor_lagged_i_parlament) +
  labs(
    title = "Climate Position vs. GDP Growth by Parliamentary Status",
    x = "GDP_per_capita_lag1",
    y = "Climate Position"
  ) +
  theme_minimal()

# 6.9 Ridge plot of climate position by country --------------
ridge_plot <- ggplot(final_dataset, aes(x = miljø_afhængig, y = countryname, fill = countryname)) +
  geom_density_ridges(alpha = 0.6) +
  labs(
    title = "Distribution of Climate Position by Country",
    x = "Climate Position",
    y = "Country"
  ) +
  theme_minimal() +
  theme(legend.position = "none")


# 7. Saving Plots and Tables for EDA Section --------------

# Create a list of plots for the EDA section
eda_plots <- list(
  # Section 1: Descriptive Statistics
  country_coverage_plot = country_coverage_plot,
  time_coverage_plot = time_coverage_plot,
  
  # Section 2: Outcome Variable Analysis --------------
  climate_dist_plot = climate_dist_plot,
  climate_country_plot = climate_country_plot,
  climate_time_plot = climate_time_plot,
  components_plot = components_plot,
  zero_plot = zero_plot,
  family_climate_plot = family_climate_plot,
  
  # Section 3: Running Variable and Treatment Analysis --------------
  rv_dist_plot = rv_dist_plot,
  rdplotdensity = rdplotdensity,
  seat_allocation_plot = seat_allocation_plot,
  rile_balance = rile_balance,
  gdp_balance = gdp_balance,
  unemp_balance = unemp_balance,
  green_time_plot = green_time_plot,
  
  # Section 4: Moderating Variables Analysis --------------
  rrp_time_plot = rrp_time_plot,
  econ_indicators_plot = econ_indicators_plot,
  ideology_dist_plot = ideology_dist_plot,
  party_size_plot = party_size_plot,
  correlation_plot = correlation_plot,
  
  # Section 5: Preliminary Relationship Exploration --------------
  bivariate_plot = bivariate_plot,
  conditional_means_comparison = conditional_means_comparison,
  polynomial_comparison = polynomial_comparison,
  bandwidth_comparison = bandwidth_comparison,
  rrp_facet_plot = rrp_facet_plot,
  gdp_facet_plot = gdp_facet_plot,
  economy_facet_plot = economy_facet_plot,
  ideology_facet_plot = ideology_facet_plot,
  size_facet_plot = size_facet_plot,
  placebo_plot = placebo_plot,
  
  # Section 6: Additional Analyses --------------
  bar_plot_missing = bar_plot_missing,
  heatmap_plot_missing = heatmap_plot_missing,
  zero_by_parfam_plot = zero_by_parfam_plot,
  family_time_plot = family_time_plot,
  country_trends_plot = country_trends_plot,
  climate_events_plot = climate_events_plot,
  parl_status_dist = parl_status_dist,
  before_after_plot = before_after_plot,
  economy_scatter = economy_scatter,
  ridge_plot = ridge_plot
)

# Create a list of tables for the EDA section
eda_tables <- list(
  summary_wide = summary_wide,
  country_summary = country_summary,
  threshold_summary = threshold_summary,
  green_success_time = green_success_time,
  green_success_country = green_success_country,
  zero_prop = zero_prop,
  bar_plot_missing = bar_plot_missing,
  heatmap_plot_missing = heatmap_plot_missing,
  zero_inflation_analysis = zero_inflation_analysis
)

# Create main directory structure for "Eksplorativ Analyse"
main_dir <- "Eksplorativ Analyse"
if (!dir.exists(main_dir)) {
  dir.create(main_dir, recursive = TRUE)
}

# Create section subdirectories
section_dirs <- c(
  "1_Deskriptiv_Statistik",
  "2_Outcome_Analyse",
  "3_Running_Variable_Analyse",
  "4_Modererende_Variable",
  "5_Preliminary_Relationsanalyse",
  "6_Yderligere_Analyser",
  "Samlet"
)

# Create all subdirectories
for (dir_name in section_dirs) {
  sub_dir <- file.path(main_dir, dir_name)
  if (!dir.exists(sub_dir)) {
    dir.create(sub_dir, recursive = TRUE)
  }
}

# Save plots to PDF in the "Samlet" subdirectory
pdf(file.path(main_dir, "Samlet", "eda_plots.pdf"), width = 12, height = 8)
for (i in seq_along(eda_plots)) {
  print(eda_plots[[i]])
}
dev.off()

# Save tables to CSV in the "Samlet" subdirectory, with better error handling
for (i in seq_along(eda_tables)) {
  # Print what we're trying to save for debugging
  cat("Attempting to save table:", names(eda_tables)[i], "\n")
  
  # Use tryCatch to handle any errors that might occur
  tryCatch({
    # First check if the object is already a data frame
    if (is.data.frame(eda_tables[[i]])) {
      write.csv(eda_tables[[i]], 
               file = file.path(main_dir, "Samlet", paste0("eda_table_", names(eda_tables)[i], ".csv")), 
               row.names = FALSE)
      cat("Successfully saved as data frame\n")
    } 
    # Special handling for correlation matrix
    else if (is.matrix(eda_tables[[i]])) {
      write.csv(as.data.frame(eda_tables[[i]]), 
               file = file.path(main_dir, "Samlet", paste0("eda_table_", names(eda_tables)[i], ".csv")), 
               row.names = TRUE)
      cat("Successfully saved as matrix\n")
    }
    # Try to handle simple lists that could be converted to data frames
    else if (is.list(eda_tables[[i]]) && !is.data.frame(eda_tables[[i]])) {
      # Use capture.output to prevent error messages from printing
      capture.output({
        # Check if the list has equal length elements (could be made into a data frame)
        if (length(unique(sapply(eda_tables[[i]], length))) == 1) {
          df <- as.data.frame(eda_tables[[i]], stringsAsFactors = FALSE)
          write.csv(df, 
                   file = file.path(main_dir, "Samlet", paste0("eda_table_", names(eda_tables)[i], ".csv")), 
                   row.names = FALSE)
          cat("Successfully converted list to data frame\n")
        } else {
          # For more complex lists, try to save as RDS instead
          saveRDS(eda_tables[[i]], 
                 file = file.path(main_dir, "Samlet", paste0("eda_table_", names(eda_tables)[i], ".rds")))
          cat("Saved as RDS file instead of CSV\n")
        }
      }, type = "message")
    }
    # For any other type, save as RDS
    else {
      saveRDS(eda_tables[[i]], 
             file = file.path(main_dir, "Samlet", paste0("eda_table_", names(eda_tables)[i], ".rds")))
      cat("Saved as RDS file (unknown type)\n")
    }
  }, error = function(e) {
    # If any error occurs, print message and continue to next table
    cat("ERROR saving table", names(eda_tables)[i], ":", e$message, "\n")
    # Try to save as RDS as a fallback
    tryCatch({
      saveRDS(eda_tables[[i]], 
             file = file.path(main_dir, "Samlet", paste0("eda_table_", names(eda_tables)[i], ".rds")))
      cat("Saved as RDS file after error\n")
    }, error = function(e2) {
      cat("Could not save in any format:", e2$message, "\n")
    })
  })
}


# 8. Create Individual Files for Each EDA Section --------------

# 8b Climate position by party family & Country --------------
final_dataset <- final_dataset %>%
  mutate(
    party_family = case_when(
      parfam == "10" ~ "Green",
      parfam == "20" ~ "Socialist/Other left parties",
      parfam == "30" ~ "Social Democratic",
      parfam == "40" ~ "Liberal",
      parfam == "50" ~ "Christian Democratic",
      parfam == "60" ~ "Conservative",
      parfam == "70" ~ "Nationalist",
      parfam == "80" ~ "Agrarian",
      parfam == "90" ~ "Ethnic/Regional",
      parfam == "95" ~ "Special issue parties",
      parfam == "98" ~ "Electoral alliance w/o leader",
      TRUE ~ "Other"
    )
  )

# Calculate average values for heatmap
heatmap_data <- final_dataset %>%
  dplyr::group_by(countryname, party_family) %>%
  summarise(
    avg_climate = mean(miljø_afhængig, na.rm = TRUE),
    count = n(),
    .groups = "drop"
  ) %>%
  # Filter to only include cells with sufficient data
  filter(count >= 3)  # Adjust minimum count as needed

climate_heatmap <- ggplot(heatmap_data, aes(x = party_family, y = countryname, fill = avg_climate)) +
  geom_tile() +
  scale_fill_gradient2(
    low = "red", 
    mid = "white", 
    high = "green", 
    midpoint = 0,
    name = "Avg. Climate\nPosition"
  ) +
  geom_text(aes(label = round(avg_climate, 1)), size = 3) +
  labs(
    title = "Average Climate Position by Party Family and Country",
    x = "Party Family",
    y = "Country"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major = element_blank()
  )

# Save the plot to the specified location
ggsave(
  "Eksplorativ Analyse/2_Outcome_Analyse/climate_country_family_heatmap.png", 
  plot = climate_heatmap, 
  width = 10, 
  height = 8, 
  dpi = 300
)

# Get the current working directory to restore later
old_dir <- getwd()

# Section 1: Descriptive Statistics --------------
section_dir <- file.path(main_dir, "1_Deskriptiv_Statistik")
pdf(file.path(section_dir, "eda_section1_descriptive.pdf"), width = 12, height = 8)
print(country_coverage_plot)
print(time_coverage_plot)
dev.off()

# Save individual plots
ggsave(file.path(section_dir, "country_coverage_plot.png"), country_coverage_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "time_coverage_plot.png"), time_coverage_plot, width = 10, height = 6, dpi = 300)

# Save relevant tables
write.csv(country_summary, file.path(section_dir, "country_summary.csv"), row.names = FALSE)
tryCatch({
  # Tjek om det er en liste
  if (is.list(summary_wide) && !is.data.frame(summary_wide)) {
    # Forsøg at konvertere til data.frame
    summary_df <- as.data.frame(summary_wide)
    write.csv(summary_df, file.path(section_dir, "summary_statistics.csv"), row.names = FALSE)
  } else {
    # Hvis det allerede er en data.frame
    write.csv(summary_wide, file.path(section_dir, "summary_statistics.csv"), row.names = FALSE)
  }
}, error = function(e) {
  # Hvis den ikke kan konverteres, gem som RDS i stedet
  cat("Kunne ikke gemme summary_wide som CSV:", e$message, "\n")
  cat("Gemmer som RDS i stedet\n")
  saveRDS(summary_wide, file.path(section_dir, "summary_statistics.rds"))
  
  # Lav en simpel tekstfil der forklarer at den komplekse tabel er gemt som RDS
  writeLines(
    "Den komplekse tabel 'summary_wide' kunne ikke gemmes som CSV og er i stedet gemt som en RDS-fil. 
    Brug readRDS('summary_statistics.rds') for at indlæse den i R.",
    file.path(section_dir, "summary_statistics_info.txt")
  )
})

# Section 2: Outcome Variable Analysis --------------
section_dir <- file.path(main_dir, "2_Outcome_Analyse")
pdf(file.path(section_dir, "eda_section2_outcome.pdf"), width = 12, height = 8)
print(climate_dist_plot)
print(climate_country_plot)
print(climate_time_plot)
print(components_plot)
print(zero_plot)
print(family_climate_plot)
dev.off()

# Save individual plots
ggsave(file.path(section_dir, "climate_dist_plot.png"), climate_dist_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "climate_country_plot.png"), climate_country_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "climate_time_plot.png"), climate_time_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "components_plot.png"), components_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "zero_plot.png"), zero_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "family_climate_plot.png"), family_climate_plot, width = 10, height = 6, dpi = 300)

# Create a simple histogram as a substitute for the density test
density_test_plot_substitute <- ggplot(final_dataset, aes(x = centered_lagged_pervote_samlet)) +
  geom_histogram(binwidth = 0.25, fill = "steelblue", color = "darkblue", alpha = 0.7) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Distribution Around Threshold (Simple Histogram)",
    subtitle = "Note: rddensity test failed - showing basic histogram instead",
    x = "Centered Vote Share",
    y = "Count"
  ) +
  theme_minimal()

# Section 3: Running Variable and Treatment Analysis --------------
section_dir <- file.path(main_dir, "3_Running_Variable_Analyse")
pdf(file.path(section_dir, "eda_section3_running_var.pdf"), width = 12, height = 8)
print(rv_dist_plot)
print(rdplotdensity)
print(seat_allocation_plot)
print(rile_balance)
print(gdp_balance)
print(unemp_balance)
print(green_time_plot)
dev.off()

# Save individual plots
ggsave(file.path(section_dir, "rv_dist_plot.png"), rv_dist_plot, width = 10, height = 6, dpi = 300)
# Try to save rdplotdensity if possible
tryCatch({
  ggsave(file.path(section_dir, "rdplotdensity.png"), rdplotdensity, width = 10, height = 6, dpi = 300)
}, error = function(e) {
  # If fails, save the substitute
  ggsave(file.path(section_dir, "density_test_substitute.png"), density_test_plot_substitute, width = 10, height = 6, dpi = 300)
})
ggsave(file.path(section_dir, "seat_allocation_plot.png"), seat_allocation_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "rile_balance.png"), rile_balance, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "gdp_balance.png"), gdp_balance, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "unemp_balance.png"), unemp_balance, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "green_time_plot.png"), green_time_plot, width = 10, height = 6, dpi = 300)

# Section 4: Moderating Variables Analysis --------------
section_dir <- file.path(main_dir, "4_Modererende_Variable")
pdf(file.path(section_dir, "eda_section4_moderating.pdf"), width = 12, height = 8)
print(rrp_time_plot)
print(correlation_plot)
print(econ_indicators_plot)
print(ideology_dist_plot)
print(party_size_plot)
dev.off()

# Save individual plots
ggsave(file.path(section_dir, "rrp_time_plot.png"), rrp_time_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "correlation_plot.png"), correlation_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "econ_indicators_plot.png"), econ_indicators_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "ideology_dist_plot.png"), ideology_dist_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "party_size_plot.png"), party_size_plot, width = 10, height = 6, dpi = 300)

# Section 5: Preliminary Relationship Exploration --------------
section_dir <- file.path(main_dir, "5_Preliminary_Relationsanalyse")
pdf(file.path(section_dir, "eda_section5_relationships.pdf"), width = 12, height = 8)
print(bivariate_plot)
print(conditional_means_comparison)
print(polynomial_comparison)
print(bandwidth_comparison)
print(rrp_facet_plot)
print(gdp_facet_plot)
print(economy_facet_plot)
print(ideology_facet_plot)
print(size_facet_plot)
print(placebo_plot)
dev.off()

# Save individual plots
ggsave(file.path(section_dir, "bivariate_plot.png"), bivariate_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "conditional_means_comparison.png"), conditional_means_comparison, width = 12, height = 9, dpi = 300)
ggsave(file.path(section_dir, "polynomial_comparison.png"), polynomial_comparison, width = 10, height = 8, dpi = 300)
ggsave(file.path(section_dir, "bandwidth_comparison.png"), bandwidth_comparison, width = 10, height = 8, dpi = 300)
ggsave(file.path(section_dir, "rrp_facet_plot.png"), rrp_facet_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "gdp_facet_plot.png"), gdp_facet_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "economy_facet_plot.png"), economy_facet_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "ideology_facet_plot.png"), ideology_facet_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "size_facet_plot.png"), size_facet_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "placebo_plot.png"), placebo_plot, width = 10, height = 6, dpi = 300)

# Create substitute for missing patterns plot if needed
if (!exists("missing_patterns_plot")) {
  # Create simple missing data visualization as substitute
  missing_data_viz <- vis_miss(final_dataset %>% 
                              select(miljø_afhængig, pervote_samlet, 
                                    lagged_pervote_samlet, rrp_i_p_lag1, 
                                    `GDP_per_capita_lag1`, Unemployment))
  missing_patterns_plot <- missing_data_viz
}

# Section 6: Additional Analyses --------------
section_dir <- file.path(main_dir, "6_Yderligere_Analyser")
pdf(file.path(section_dir, "eda_section6_additional.pdf"), width = 12, height = 8)
tryCatch({
  print(missing_patterns_plot)
}, error = function(e) {
  # If there's an error, print a message plot
  grid::grid.text("Missing patterns plot unavailable", 0.5, 0.5)
})
print(bar_plot_missing)
print(heatmap_plot_missing)
print(zero_by_parfam_plot)
print(family_time_plot)
print(country_trends_plot)
print(climate_events_plot)
print(parl_status_dist)
print(before_after_plot)
print(economy_scatter)
print(ridge_plot)
dev.off()

# Save individual plots
tryCatch({
  ggsave(file.path(section_dir, "missing_patterns_plot.png"), missing_patterns_plot, width = 10, height = 6, dpi = 300)
}, error = function(e) {
  # If fails, save a placeholder text instead
  png(file.path(section_dir, "missing_patterns_plot_unavailable.png"), width = 800, height = 600)
  grid::grid.text("Missing patterns plot unavailable", 0.5, 0.5)
  dev.off()
})

ggsave(file.path(section_dir, "bar_plot_missing.png"), bar_plot_missing, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "heatmap_plot_missing.png"), heatmap_plot_missing, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "zero_by_parfam_plot.png"), zero_by_parfam_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "family_time_plot.png"), family_time_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "country_trends_plot.png"), country_trends_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "climate_events_plot.png"), climate_events_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "parl_status_dist.png"), parl_status_dist, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "before_after_plot.png"), before_after_plot, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "economy_scatter.png"), economy_scatter, width = 10, height = 6, dpi = 300)
ggsave(file.path(section_dir, "ridge_plot.png"), ridge_plot, width = 10, height = 6, dpi = 300)

# Create a single combined PDF with all plots
pdf(file.path(main_dir, "Samlet", "all_eda_plots.pdf"), width = 12, height = 8)
for (plot_name in names(eda_plots)) {
  if (exists(plot_name)) {
    tryCatch({
      plot_obj <- get(plot_name)
      print(plot_obj)
    }, error = function(e) {
      # If there's an error, print a message in the PDF
      grid::grid.text(paste("Error with plot:", plot_name), 0.5, 0.5)
    })
  }
}
dev.off()

# Print confirmation message
cat("All EDA figures and tables have been saved to:", main_dir, "\n")
cat("Organized in the following subdirectories:\n")
for (dir_name in section_dirs) {
  cat(" - ", dir_name, "\n")
}
```

#View(final_dataset %>% dplyr::select(countryname, country, edate, party, miljø_afhængig, miljø_afhængig_alt,  per416, per501, per410, lagged_i_parlament, centered_lagged_pervote_samlet))



# 2.1 Robusthedstest af Miljø Afhængig
```{r Robusthedstest af Miljø Afhængig}
# Tilføj KDE til robusthedsanalyse
library(ggplot2)

# 1. KDE for hele datasættet
kde_full <- density(clean_data$miljø_afhængig)
plot(kde_full, main="KDE for hele datasættet", 
     xlab="Miljø Afhængig Variable")

# 2. KDE opdelt efter side af tærsklen
kde_below_threshold <- density(clean_data$miljø_afhængig[clean_data$centered_lagged_pervote_samlet < 0])
kde_above_threshold <- density(clean_data$miljø_afhængig[clean_data$centered_lagged_pervote_samlet >= 0])

# Plot KDE for begge sider af tærsklen
plot(kde_below_threshold, col="blue", main="KDE opdelt efter tærskel", 
     xlab="Miljø Afhængig Variable")
lines(kde_above_threshold, col="red")
legend("topright", legend=c("Under tærskel", "Over tærskel"), 
        col=c("blue", "red"), lty=1)

# 3. Statistisk test for forskel i fordelinger
# Kernal density test (approximate)
library(stats)
ks_test <- ks.test(
  clean_data$miljø_afhængig[clean_data$centered_lagged_pervote_samlet < 0],
  clean_data$miljø_afhængig[clean_data$centered_lagged_pervote_samlet >= 0]
)
print(ks_test)

# 4. ggplot visualisering med facet
ggplot(clean_data, aes(x = miljø_afhængig)) +
  geom_density(aes(fill = centered_lagged_pervote_samlet >= 0), alpha = 0.5) +
  facet_wrap(~ (centered_lagged_pervote_samlet >= 0)) +
  labs(title = "KDE fordeling på begge sider af tærsklen",
       x = "Miljø Afhængig Variable",
       y = "Tæthed") +
  theme_minimal()

# 5. Tilføj bootstrap konfidensintervaller for KDE
library(boot)

# Funktion til at beregne KDE
kde_boot_function <- function(data, indices) {
  d <- density(data[indices])
  return(d$y)
}

# Bootstrap KDE
boot_result <- boot(clean_data$miljø_afhængig, 
                    statistic = kde_boot_function, 
                    R = 1000)

# Plot KDE med bootstrap konfidensintervaller
plot(kde_full, main="KDE med Bootstrap Konfidensintervaller")
lines(kde_full$x, apply(boot_result$t, 2, quantile, probs = 0.025), col = "red", lty = 2)
lines(kde_full$x, apply(boot_result$t, 2, quantile, probs = 0.975), col = "red", lty = 2)
```


# 3. Testing the Five Hypotheses

## 3.1 H1: When green parties enter parliament, climate focus in mainstream parties decreases

```{r h1_analysis}
# Opret først hovedmappen Robusthedstests, hvis den ikke allerede eksisterer
dir.create("Analyse", showWarnings = FALSE)

# Opret derefter undermappen H4 tests - Appendiks
dir.create("Analyse/H1", showWarnings = FALSE)

# 0. For H1 analysis that examines Green Party parliamentary entry effect ----------------
h1_analysis_data <- final_dataset[complete.cases(final_dataset[, c("miljø_afhængig", 
                                                                 "centered_lagged_pervote_samlet", 
                                                                 "lagged_i_parlament",
                                                                 "country", 
                                                                 "edate")]), ]

# Check how many observations we have now
nrow(h1_analysis_data)

# Compare with original and clean_data
cat("Original rows in final_dataset:", nrow(final_dataset), "\n")
cat("Rows in h1_analysis_data:", nrow(h1_analysis_data), "\n")
cat("Rows in clean_data:", nrow(clean_data), "\n")

# Compare with original and clean_data
cat("Original rows in final_dataset:", nrow(final_dataset), "\n")
cat("Rows in h1_analysis_data:", nrow(h1_analysis_data), "\n")
cat("Rows in clean_data:", nrow(clean_data), "\n")

# 1. VISUAL INSPECTION OF THE DISCONTINUITY ----------------

# Create RDD plot 
h1_plot_rdd <- plot_rdd(
  data = h1_analysis_data,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered at threshold)",
  y_label = "Climate Position",
  title = "Effect of Green Party Entry on Mainstream Climate Focus"
)

# Save the plot
ggsave("Analyse/H1/h1_rdd_plot.png", h1_plot_rdd, width = 10, height = 6, dpi = 300)

# Create a zoomed-in version of the RDD plot for better threshold visualization
h1_plot_rdd_zoom <- jump_plot_cutoff(
  data = h1_analysis_data,
  force_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  polynomial = 1,
  window = 3
)

# Save the zoomed-in plot
ggsave("Analyse/H1/h1_rdd_plot_zoom.png", h1_plot_rdd_zoom, width = 10, height = 6, dpi = 300)

# 2. RDD ESTIMATION ----------------

# Main RDD estimation with optimal bandwidth
h1_rdd <- rdrobust(
  y = h1_analysis_data$miljø_afhængig,
  x = h1_analysis_data$centered_lagged_pervote_samlet,
  c = 0,
  p = 1,  # linear polynomial
  kernel = "triangular",
  bwselect = "mserd"  # MSE-optimal bandwidth
)

# Print summary
summary_h1 <- summary(h1_rdd)

# Opret tabel direkte fra h1_rdd objektet
main_results <- data.frame(
  Outcome = "Climate Position",
  Bandwidth = round(h1_rdd$bws[1, 1], 3),
  LATE = round(h1_rdd$Estimate[1], 3),
  StdError = round(h1_rdd$se[1], 3),
  pvalue = round(h1_rdd$pv[1], 3),
  CI_Lower = round(h1_rdd$ci[1, 1], 3),
  CI_Upper = round(h1_rdd$ci[1, 2], 3)
)

# Create a nice table for presentation
main_results_table <- knitr::kable(main_results, 
                                  caption = "Main RDD Results for H1",
                                  col.names = c("Outcome Variable", "Bandwidth", "LATE", "Std. Error", 
                                               "p-value", "95% CI Lower", "95% CI Upper"))

# Save the table to a file
writeLines(main_results_table, file.path(getwd(), "Analyse/H1/h1_main_results.md"))
print(main_results_table)
write.csv(main_results_table, "Analyse/H1/h1_main_results.csv", row.names = FALSE)  


# 3. ROBUSTNESS CHECKS ----------------

# 3.1 Different Bandwidths and Polynomial Orders ----------

# Run systematic robustness checks with different specifications
results_df_h1 <- run_rdd_robustness(
  data = h1_analysis_data,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = c(1, 1.5, 2, 2.5, 3, 3.5, 4),
  polynomials = c(1, 2, 3, 4),
  covariates = c("country", "edate"),
  group_label = "H1"
)

print(results_df_h1)
# Vælg kun bestemte kolonner til tabellen
selected_columns <- c("Group", "Polynomial", "Bandwidth", "LATE", "StdErr", "p_value", "N_left_of_c", "N_right_of_c")
robustness_table <- knitr::kable(results_df_h1[, selected_columns], 
                               caption = "RDD Estimates Across Different Specifications",
                               col.names = c("Group", "Polynomial", "Bandwidth", "LATE", "Std. Error", 
                                           "p-value", "N Left", "N Right"))

# Save the table to a file
write.csv(robustness_table, "Analyse/H1/h1_robustness_table.csv", row.names = FALSE)  
```

## 3.2 H2: Radical right parties in parliament reduce climate focus in mainstream parties
```{r H2}
# Opret først hovedmappen Robusthedstests, hvis den ikke allerede eksisterer
dir.create("Analyse", showWarnings = FALSE)

# Opret derefter undermappen H4 tests - Appendiks
dir.create("Analyse/H2", showWarnings = FALSE)

# 0. For H2 analysis that examines radical right party moderation ----------------
h2_analysis_data <- final_dataset[complete.cases(final_dataset[, c("miljø_afhængig", 
                                                                "centered_lagged_pervote_samlet", 
                                                                "lagged_i_parlament",
                                                                "rrp_i_p_lag1",
                                                                "country", 
                                                                "edate")]), ]

# Check how many observations we have now
nrow(h2_analysis_data)

# 1. VISUAL INSPECTION OF THE DISCONTINUITY ----------------
## Split data based on RRP status and remove NA values
data_no_rrp <- subset(h2_analysis_data, rrp_i_p_lag1 == 0)
data_with_rrp <- subset(h2_analysis_data, rrp_i_p_lag1 == 1)

## RDD visualization for No RRP
h2_plot_no_rrp <- plot_rdd(
  data = data_no_rrp,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered)",
  y_label = "Climate Position",
  title = "H2a: Climate Position without RRP"
)

# RDD visualization for With RRP
h2_plot_with_rrp <- plot_rdd(
  data = data_with_rrp,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered)",
  y_label = "Climate Position",
  title = "H2b: Climate Position with RRP"
)

# Først gemmer vi det kombinerede plot i en variabel
combined_plot <- grid.arrange(h2_plot_no_rrp, h2_plot_with_rrp, 
             ncol = 2,
             widths = c(1, 1),
             top = "Comparison of Green Party Effect with/without RRP in Parliament")

# Derefter bruger vi ggsave til at gemme plottet
ggsave("Analyse/H2/comparison_green_party_effect.png", combined_plot, width = 12, height = 6)

# 2. RDD ESTIMATION ----------------
## Standard rdrobust for No RRP
h2_rdd_no_rrp <- rdrobust(
  y = data_no_rrp$miljø_afhængig,
  x = data_no_rrp$centered_lagged_pervote_samlet,
  c = 0,
  p = 1,  # linear polynomial
  kernel = "triangular",
  bwselect = "mserd"  # MSE-optimal bandwidth
)

# Opret tabel direkte fra h2_uden_rrp objektet
main_results_table_h2_no_rdd <- data.frame(
  Outcome = "Climate Position",
  Bandwidth = round(h2_rdd_no_rrp$bws[1, 1], 3),
  LATE = round(h2_rdd_no_rrp$Estimate[1], 3),
  StdError = round(h2_rdd_no_rrp$se[1], 3),
  pvalue = round(h2_rdd_no_rrp$pv[1], 3),
  CI_Lower = round(h2_rdd_no_rrp$ci[1, 1], 3),
  CI_Upper = round(h2_rdd_no_rrp$ci[1, 2], 3)
)
  
# Create a nice table for presentation
main_results_table_h2_no_rdd <- knitr::kable(main_results_table_h2_no_rdd, 
                                  caption = "Main RDD Results for H4_right",
                                  col.names = c("Outcome Variable", "Bandwidth", "LATE", "Std. Error", 
                                               "p-value", "95% CI Lower", "95% CI Upper"))

# Save the table to a file
writeLines(main_results_table_h2_no_rdd, file.path(getwd(), "Analyse/H2/h2_no_rdd_main_results.md"))
print(main_results_table_h2_no_rdd)
write.csv(main_results_table_h2_no_rdd, "Analyse/H2/h2_no_rdd_main_results.csv", row.names = FALSE)  

# Standard rdrobust for With RRP
h2_rdd_with_rrp <- rdrobust(
  y = data_with_rrp$miljø_afhængig,
  x = data_with_rrp$centered_lagged_pervote_samlet,
  c = 0,
  p = 1,  # linear polynomial
  kernel = "triangular",
  bwselect = "mserd"  # MSE-optimal bandwidth
)

# Opret tabel direkte fra h2_med_rrp objektet
main_results_table_h2_with_rdd <- data.frame(
  Outcome = "Climate Position",
  Bandwidth = round(h2_rdd_with_rrp$bws[1, 1], 3),
  LATE = round(h2_rdd_with_rrp$Estimate[1], 3),
  StdError = round(h2_rdd_with_rrp$se[1], 3),
  pvalue = round(h2_rdd_with_rrp$pv[1], 3),
  CI_Lower = round(h2_rdd_with_rrp$ci[1, 1], 3),
  CI_Upper = round(h2_rdd_with_rrp$ci[1, 2], 3)
)
  
# Create a nice table for presentation
main_results_table_h2_with_rdd <- knitr::kable(main_results_table_h2_with_rdd, 
                                  caption = "Main RDD Results for H2_with_RRP",
                                  col.names = c("Outcome Variable", "Bandwidth", "LATE", "Std. Error", 
                                               "p-value", "95% CI Lower", "95% CI Upper"))

# Save the table to a file
writeLines(main_results_table_h2_with_rdd, file.path(getwd(), "Analyse/H2/h2_with_rdd_main_results.md"))
print(main_results_table_h2_with_rdd)
write.csv(main_results_table_h2_with_rdd, "Analyse/H2/h2_with_rdd_main_results.csv", row.names = FALSE)  

# 3. ROBUSTNESS CHECKS ----------------

# 3.1 Different Bandwidths and Polynomial Orders ----------
## Define covariates to control for
covariates_to_use <- c("country", "edate")

# Run systematic robustness analysis for both groups
results_df_no_rrp <- run_rdd_robustness(
  data = data_no_rrp,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = c(1, 1.5, 2, 2.5, 3),
  polynomials = c(1, 2, 3, 4),
  covariates = covariates_to_use,
  group_label = "No RRP in Parliament"
)

results_df_with_rrp <- run_rdd_robustness(
  data = data_with_rrp,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = c(1, 1.5, 2, 2.5, 3),
  polynomials = c(1, 2, 3, 4),
  covariates = covariates_to_use,
  group_label = "RRP in Parliament"
)



## Combine results for direct comparison
combined_results <- rbind(results_df_no_rrp, results_df_with_rrp)
print(combined_results)
write.csv(combined_results, "Analyse/H2/h2_rdd_robust.csv", row.names = FALSE)
```


## 3.3

```{r h3_analysis}
# Opret først hovedmappen Robusthedstests, hvis den ikke allerede eksisterer
dir.create("Analyse", showWarnings = FALSE)

# Opret derefter undermappen H4 tests - Appendiks
dir.create("Analyse/H3", showWarnings = FALSE)

# 0. Klargør Data ----------------
# For H3 analysis examining economic conditions moderation
# Version using GDP growth
h3_gdp_analysis_data <- final_dataset[complete.cases(final_dataset[, c("miljø_afhængig", 
                                                                     "centered_lagged_pervote_samlet", 
                                                                     "lagged_i_parlament",
                                                                     "high_gdp_growth_lag1",
                                                                     "country", 
                                                                     "edate")]), ]

# Check how many observations we have now
nrow(h3_gdp_analysis_data)


# Opdel data baseret på BNP-vækst
h3_high_gdp <- subset(h3_gdp_analysis_data, high_gdp_growth_lag1 == 1)
h3_low_gdp <- subset(h3_gdp_analysis_data, high_gdp_growth_lag1 == 0)

# 1. VISUAL INSPECTION OF THE DISCONTINUITY ----------------

## RDD visualization for høj gdp
h3_plot_high_gdp <- plot_rdd(
  data = h3_high_gdp,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered)",
  y_label = "Climate Position",
  title = "H3a: Climate Position med høj GDP"
)

# RDD visualization for lav gdp
h3_plot_low_gdp <- plot_rdd(
  data = h3_low_gdp,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered)",
  y_label = "Climate Position",
  title = "H3b: Climate Position med lav GDP"
)

# Først gemmer vi det kombinerede plot i en variabel
combined_plot_gdp <- grid.arrange(h3_plot_high_gdp, h3_plot_low_gdp, 
             ncol = 2,
             widths = c(1, 1),
             top = "Comparison of Green Party Effect with høj/lav GDP")

# Derefter bruger vi ggsave til at gemme plottet
ggsave("Analyse/H3/comparison_green_party_gdp_effect.png", combined_plot_gdp, width = 12, height = 6)

# 1.2 RDD ESTIMATION GDP ----------------
## Standard rdrobust
h3_rdd_high_gdp <- rdrobust(
  y = h3_high_gdp$miljø_afhængig,
  x = h3_high_gdp$centered_lagged_pervote_samlet,
  c = 0,
  p = 1,  # linear polynomial
  kernel = "triangular",
  h = 1.5
)

# Opret tabel direkte fra h4_left_rdd objektet
main_results_table_h3_high_gdp <- data.frame(
  Outcome = "Climate Position",
  Bandwidth = round(h3_rdd_high_gdp$bws[1, 1], 3),
  LATE = round(h3_rdd_high_gdp$Estimate[1], 3),
  StdError = round(h3_rdd_high_gdp$se[1], 3),
  pvalue = round(h3_rdd_high_gdp$pv[1], 3),
  CI_Lower = round(h3_rdd_high_gdp$ci[1, 1], 3),
  CI_Upper = round(h3_rdd_high_gdp$ci[1, 2], 3)
)
  
# Create a nice table for presentation
main_results_table_h3_high_gdp <- knitr::kable(main_results_table_h3_high_gdp, 
                                  caption = "Main RDD Results for H3_high_GDP",
                                  col.names = c("Outcome Variable", "Bandwidth", "LATE", "Std. Error", 
                                               "p-value", "95% CI Lower", "95% CI Upper"))

# Save the table to a file
writeLines(main_results_table_h3_high_gdp, file.path(getwd(), "Analyse/H3/h3_gdp_high_main_results.md"))
print(main_results_table_h3_high_gdp)
write.csv(main_results_table_h3_high_gdp, "Analyse/H3/h3_gdp_high_main_results.csv", row.names = FALSE)

# Standard rdrobust
h3_rdd_low_gdp <- rdrobust(
  y = h3_low_gdp$miljø_afhængig,
  x = h3_low_gdp$centered_lagged_pervote_samlet,
  c = 0,
  p = 1,  # linear polynomial
  kernel = "triangular",
  bwselect = "mserd"
)

# Opret tabel direkte fra h4_left_rdd objektet
main_results_table_h3_low_gdp <- data.frame(
  Outcome = "Climate Position",
  Bandwidth = round(h3_rdd_low_gdp$bws[1, 1], 3),
  LATE = round(h3_rdd_low_gdp$Estimate[1], 3),
  StdError = round(h3_rdd_low_gdp$se[1], 3),
  pvalue = round(h3_rdd_low_gdp$pv[1], 3),
  CI_Lower = round(h3_rdd_low_gdp$ci[1, 1], 3),
  CI_Upper = round(h3_rdd_low_gdp$ci[1, 2], 3)
)
  
# Create a nice table for presentation
main_results_table_h3_low_gdp <- knitr::kable(main_results_table_h3_low_gdp, 
                                  caption = "Main RDD Results for H3_low_GDP",
                                  col.names = c("Outcome Variable", "Bandwidth", "LATE", "Std. Error", 
                                               "p-value", "95% CI Lower", "95% CI Upper"))

# Save the table to a file
writeLines(main_results_table_h3_low_gdp, file.path(getwd(), "Analyse/H3/h3_gdp_low_main_results.md"))
print(main_results_table_h3_low_gdp)
write.csv(main_results_table_h3_low_gdp, "Analyse/H3/h3_gdp_low_main_results.csv", row.names = FALSE)  

# 1.3 ROBUSTNESS CHECKS GDP ----------------

# Robustness analysis med forskellige båndbredder
covariates_to_use <- c("country", "edate")

# Kør robusthedsanalysen på høj BNP-vækst data
results_df_h3_high_gdp <- run_rdd_robustness(
  data = h3_high_gdp,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = c(1, 1.5, 2, 2.5, 3),
  polynomials = c(1, 2, 3, 4),
  covariates = covariates_to_use,
  group_label = "H3 - Høj BNP-vækst"
)

# Kør robusthedsanalysen på lav BNP-vækst data
results_df_h3_low_gdp <- run_rdd_robustness(
  data = h3_low_gdp,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = c(1, 1.5, 2, 2.5, 3),
  polynomials = c(1, 2, 3, 4),
  covariates = covariates_to_use,
  group_label = "H3 - Lav BNP-vækst"
)

# Vis resultater
print(results_df_h3_high_gdp)
print(results_df_h3_low_gdp)

# Kombiner resultater i en pæn tabel og gem som markdown
if (requireNamespace("knitr", quietly = TRUE)) {
  combined_results_gdp <- rbind(results_df_h3_high_gdp, results_df_h3_low_gdp)
  
  # Opret tabellen i markdown-format
  md_table <- knitr::kable(combined_results_gdp, 
                     caption = "H3: Robusthedstest opdelt efter BNP-vækst", 
                     format = "markdown")
  
  # Gem markdown-tabellen til en fil
  write(md_table, file = "Analyse/H3/h3_gdp_robustness_table.md")
  
  # Udskriv også i konsollen for reference
  print(md_table)
}


# 2. ANALYSIS WITH COMPOSITE ECONOMIC INDICATOR ----------------
# Split data based on economic condition
h3_econ_analysis_data <- final_dataset[complete.cases(final_dataset[, c("miljø_afhængig", 
                                                                      "centered_lagged_pervote_samlet", 
                                                                      "lagged_i_parlament",
                                                                      "good_economy_lag1",
                                                                      "country", 
                                                                      "edate")]), ]

# Check how many observations we have now
nrow(h3_econ_analysis_data)

clean_data_good_economy <- subset(h3_econ_analysis_data, good_economy_lag1 == 1)
clean_data_bad_economy <- subset(h3_econ_analysis_data, good_economy_lag1 == 0)

# 2.1 VISUAL INSPECTION OF THE DISCONTINUITY ----------------

# Visual confirmation - good economy
h3_plot_good <- plot_rdd(
  data = clean_data_good_economy,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered)",
  y_label = "Climate Position",
  title = "H3c: Effect Under Good Economic Conditions"
)
print(h3_plot_good)

# Visual confirmation - bad economy
h3_plot_bad <- plot_rdd(
  data = clean_data_bad_economy,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered)",
  y_label = "Climate Position",
  title = "H3d: Effect Under Poor Economic Conditions"
)
print(h3_plot_bad)

# Gem plots
ggsave("Analyse/H3/h3_plot_good_economy.png", h3_plot_good, width = 10, height = 6)
ggsave("Analyse/H3/h3_plot_bad_economy.png", h3_plot_bad, width = 10, height = 6)

# Først gemmer vi det kombinerede plot i en variabel
combined_plot_good_bad_economy <- grid.arrange(h3_plot_good, h3_plot_bad, 
             ncol = 2,
             widths = c(1, 1),
             top = "Comparison of Green Party Effect with Good/Bad Economy")

ggsave("Analyse/H3/comparison_green_party_economy_effect.png", combined_plot_good_bad_economy, width = 12, height = 6)


# 2.2 RDD ESTIMATION Good/Bad Economy ----------------
h3_rdd_good_economy <- rdrobust(
  y = clean_data_good_economy$miljø_afhængig,
  x = clean_data_good_economy$centered_lagged_pervote_samlet,
  c = 0,
  p = 1,  # linear polynomial
  kernel = "uniform",
  bwselect = "mserd"
)

# Opret tabel direkte fra h3 objektet
main_results_table_h3_good_economy <- data.frame(
  Outcome = "Climate Position",
  Bandwidth = round(h3_rdd_good_economy$bws[1, 1], 3),
  LATE = round(h3_rdd_good_economy$Estimate[1], 3),
  StdError = round(h3_rdd_good_economy$se[1], 3),
  pvalue = round(h3_rdd_good_economy$pv[1], 3),
  CI_Lower = round(h3_rdd_good_economy$ci[1, 1], 3),
  CI_Upper = round(h3_rdd_good_economy$ci[1, 2], 3)
)
  
# Create a nice table for presentation
main_results_table_h3_good_economy <- knitr::kable(main_results_table_h3_good_economy, 
                                  caption = "Main RDD Results for H3_good_economy",
                                  col.names = c("Outcome Variable", "Bandwidth", "LATE", "Std. Error", 
                                               "p-value", "95% CI Lower", "95% CI Upper"))

# Save the table to a file
writeLines(main_results_table_h3_good_economy, file.path(getwd(), "Analyse/H3/h3_economy_good_results.md"))
print(main_results_table_h3_good_economy)
write.csv(main_results_table_h3_good_economy, "Analyse/H3/h3_economy_good_results.csv", row.names = FALSE)  

h3_rdd_bad_economy <- rdrobust(
  y = clean_data_bad_economy$miljø_afhængig,
  x = clean_data_bad_economy$centered_lagged_pervote_samlet,
  c = 0,
  p = 1,  # linear polynomial
  kernel = "triangular",
  bwselect = "mserd"
)

# Opret tabel direkte fra h3 objektet
main_results_table_h3_bad_economy <- data.frame(
  Outcome = "Climate Position",
  Bandwidth = round(h3_rdd_bad_economy$bws[1, 1], 3),
  LATE = round(h3_rdd_bad_economy$Estimate[1], 3),
  StdError = round(h3_rdd_bad_economy$se[1], 3),
  pvalue = round(h3_rdd_bad_economy$pv[1], 3),
  CI_Lower = round(h3_rdd_bad_economy$ci[1, 1], 3),
  CI_Upper = round(h3_rdd_bad_economy$ci[1, 2], 3)
)
  
# Create a nice table for presentation
main_results_table_h3_bad_economy <- knitr::kable(main_results_table_h3_bad_economy, 
                                  caption = "Main RDD Results for H3_bad_economy",
                                  col.names = c("Outcome Variable", "Bandwidth", "LATE", "Std. Error", 
                                               "p-value", "95% CI Lower", "95% CI Upper"))

# Save the table to a file
writeLines(main_results_table_h3_bad_economy, file.path(getwd(), "Analyse/H3/h3_economy_bad_results.md"))
print(main_results_table_h3_bad_economy)
write.csv(main_results_table_h3_bad_economy, "Analyse/H3/h3_economy_bad_results.csv", row.names = FALSE)  

# 2.3 ROBUSTNESS CHECKS good/bad economy ----------------

# Robustness analysis with different bandwidths
# Define covariates to control for
covariates_to_use <- c("country", "edate")

# Run the robustness analysis on good economy data
results_df_h3_good <- run_rdd_robustness(
  data = clean_data_good_economy,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = c(1, 1.5, 2, 2.5, 3),
  polynomials = c(1, 2, 3, 4),
  covariates = covariates_to_use,
  group_label = "H3 - Good Economy"
)

# Run the robustness analysis on bad economy data
results_df_h3_bad <- run_rdd_robustness(
  data = clean_data_bad_economy,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = c(1, 1.5, 2, 2.5, 3),
  polynomials = c(1, 2, 3, 4),
  covariates = covariates_to_use,
  group_label = "H3 - Bad Economy"
)

# Udskriv resultater i konsollen
print(results_df_h3_good)
print(results_df_h3_bad)

# Gem resultaterne separat
write.csv(results_df_h3_good, "Analyse/H3/h3_rdd_robust_good_economy.csv", row.names = FALSE)
write.csv(results_df_h3_bad, "Analyse/H3/h3_rdd_robust_bad_economy.csv", row.names = FALSE)

# Kombiner resultater til sammenligning
combined_results_economy <- rbind(results_df_h3_good, results_df_h3_bad)

# Gem de kombinerede resultater
write.csv(combined_results_economy, "Analyse/H3/h3_rdd_robust_economy_combined.csv", row.names = FALSE)


# Create a nice table with knitr
if (requireNamespace("knitr", quietly = TRUE)) {
  # Combine results
  combined_results_economy <- rbind(results_df_h3_good, results_df_h3_bad)
  
  # Opret og udskriv tabellen i konsollen
  kable_table <- knitr::kable(combined_results_economy, 
                    caption = "H3: Robustness Test Across Economic Conditions")
  print(kable_table)
  
  # Gem tabellen som en markdown-fil
  write(kable_table, file = "Analyse/H3/h3_robustness_economy_table.md")
}

```



## 3.2 H4: When green parties enter parliament, left-wing mainstream parties increase climate focus

```{r h4_analysis}
dir.create("Analyse", showWarnings = FALSE)

# Opret derefter undermappen H4 tests - Appendiks
dir.create("Analyse/H4", showWarnings = FALSE)

# 0. Klargør Data ----------------
# For H4 analysis examining party ideology moderation
h4_analysis_data <- final_dataset[complete.cases(final_dataset[, c("miljø_afhængig", 
                                                                 "centered_lagged_pervote_samlet", 
                                                                 "lagged_i_parlament",
                                                                 "left_party_lag1",
                                                                 "country", 
                                                                 "edate")]), ]

# Check how many observations we have now
nrow(h4_analysis_data)

# Opdel baseret på om partiet er venstre- eller højreorienteret
clean_data_right_party <- subset(h4_analysis_data, left_party_lag1 == 0)
clean_data_left_party <- subset(h4_analysis_data, left_party_lag1 == 1)

# 1. VISUAL INSPECTION OF THE DISCONTINUITY ----------------
# Plots for right parties
h4_plot_right <- plot_rdd(
  data = clean_data_right_party,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered)",
  y_label = "Climate Position",
  title = "H4a: Effekt på højreorienterede partier"
)
print(h4_plot_right)

# Plots for left parties
h4_plot_left <- plot_rdd(
  data = clean_data_left_party,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered)",
  y_label = "Climate Position",
  title = "H4b: Effekt på venstreorienterede partier"
)
print(h4_plot_left)

# Gem plots i den specifikke mappe
ggsave("Analyse/H4/h4_plot_right.png", h4_plot_right, width = 10, height = 6, dpi = 300)
ggsave("Analyse/H4/h4_plot_left.png", h4_plot_left, width = 10, height = 6, dpi = 300)

# Gem kombineret plot
ggsave("Analyse/H4/h4_plot_combined.png", 
        gridExtra::grid.arrange(h4_plot_right, h4_plot_left, ncol = 2,
                                top = "H4: Effekt opdelt efter partiideologi"), 
        width = 16, height = 6, dpi = 300)

# 1.2 RDD ESTIMATION ----------------

h4_rdd_right <- rdrobust(
    y = clean_data_right_party$miljø_afhængig,
    x = clean_data_right_party$centered_lagged_pervote_samlet,
    c = 0,
    p = 1,
    kernel = "triangular",
    bwselect = "mserd"
  )
  summary(h4_rdd_right)

# Opret tabel direkte fra h4_left_rdd objektet
main_results_table_h4_right <- data.frame(
  Outcome = "Climate Position",
  Bandwidth = round(h4_rdd_right$bws[1, 1], 3),
  LATE = round(h4_rdd_right$Estimate[1], 3),
  StdError = round(h4_rdd_right$se[1], 3),
  pvalue = round(h4_rdd_right$pv[1], 3),
  CI_Lower = round(h4_rdd_right$ci[1, 1], 3),
  CI_Upper = round(h4_rdd_right$ci[1, 2], 3)
)
  
# Create a nice table for presentation
main_results_table_h4_right <- knitr::kable(main_results_table_h4_right, 
                                  caption = "Main RDD Results for H4_right",
                                  col.names = c("Outcome Variable", "Bandwidth", "LATE", "Std. Error", 
                                               "p-value", "95% CI Lower", "95% CI Upper"))

# Save the table to a file
writeLines(main_results_table_h4_right, file.path(getwd(), "Analyse/H4/h4_right_main_results.md"))
print(main_results_table_h4_right)
write.csv(main_results_table_h4_right, "Analyse/H4/h4_right_main_results.csv", row.names = FALSE)  

h4_rdd_left <- rdrobust(
    y = clean_data_left_party$miljø_afhængig,
    x = clean_data_left_party$centered_lagged_pervote_samlet,
    c = 0,
    p = 1,
    kernel = "triangular",
    bwselect = "mserd"
  )
  summary(h4_rdd_left)

# Opret tabel direkte fra h4_left_rdd objektet
main_results_table_h4_left <- data.frame(
  Outcome = "Climate Position",
  Bandwidth = round(h4_rdd_left$bws[1, 1], 3),
  LATE = round(h4_rdd_left$Estimate[1], 3),
  StdError = round(h4_rdd_left$se[1], 3),
  pvalue = round(h4_rdd_left$pv[1], 3),
  CI_Lower = round(h4_rdd_left$ci[1, 1], 3),
  CI_Upper = round(h4_rdd_left$ci[1, 2], 3)
)
  
# Create a nice table for presentation
main_results_table_h4_left <- knitr::kable(main_results_table_h4_left, 
                                  caption = "Main RDD Results for H4_left",
                                  col.names = c("Outcome Variable", "Bandwidth", "LATE", "Std. Error", 
                                               "p-value", "95% CI Lower", "95% CI Upper"))

# Save the table to a file
writeLines(main_results_table_h4_left, file.path(getwd(), "Analyse/H4/h4_left_main_results.md"))
print(main_results_table_h4_left)
write.csv(main_results_table_h4_left, "Analyse/H4/h4_left_main_results.csv", row.names = FALSE)  
  
# 1.3 ROBUSTNESS CHECKS ----------------

# Robustness analysis med forskellige båndbredder
covariates_to_use <- c("country", "edate")

# Kør robusthedsanalysen for højreorienterede partier
results_df_h4_right <- run_rdd_robustness(
  data = clean_data_right_party,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = c(1, 1.5, 2, 2.5, 3),
  polynomials = c(1, 2, 3, 4),
  covariates = covariates_to_use,
  group_label = "Højreorienterede partier"
)

# Kør robusthedsanalysen for venstreorienterede partier
results_df_h4_left <- run_rdd_robustness(
  data = clean_data_left_party,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = c(1, 1.5, 2, 2.5, 3),
  polynomials = c(1, 2, 3, 4),
  covariates = covariates_to_use,
  group_label = "Venstreorienterede partier"
)

# Kombinér resultaterne for at sammenligne direkte
combined_results_ideology <- rbind(results_df_h4_right, results_df_h4_left)
print(combined_results_ideology)

# Gem dataframes som CSV-filer
write.csv(results_df_h4_right, "Analyse/H4/results_df_h4_right_parties.csv", row.names = FALSE)
write.csv(results_df_h4_left, "Analyse/H4/results_df_h4_left_parties.csv", row.names = FALSE)
write.csv(combined_results_ideology, "Analyse/H4/combined_results_ideology.csv", row.names = FALSE)
```

## 3.3 H5: Larger mainstream parties respond less to green parties in parliament

```{r h5_analysis}
dir.create("Analyse", showWarnings = FALSE)

# Opret derefter undermappen H5 tests - Appendiks
dir.create("Analyse/H5", showWarnings = FALSE)

# 0. Klargør Data ----------------
# For H5 analysis examining party size moderation
h5_analysis_data <- final_dataset[complete.cases(final_dataset[, c("miljø_afhængig", 
                                                                 "centered_lagged_pervote_samlet", 
                                                                 "lagged_i_parlament",
                                                                 "large_party_lag1",
                                                                 "country", 
                                                                 "edate")]), ]

# Check how many observations we have now
nrow(h5_analysis_data)

  # Split data based on party size
large_parties <- subset(h5_analysis_data, large_party_lag1 == 1)
small_parties <- subset(h5_analysis_data, large_party_lag1 == 0)

# 1.1 VISUAL INSPECTION OF THE DISCONTINUITY ----------------
# Visual confirmation for large parties
h5_large_plot <- plot_rdd(
  data = large_parties,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered)",
  y_label = "Climate Position",
  title = "H5: Effect on Large Mainstream Parties"
)
print(h5_large_plot)

# Visual confirmation for small parties
h5_small_plot <- plot_rdd(
  data = small_parties,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered)",
  y_label = "Climate Position",
  title = "H5: Effect on Small Mainstream Parties"
)
print(h5_small_plot)

# Gem plots
ggsave("Analyse/H5/h5_large_parties_plot.png", h5_large_plot, width = 10, height = 6, dpi = 300)
ggsave("Analyse/H5/h5_small_parties_plot.png", h5_small_plot, width = 10, height = 6, dpi = 300)

# Gem kombineret plot
ggsave("Analyse/H5/h5_combined_parties_plot.png", 
       gridExtra::grid.arrange(h5_large_plot, h5_small_plot, ncol = 2,
                               top = "H5: Effect on Mainstream Parties"), 
       width = 16, height = 6, dpi = 300)

# 1.2 RDD ESTIMATION ----------------
h5_large_rdd <- rdrobust(
    y = large_parties$miljø_afhængig,
    x = large_parties$centered_lagged_pervote_samlet,
    c = 0,
    p = 1,
    kernel = "triangular",
    bwselect = "mserd"
  )
  summary(h5_large_rdd)

# Opret tabel direkte fra h4_left_rdd objektet
main_results_table_h5_large <- data.frame(
  Outcome = "Climate Position",
  Bandwidth = round(h5_large_rdd$bws[1, 1], 3),
  LATE = round(h5_large_rdd$Estimate[1], 3),
  StdError = round(h5_large_rdd$se[1], 3),
  pvalue = round(h5_large_rdd$pv[1], 3),
  CI_Lower = round(h5_large_rdd$ci[1, 1], 3),
  CI_Upper = round(h5_large_rdd$ci[1, 2], 3)
)
  
# Create a nice table for presentation
main_results_table_h5_large <- knitr::kable(main_results_table_h5_large, 
                                  caption = "Main RDD Results for H5_right",
                                  col.names = c("Outcome Variable", "Bandwidth", "LATE", "Std. Error", 
                                               "p-value", "95% CI Lower", "95% CI Upper"))

# Save the table to a file
writeLines(main_results_table_h5_large, file.path(getwd(), "Analyse/H5/h5_large_main_results.md"))
print(main_results_table_h5_large)
write.csv(main_results_table_h5_large, "Analyse/H5/h5_large_main_results.csv", row.names = FALSE) 
  
h5_small_rdd <- rdrobust(
    y = small_parties$miljø_afhængig,
    x = small_parties$centered_lagged_pervote_samlet,
    c = 0,
    p = 1,
    kernel = "triangular",
    bwselect = "mserd"
  )

# Opret tabel direkte fra h4_left_rdd objektet
main_results_table_h5_small <- data.frame(
  Outcome = "Climate Position",
  Bandwidth = round(h5_small_rdd$bws[1, 1], 3),
  LATE = round(h5_small_rdd$Estimate[1], 3),
  StdError = round(h5_small_rdd$se[1], 3),
  pvalue = round(h5_small_rdd$pv[1], 3),
  CI_Lower = round(h5_small_rdd$ci[1, 1], 3),
  CI_Upper = round(h5_small_rdd$ci[1, 2], 3)
)

main_results_table_h5_small <- knitr::kable(main_results_table_h5_small, 
                                  caption = "Main RDD Results for H5_small",
                                  col.names = c("Outcome Variable", "Bandwidth", "LATE", "Std. Error", 
                                               "p-value", "95% CI Lower", "95% CI Upper"))

# Save the table to a file
writeLines(main_results_table_h5_small, file.path(getwd(), "Analyse/H5/h5_small_main_results.md"))
print(main_results_table_h5_small)
write.csv(main_results_table_h5_small, "Analyse/H5/h5_small_main_results.csv", row.names = FALSE) 

# 1.3 ROBUSTNESS CHECKS ----------------
# Robustness analysis with different bandwidths
covariates_to_use <- c("country", "edate")

# Run the robustness analysis for large parties
results_df_h5_large <- run_rdd_robustness(
  data = large_parties,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = c(1, 1.5, 2, 2.5, 3),
  polynomials = c(1, 2, 3, 4),
  covariates = covariates_to_use,
  group_label = "Store partier"
)

# Run the robustness analysis for small parties
results_df_h5_small <- run_rdd_robustness(
  data = small_parties,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = c(1, 1.5, 2, 2.5, 3),
  polynomials = c(1, 2, 3, 4),
  covariates = covariates_to_use,
  group_label = "Små partier"
)

# Combine results for direct comparison
combined_results_size <- rbind(results_df_h5_large, results_df_h5_small)
print(combined_results_size)

# Gem dataframes som CSV-filer
write.csv(results_df_h5_large, "Analyse/H5/results_df_h5_large_parties.csv", row.names = FALSE)
write.csv(results_df_h5_small, "Analyse/H5/results_df_h5_small_parties.csv", row.names = FALSE)
write.csv(combined_results_size, "Analyse/H5/combined_results_size.csv", row.names = FALSE)
```

```{r}
# Create directory for interaction tests if it doesn't exist
dir.create("Analyse/Interaction_Tests", showWarnings = FALSE)

# ==== H2: Radical Right Party Presence ====
# Step 1: Run separate RDDs for each group (which you've already done)
rdd_no_rrp <- rdrobust(
  y = data_no_rrp$miljø_afhængig,
  x = data_no_rrp$centered_lagged_pervote_samlet,
  c = 0, p = 1, kernel = "triangular"
)

rdd_with_rrp <- rdrobust(
  y = data_with_rrp$miljø_afhængig,
  x = data_with_rrp$centered_lagged_pervote_samlet,
  c = 0, p = 1, kernel = "triangular"
)

# Step 2: Test the difference between coefficients using a Z-test
estimate_diff <- rdd_with_rrp$Estimate[1] - rdd_no_rrp$Estimate[1]
se_diff <- sqrt(rdd_with_rrp$se[1]^2 + rdd_no_rrp$se[1]^2)  # Assuming independence
z_stat <- estimate_diff / se_diff
p_value <- 2 * (1 - pnorm(abs(z_stat)))

# Create result dataframe
h2_interaction_result <- data.frame(
  Hypothesis = "H2: Radical Right Party",
  Group1_Label = "No RRP",
  Group1_Estimate = rdd_no_rrp$Estimate[1],
  Group1_SE = rdd_no_rrp$se[1],
  Group2_Label = "With RRP",
  Group2_Estimate = rdd_with_rrp$Estimate[1],
  Group2_SE = rdd_with_rrp$se[1],
  Difference = estimate_diff,
  SE_Difference = se_diff,
  Z_statistic = z_stat,
  P_value = p_value
)

# ==== H3: Economic Conditions (GDP Growth) ====
# Step 1: Use your existing RDD results
h3_high_gdp_rdd <- rdrobust(
  y = h3_high_gdp$miljø_afhængig,
  x = h3_high_gdp$centered_lagged_pervote_samlet,
  c = 0, p = 1, kernel = "triangular", h = 1.5
)

h3_low_gdp_rdd <- rdrobust(
  y = h3_low_gdp$miljø_afhængig,
  x = h3_low_gdp$centered_lagged_pervote_samlet,
  c = 0, p = 1, kernel = "triangular", bwselect = "mserd"
)

# Step 2: Test the difference
estimate_diff_h3 <- h3_high_gdp_rdd$Estimate[1] - h3_low_gdp_rdd$Estimate[1]
se_diff_h3 <- sqrt(h3_high_gdp_rdd$se[1]^2 + h3_low_gdp_rdd$se[1]^2)
z_stat_h3 <- estimate_diff_h3 / se_diff_h3
p_value_h3 <- 2 * (1 - pnorm(abs(z_stat_h3)))

# Create result dataframe
h3_interaction_result <- data.frame(
  Hypothesis = "H3: Economic Conditions (GDP)",
  Group1_Label = "Low GDP Growth",
  Group1_Estimate = h3_low_gdp_rdd$Estimate[1],
  Group1_SE = h3_low_gdp_rdd$se[1],
  Group2_Label = "High GDP Growth",
  Group2_Estimate = h3_high_gdp_rdd$Estimate[1],
  Group2_SE = h3_high_gdp_rdd$se[1],
  Difference = estimate_diff_h3,
  SE_Difference = se_diff_h3,
  Z_statistic = z_stat_h3,
  P_value = p_value_h3
)

# ==== H3: Economic Conditions (Composite Economic Indicator) ====
h3_good_economy_rdd <- rdrobust(
  y = clean_data_good_economy$miljø_afhængig,
  x = clean_data_good_economy$centered_lagged_pervote_samlet,
  c = 0,
  p = 1,  # linear polynomial
  kernel = "uniform",
  bwselect = "mserd"
)
h3_bad_economy_rdd <- rdrobust(
  y = clean_data_bad_economy$miljø_afhængig,
  x = clean_data_bad_economy$centered_lagged_pervote_samlet,
  c = 0,
  p = 1,  # linear polynomial
  kernel = "uniform",
  bwselect = "mserd"
)
# Step 2: Test the difference
estimate_diff_h3_comp <- h3_good_economy_rdd$Estimate[1] - h3_bad_economy_rdd$Estimate[1]
se_diff_h3_comp <- sqrt(h3_good_economy_rdd$se[1]^2 + h3_bad_economy_rdd$se[1]^2)
z_stat_h3_comp <- estimate_diff_h3_comp / se_diff_h3_comp
p_value_h3_comp <- 2 * (1 - pnorm(abs(z_stat_h3_comp)))

# Create result dataframe
h3_comp_interaction_result <- data.frame(
  Hypothesis = "H3: Economic Conditions (Composite)",
  Group1_Label = "Poor Economy",
  Group1_Estimate = h3_bad_economy_rdd$Estimate[1],
  Group1_SE = h3_bad_economy_rdd$se[1],
  Group2_Label = "Good Economy",
  Group2_Estimate = h3_good_economy_rdd$Estimate[1],
  Group2_SE = h3_good_economy_rdd$se[1],
  Difference = estimate_diff_h3_comp,
  SE_Difference = se_diff_h3_comp,
  Z_statistic = z_stat_h3_comp,
  P_value = p_value_h3_comp
)

# ==== H4: Party Ideology ====
# Step 1: Use your existing RDD results
h4_left_rdd <- rdrobust(
  y = clean_data_left_party$miljø_afhængig,
  x = clean_data_left_party$centered_lagged_pervote_samlet,
  c = 0, p = 1, kernel = "triangular"
)

h4_right_rdd <- rdrobust(
  y = clean_data_right_party$miljø_afhængig,
  x = clean_data_right_party$centered_lagged_pervote_samlet,
  c = 0, p = 1, kernel = "triangular"
)

# Step 2: Test the difference
estimate_diff_h4 <- h4_left_rdd$Estimate[1] - h4_right_rdd$Estimate[1]
se_diff_h4 <- sqrt(h4_left_rdd$se[1]^2 + h4_right_rdd$se[1]^2)
z_stat_h4 <- estimate_diff_h4 / se_diff_h4
p_value_h4 <- 2 * (1 - pnorm(abs(z_stat_h4)))

# Create result dataframe
h4_interaction_result <- data.frame(
  Hypothesis = "H4: Party Ideology",
  Group1_Label = "Right-wing Parties",
  Group1_Estimate = h4_right_rdd$Estimate[1],
  Group1_SE = h4_right_rdd$se[1],
  Group2_Label = "Left-wing Parties",
  Group2_Estimate = h4_left_rdd$Estimate[1],
  Group2_SE = h4_left_rdd$se[1],
  Difference = estimate_diff_h4,
  SE_Difference = se_diff_h4,
  Z_statistic = z_stat_h4,
  P_value = p_value_h4
)

# ==== H5: Party Size ====
# Step 1: Use your existing RDD results
h5_large_rdd <- rdrobust(
  y = large_parties$miljø_afhængig,
  x = large_parties$centered_lagged_pervote_samlet,
  c = 0, p = 1, kernel = "triangular"
)

h5_small_rdd <- rdrobust(
  y = small_parties$miljø_afhængig,
  x = small_parties$centered_lagged_pervote_samlet,
  c = 0, p = 1, kernel = "triangular"
)

# Step 2: Test the difference
estimate_diff_h5 <- h5_large_rdd$Estimate[1] - h5_small_rdd$Estimate[1]
se_diff_h5 <- sqrt(h5_large_rdd$se[1]^2 + h5_small_rdd$se[1]^2)
z_stat_h5 <- estimate_diff_h5 / se_diff_h5
p_value_h5 <- 2 * (1 - pnorm(abs(z_stat_h5)))

# Create result dataframe
h5_interaction_result <- data.frame(
  Hypothesis = "H5: Party Size",
  Group1_Label = "Small Parties",
  Group1_Estimate = h5_small_rdd$Estimate[1],
  Group1_SE = h5_small_rdd$se[1],
  Group2_Label = "Large Parties",
  Group2_Estimate = h5_large_rdd$Estimate[1],
  Group2_SE = h5_large_rdd$se[1],
  Difference = estimate_diff_h5,
  SE_Difference = se_diff_h5,
  Z_statistic = z_stat_h5,
  P_value = p_value_h5
)

# ==== Combine All Results ====
all_interaction_tests <- rbind(
  h2_interaction_result,
  h3_interaction_result,
  h3_comp_interaction_result,
  h4_interaction_result,
  h5_interaction_result
)

# Add significance stars
all_interaction_tests$Significance <- ifelse(all_interaction_tests$P_value < 0.01, "***",
                                          ifelse(all_interaction_tests$P_value < 0.05, "**",
                                                ifelse(all_interaction_tests$P_value < 0.1, "*", "")))

# Save to CSV
write.csv(all_interaction_tests, "Analyse/Interaction_Tests/all_interaction_tests.csv", row.names = FALSE)

# Create a formatted table with knitr
if (requireNamespace("knitr", quietly = TRUE)) {
  # Create a nicely formatted table for presentation
  interaction_table <- knitr::kable(all_interaction_tests[, c("Hypothesis", 
                                                            "Group1_Label", "Group1_Estimate", "Group1_SE",
                                                            "Group2_Label", "Group2_Estimate", "Group2_SE",
                                                            "Difference", "SE_Difference", 
                                                            "Z_statistic", "P_value", "Significance")], 
                                    caption = "Formal Tests of Heterogeneous Treatment Effects",
                                    digits = 3)
  
  # Save to a markdown file
  writeLines(interaction_table, "Analyse/Interaction_Tests/interaction_tests_table.md")
}

# ==== Create Visualization ====
# Create a dataframe with just the key information for plotting
plot_data <- data.frame(
  Hypothesis = all_interaction_tests$Hypothesis,
  Difference = all_interaction_tests$Difference,
  SE = all_interaction_tests$SE_Difference,
  p_value = all_interaction_tests$P_value,
  Significance = all_interaction_tests$Significance
)

# Order by effect size for better visualization
plot_data <- plot_data[order(plot_data$Difference), ]
plot_data$Hypothesis <- factor(plot_data$Hypothesis, levels = plot_data$Hypothesis)

# Plot the differences with confidence intervals
interaction_plot <- ggplot(plot_data, aes(x = Difference, y = Hypothesis)) +
  geom_point(size = 3) +
  geom_errorbarh(aes(xmin = Difference - 1.96*SE, 
                     xmax = Difference + 1.96*SE), 
                 height = 0.2) +
  geom_text(aes(label = Significance), vjust = -0.5, hjust = -0.2, size = 5) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Differences in Treatment Effects Between Subgroups",
    subtitle = "Effect in Second Group Minus Effect in First Group",
    x = "Difference in Effects (with 95% CI)",
    y = ""
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold"),
    axis.title.x = element_text(face = "bold"),
    axis.text.y = element_text(face = "bold")
  )

# Save the plot
ggsave("Analyse/Interaction_Tests/interaction_differences_plot.png", 
       interaction_plot, width = 10, height = 6, dpi = 300)

# ==== Create Individual Effect Plots ====
# For a clearer visualization of the direction of effects in each subgroup
subgroup_effects <- data.frame(
  Hypothesis = rep(all_interaction_tests$Hypothesis, each = 2),
  Subgroup = c(rbind(all_interaction_tests$Group1_Label, all_interaction_tests$Group2_Label)),
  Estimate = c(rbind(all_interaction_tests$Group1_Estimate, all_interaction_tests$Group2_Estimate)),
  SE = c(rbind(all_interaction_tests$Group1_SE, all_interaction_tests$Group2_SE))
)

# Plot the individual subgroup effects
subgroup_plot <- ggplot(subgroup_effects, aes(x = Estimate, y = Hypothesis, color = Subgroup)) +
  geom_point(position = position_dodge(width = 0.5), size = 3) +
  geom_errorbarh(aes(xmin = Estimate - 1.96*SE, 
                     xmax = Estimate + 1.96*SE), 
                 position = position_dodge(width = 0.5),
                 height = 0.2) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "black") +
  labs(
    title = "Treatment Effects by Subgroup",
    subtitle = "Effect of Green Party Parliamentary Entry on Climate Focus",
    x = "Estimated Effect (with 95% CI)",
    y = "",
    color = "Subgroup"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(face = "bold"),
    axis.title.x = element_text(face = "bold"),
    axis.text.y = element_text(face = "bold")
  )

# Save the plot
ggsave("Analyse/Interaction_Tests/subgroup_effects_plot.png", 
       subgroup_plot, width = 10, height = 6, dpi = 300)

# Print a summary of the results to console
cat("\n=== FORMAL TESTS OF HETEROGENEOUS TREATMENT EFFECTS ===\n\n")
for(i in 1:nrow(all_interaction_tests)) {
  cat(sprintf("%s:\n", all_interaction_tests$Hypothesis[i]))
  cat(sprintf("  %s: %.3f (SE=%.3f)\n", 
              all_interaction_tests$Group1_Label[i], 
              all_interaction_tests$Group1_Estimate[i],
              all_interaction_tests$Group1_SE[i]))
  cat(sprintf("  %s: %.3f (SE=%.3f)\n", 
              all_interaction_tests$Group2_Label[i], 
              all_interaction_tests$Group2_Estimate[i],
              all_interaction_tests$Group2_SE[i]))
  cat(sprintf("  Difference: %.3f (SE=%.3f), Z=%.3f, p=%.3f %s\n\n", 
              all_interaction_tests$Difference[i],
              all_interaction_tests$SE_Difference[i],
              all_interaction_tests$Z_statistic[i],
              all_interaction_tests$P_value[i],
              all_interaction_tests$Significance[i]))
}
```



```{r Implementation af coefficient stability plots og placebo-tests}
# 1.0 H1: GREEN PARTY PARLIAMENTARY ENTRY EFFECT (MAIN HYPOTHESIS) ----------------
# Opret først hovedmappen Robusthedstests, hvis den ikke allerede eksisterer
dir.create("Robusthedstests", showWarnings = FALSE)

# Opret derefter undermappen H4 tests - Appendiks
dir.create("Robusthedstests/H1 tests - Appendiks", showWarnings = FALSE)

# 1.1 Coefficient Stability Plots for H1 ----------------
h1_stability_plot <- create_coefficient_stability_plot(
  data = h1_analysis_data,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomials = c(1, 2, 3),
  covariates = c("country", "edate"),
  title = "H1: When green parties enter parliament, climate focus changes"
)
ggsave("Robusthedstests/H1 tests - Appendiks/h1_stability_plot.png", plot = h1_stability_plot$plot, width = 10, height = 6, dpi = 300)

# 1.2 Placebo Threshold Tests for H1 ----------------
h1_placebo_threshold <- run_placebo_threshold_test(
  data = h1_analysis_data,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  true_cutpoint = 0,
  placebo_range = c(-4, 4),
  placebo_step = 0.5,
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)
h1_placebo_plot <- plot_placebo_threshold_test(
  h1_placebo_threshold,
  title = "H1: Placebo Threshold Test"
)
ggsave("Robusthedstests/H1 tests - Appendiks/h1_placebo_plot.png", plot = h1_placebo_plot, width = 10, height = 6, dpi = 300)

# 1.3 Outcome Placebo Tests for H1 ----------------
placebo_vars <- c("rile_lowe")  # Use variables unaffected by treatment
h1_outcome_placebo <- run_outcome_placebo_test(
  data = h1_analysis_data,
  real_outcome_var = "miljø_afhængig",
  placebo_outcome_vars = placebo_vars,
  running_var = "centered_lagged_pervote_samlet",
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)
h1_outcome_placebo_plot <- plot_outcome_placebo_test(
  h1_outcome_placebo,
  title = "H1: Outcome Placebo Test"
)
ggsave("Robusthedstests/H1 tests - Appendiks/h1_outcome_placebo_plot.png", plot = h1_outcome_placebo_plot, width = 10, height = 6, dpi = 300)

# 1.4 Density Test for H1 (Manipulation Test) ----------------
# Add McCrary density test
h1_density_test <- rddensity(h1_analysis_data$centered_lagged_pervote_samlet, c = 0, binoW = 0.25, binoWStep = 0.25, fitselect = "restricted", vce = "jackknife")
h1_density_test_summary <- summary(h1_density_test)
h1_density_plot <- rdplotdensity(h1_density_test, 
                               h1_analysis_data$centered_lagged_pervote_samlet,
                               title = "H1: Density Test of Running Variable")
summary(h1_density_test)
summary_text <- capture.output(summary(h1_density_test))
writeLines(summary_text, "Robusthedstests/H1 tests - Appendiks/h1_density_summary.md")

ggsave("Robusthedstests/H1 tests - Appendiks/h1_density_test.png", plot = h1_density_plot$Estplot, width = 10, height = 6, dpi = 300)

# Start omdirigering af output til fil
sink("robusthedstests/H1 tests - Appendiks/densitetstest_forskellige_bw.md.md")

# Skriv en overskrift til filen
cat("# Densitetstest med forskellige båndbredder\n\n")
cat("Test af manipulation ved tærsklen med højreradikale partier.\n\n")

# Kør tests for forskellige båndbredder
for(bw in seq(0.5, 3, by = 0.5)) { 
  cat("\n## Båndbredde:", bw, "\n\n") 
  test <- rddensity(h1_analysis_data$centered_lagged_pervote_samlet, h = bw) 
  print(summary(test)) 
}

# Stop omdirigering af output
sink()

cat("Output gemt i Robusthedstests/H2 tests - Appendiks/densitetstest_forskellige_bw.md\n")

# 1.5 Covariate Balance Tests for H1 ----------------
# Add systematic balance tests for covariates
h1_balance_covariates <- c("rile_lowe", "GDP_per_capita", "Unemployment")
h1_balance_results <- data.frame(
  Covariate = character(),
  RDD_Estimate = numeric(),
  Std_Error = numeric(),
  P_value = numeric()
)
for (cov in h1_balance_covariates) {
  if (cov %in% names(h1_analysis_data)) {
    balance_check <- rdrobust(
      y = h1_analysis_data[[cov]],
      x = h1_analysis_data$centered_lagged_pervote_samlet,
      c = 0,
      p = 1,
      kernel = "triangular",
      bwselect = "mserd"
    )
    h1_balance_results <- rbind(h1_balance_results, data.frame(
      Covariate = cov,
      RDD_Estimate = balance_check$Estimate[1],
      Std_Error = balance_check$se[1],
      P_value = balance_check$pv[1]
    ))
  }
}
if (requireNamespace("knitr", quietly = TRUE)) {
  knitr::kable(h1_balance_results, 
               caption = "H1: Covariate Balance Tests")
}
write.csv(h1_balance_results, "Robusthedstests/H1 tests - Appendiks/h1_balance_tests.csv", row.names = FALSE)

# ============================================================================
# 2. H2: RADICAL RIGHT PARTY PRESENCE EFFECT
# ============================================================================
# 2.0 H2: ----------------
# Opret først hovedmappen Robusthedstests, hvis den ikke allerede eksisterer
dir.create("Robusthedstests", showWarnings = FALSE)

# Opret derefter undermappen H2 tests - Appendiks
dir.create("Robusthedstests/H2 tests - Appendiks", showWarnings = FALSE)

# 2.2 Coefficient Stability Plots for H2 ----------------
h2_no_rrp_plot <- create_coefficient_stability_plot(
  data = data_no_rrp,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomials = c(1, 2, 3),
  covariates = c("country", "edate"),
  title = "H2: No Radical Right Parties"
)
h2_with_rrp_plot <- create_coefficient_stability_plot(
  data = data_with_rrp,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomials = c(1, 2, 3),
  covariates = c("country", "edate"),
  title = "H2: With Radical Right Parties"
)
pdf("Robusthedstests/H2 tests - Appendiks/h2_no_rrp_plot.pdf", width = 10, height = 6)
print(h2_no_rrp_plot)
dev.off()
pdf("Robusthedstests/H2 tests - Appendiks/h2_with_rrp_plot.pdf", width = 10, height = 6)
print(h2_with_rrp_plot)
dev.off()

# 2.3 Comparison of RRP Effects Across Polynomials ----------------
h2_comparison_plot_p1 <- compare_coefficient_stability(
  data_list = list(data_no_rrp, data_with_rrp),
  labels = c("No Radical Right Parties", "Radical Right Parties in Parliament"),
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomial = 1,
  covariates = c("country", "edate"),
  title = "H2: Effect of Green Parties (Polynomial Order 1)"
)

# 2.3 Comparison of RRP Effects Across Polynomials ----------------
h2_comparison_plot_p2 <- compare_coefficient_stability(
  data_list = list(data_no_rrp, data_with_rrp),
  labels = c("No Radical Right Parties", "Radical Right Parties in Parliament"),
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomial = 2,
  covariates = c("country", "edate"),
  title = "H2: Effect of Green Parties (Polynomial Order 1)"
)

# 2.3 Comparison of RRP Effects Across Polynomials ----------------
h2_comparison_plot_p3 <- compare_coefficient_stability(
  data_list = list(data_no_rrp, data_with_rrp),
  labels = c("No Radical Right Parties", "Radical Right Parties in Parliament"),
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomial = 3,
  covariates = c("country", "edate"),
  title = "H2: Effect of Green Parties (Polynomial Order 1)"
)

# 2.3 Comparison of RRP Effects Across Polynomials ----------------
h2_comparison_plot_p4 <- compare_coefficient_stability(
  data_list = list(data_no_rrp, data_with_rrp),
  labels = c("No Radical Right Parties", "Radical Right Parties in Parliament"),
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomial = 4,
  covariates = c("country", "edate"),
  title = "H2: Effect of Green Parties (Polynomial Order 1)"
)


# Continue for p2, p3, p4 similar to your existing code
if (requireNamespace("gridExtra", quietly = TRUE)) {
  h2_all_poly_comparison <- gridExtra::grid.arrange(
    h2_comparison_plot_p1, h2_comparison_plot_p2,
    h2_comparison_plot_p3, h2_comparison_plot_p4,
    ncol = 2, nrow = 2,
    top = "H2: Effect of Green Parties Moderated by Radical Right Parties"
  )
  ggsave("Robusthedstests/H2 tests - Appendiks/h2_all_polynomial_comparison.png", h2_all_poly_comparison, width = 12, height = 10, dpi = 300)
}

# 2.4 Placebo Threshold Tests for H2 ----------------
h2_no_rrp_placebo <- run_placebo_threshold_test(
  data = data_no_rrp,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  true_cutpoint = 0,
  placebo_range = c(-4, 4),
  placebo_step = 0.5,
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)
h2_with_rrp_placebo <- run_placebo_threshold_test(
  data = data_with_rrp,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  true_cutpoint = 0,
  placebo_range = c(-4, 4),
  placebo_step = 0.5,
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)
h2_no_rrp_placebo_plot <- plot_placebo_threshold_test(
  h2_no_rrp_placebo,
  title = "H2: Placebo Test (No Radical Right Parties)"
)
h2_with_rrp_placebo_plot <- plot_placebo_threshold_test(
  h2_with_rrp_placebo,
  title = "H2: Placebo Test (With Radical Right Parties)"
)
ggsave("Robusthedstests/H2 tests - Appendiks/h2_no_rrp_placebo.png", plot = h2_no_rrp_placebo_plot, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H2 tests - Appendiks/h2_with_rrp_placebo.png", plot = h2_with_rrp_placebo_plot, width = 10, height = 6, dpi = 300)

# 2.5 Density Tests for H2 ----------------
# Add McCrary density test for ingen rrp
h2_no_rrp_density_test <- rddensity(data_no_rrp$centered_lagged_pervote_samlet, c = 0, binoW = 0.25, binoWStep = 0.25, fitselect = "restricted", vce = "jackknife")
h2_no_rrp_density_summary <- summary(h2_no_rrp_density_test)
h2_no_rrp_density_plot <- rdplotdensity(h2_no_rrp_density_test, 
                                            data_no_rrp$centered_lagged_pervote_samlet,
                                            title = "H2: Density Test (Uden Højreradikale Partier)")

# Add McCrary density test for med rrp
h2_med_rrp_density_test <- rddensity(data_with_rrp$centered_lagged_pervote_samlet, c = 0, binoW = 0.25, binoWStep = 0.25, fitselect = "restricted", vce = "jackknife")
h2_med_rrp_density_summary <- summary(h2_med_rrp_density_test)
h2_med_rrp_density_plot <- rdplotdensity(h2_med_rrp_density_test, 
                                           data_with_rrp$centered_lagged_pervote_samlet,
                                           title = "H2: Density Test (Med Højreradikale Partier)")

summary(h2_no_rrp_density_test)
summary_text <- capture.output(summary(h2_no_rrp_density_test))
writeLines(summary_text, "Robusthedstests/H2 tests - Appendiks/h2_no_rrp_density_test.md")

summary(h2_med_rrp_density_test)
summary_text <- capture.output(summary(h2_med_rrp_density_test))
writeLines(summary_text, "Robusthedstests/H2 tests - Appendiks/h2_med_rrp_density_test.md")



# Save density plots
ggsave("Robusthedstests/H2 tests - Appendiks/h2_no_rrp_density.png", plot = h2_no_rrp_density_plot$Estplot, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H2 tests - Appendiks/h2_med_rrp_density.png", plot = h2_med_rrp_density_plot$Estplot, width = 10, height = 6, dpi = 300)

# Start omdirigering af output til fil
sink("robusthedstests/H2 tests - Appendiks/densitetstest_forskellige_bw_uden_rrp.md")

# Skriv en overskrift til filen
cat("# Densitetstest med forskellige båndbredder\n\n")
cat("Test af manipulation ved tærsklen uden højreradikale partier.\n\n")

# Kør tests for forskellige båndbredder
for(bw in seq(0.5, 3, by = 0.5)) { 
  cat("\n## Båndbredde:", bw, "\n\n") 
  test <- rddensity(data_no_rrp$centered_lagged_pervote_samlet, h = bw, fitselect = "restricted") 
  print(summary(test)) 
}

# Stop omdirigering af output
sink()

cat("Output gemt i Robusthedstests/H2 tests - Appendiks/densitetstest_forskellige_bw_uden_rrp.md\n")


# Start omdirigering af output til fil
sink("robusthedstests/H2 tests - Appendiks/densitetstest_forskellige_bw_med_rrp.md.md")

# Skriv en overskrift til filen
cat("# Densitetstest med forskellige båndbredder\n\n")
cat("Test af manipulation ved tærsklen med højreradikale partier.\n\n")

# Kør tests for forskellige båndbredder
for(bw in seq(0.5, 3, by = 0.5)) { 
  cat("\n## Båndbredde:", bw, "\n\n") 
  test <- rddensity(data_with_rrp$centered_lagged_pervote_samlet, h = bw, fitselect = "restricted", binoW = 0.5, binoWStep = 0.5) 
  print(summary(test)) 
}

# Stop omdirigering af output
sink()

cat("Output gemt i Robusthedstests/H2 tests - Appendiks/densitetstest_forskellige_bw_med_rrp.md\n")

# ============================================================================
# 3. H3: ECONOMIC CONDITIONS EFFECT
# ============================================================================
# Opret først hovedmappen Robusthedstests, hvis den ikke allerede eksisterer
dir.create("Robusthedstests", showWarnings = FALSE)

# Opret derefter undermappen H2 tests - Appendiks
dir.create("Robusthedstests/H3 tests - Appendiks", showWarnings = FALSE)

# 3.2 Coefficient Stability Plots for H3 (GDP Growth) ----------------
high_gdp_stability_plot <- create_coefficient_stability_plot(
  data = h3_high_gdp,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomials = c(1, 2, 3),
  covariates = c("country", "edate"),
  title = "H3: Effect under High GDP Growth"
)

low_gdp_stability_plot <- create_coefficient_stability_plot(
  data = h3_low_gdp,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomials = c(1, 2, 3),
  covariates = c("country", "edate"),
  title = "H3: Effect under Low GDP Growth"
)

# Save plots
pdf("Robusthedstests/H3 tests - Appendiks/h3_high_gdp_stability.pdf", width = 10, height = 6)
print(high_gdp_stability_plot$plot)
dev.off()

pdf("Robusthedstests/H3 tests - Appendiks/h3_low_gdp_stability.pdf", width = 10, height = 6)
print(low_gdp_stability_plot$plot)
dev.off()

# 3.3 Coefficient Stability Plots for H3 (Economic Index) ----------------
good_economy_stability_plot <- create_coefficient_stability_plot(
  data = clean_data_good_economy,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomials = c(1, 2, 3),
  covariates = c("country", "edate"),
  title = "H3: Effect under Good Economic Conditions"
)

bad_economy_stability_plot <- create_coefficient_stability_plot(
  data = clean_data_bad_economy,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomials = c(1, 2, 3),
  covariates = c("country", "edate"),
  title = "H3: Effect under Poor Economic Conditions"
)

# Save plots
pdf("Robusthedstests/H3 tests - Appendiks/h3_good_economy_stability.pdf", width = 10, height = 6)
print(good_economy_stability_plot$plot)
dev.off()

pdf("Robusthedstests/H3 tests - Appendiks/h3_bad_economy_stability.pdf", width = 10, height = 6)
print(bad_economy_stability_plot$plot)
dev.off()

# 3.4 Direct Comparison of GDP Growth Effects ----------------
gdp_comparison_plot <- compare_coefficient_stability(
  data_list = list(h3_high_gdp, h3_low_gdp),
  labels = c("High GDP Growth", "Low GDP Growth"),
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomial = 1,
  covariates = c("country", "edate"),
  title = "H3: Effect of Green Parties Moderated by GDP Growth"
)

# Save comparison plot
ggsave("Robusthedstests/H3 tests - Appendiks/h3_gdp_comparison.png", plot = gdp_comparison_plot, width = 10, height = 6, dpi = 300)

# 3.5 Direct Comparison of Economic Index Effects ----------------
economy_comparison_plot <- compare_coefficient_stability(
  data_list = list(clean_data_good_economy, clean_data_bad_economy),
  labels = c("Good Economic Conditions", "Poor Economic Conditions"),
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomial = 1,
  covariates = c("country", "edate"),
  title = "H3: Effect of Green Parties Moderated by Economic Conditions"
)

# Save comparison plot
ggsave("Robusthedstests/H3 tests - Appendiks/h3_economy_comparison.png", plot = economy_comparison_plot, width = 10, height = 6, dpi = 300)

# 3.6 Multi-polynomial Comparisons ----------------
# GDP Growth with different polynomial orders
economy_comparison_plot_p1 <- compare_coefficient_stability(
  data_list = list(h3_high_gdp, h3_low_gdp),
  labels = c("High GDP Growth", "Low GDP Growth"),
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomial = 1,
  covariates = c("country", "edate"),
  title = "H3: Effect of Green Parties (Polynomial Order 1)"
)

economy_comparison_plot_p2 <- compare_coefficient_stability(
  data_list = list(h3_high_gdp, h3_low_gdp),
  labels = c("High GDP Growth", "Low GDP Growth"),
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomial = 2,
  covariates = c("country", "edate"),
  title = "H3: Effect of Green Parties (Polynomial Order 2)"
)

# Combine plots in grid if gridExtra is available
if (requireNamespace("gridExtra", quietly = TRUE)) {
  economy_poly_comparison <- gridExtra::grid.arrange(
    economy_comparison_plot_p1, economy_comparison_plot_p2,
    ncol = 2,
    top = "H3: Effect of Green Parties Moderated by GDP Growth"
  )
  
  # Save the combined plot
  ggsave("Robusthedstests/H3 tests - Appendiks/h3_gdp_polynomial_comparison.png", economy_poly_comparison, width = 12, height = 6, dpi = 300)
}

# 3.7 Placebo Threshold Tests for H3 (GDP Growth) ----------------
h3_high_gdp_placebo <- run_placebo_threshold_test(
  data = h3_high_gdp,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  true_cutpoint = 0,
  placebo_range = c(-4, 4),
  placebo_step = 0.5,
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)

h3_low_gdp_placebo <- run_placebo_threshold_test(
  data = h3_low_gdp,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  true_cutpoint = 0,
  placebo_range = c(-4, 4),
  placebo_step = 0.5,
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)

# Plot placebo results
h3_high_gdp_placebo_plot <- plot_placebo_threshold_test(
  h3_high_gdp_placebo,
  title = "H3: Placebo Test (High GDP Growth)"
)

h3_low_gdp_placebo_plot <- plot_placebo_threshold_test(
  h3_low_gdp_placebo,
  title = "H3: Placebo Test (Low GDP Growth)"
)

# Save placebo plots
ggsave("Robusthedstests/H3 tests - Appendiks/h3_high_gdp_placebo.png", plot = h3_high_gdp_placebo_plot, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H3 tests - Appendiks/h3_low_gdp_placebo.png", plot = h3_low_gdp_placebo_plot, width = 10, height = 6, dpi = 300)

# 3.8 Placebo Threshold Tests for H3 (Economic Index) ----------------
h3_good_economy_placebo <- run_placebo_threshold_test(
  data = clean_data_good_economy,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  true_cutpoint = 0,
  placebo_range = c(-4, 4),
  placebo_step = 0.5,
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)

h3_bad_economy_placebo <- run_placebo_threshold_test(
  data = clean_data_bad_economy,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  true_cutpoint = 0,
  placebo_range = c(-4, 4),
  placebo_step = 0.5,
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)

# Plot placebo results
h3_good_economy_placebo_plot <- plot_placebo_threshold_test(
  h3_good_economy_placebo,
  title = "H3: Placebo Test (Good Economic Conditions)"
)

h3_bad_economy_placebo_plot <- plot_placebo_threshold_test(
  h3_bad_economy_placebo,
  title = "H3: Placebo Test (Poor Economic Conditions)"
)

# Save placebo plots
ggsave("Robusthedstests/H3 tests - Appendiks/h3_good_economy_placebo.png", plot = h3_good_economy_placebo_plot, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H3 tests - Appendiks/h3_bad_economy_placebo.png", plot = h3_bad_economy_placebo_plot, width = 10, height = 6, dpi = 300)

# 3.9 Density Tests for H3 (GDP Growth) ----------------
# Add McCrary density test for high GDP growth
h3_high_gdp_density_test <- rddensity(h3_high_gdp$centered_lagged_pervote_samlet, c = 0, binoW = 0.25, binoWStep = 0.25, fitselect = "restricted", vce = "jackknife")
h3_high_gdp_density_summary <- summary(h3_high_gdp_density_test)
h3_high_gdp_density_plot <- rdplotdensity(h3_high_gdp_density_test, 
                                        h3_high_gdp$centered_lagged_pervote_samlet,
                                        title = "H3: Density Test (High GDP Growth)")

# Add McCrary density test for low GDP growth
h3_low_gdp_density_test <- rddensity(h3_low_gdp$centered_lagged_pervote_samlet, c = 0, binoW = 0.25, binoWStep = 0.25, fitselect = "restricted", vce = "jackknife")
h3_low_gdp_density_summary <- summary(h3_low_gdp_density_test)
h3_low_gdp_density_plot <- rdplotdensity(h3_low_gdp_density_test, 
                                       h3_low_gdp$centered_lagged_pervote_samlet,
                                       title = "H3: Density Test (Low GDP Growth)")

summary(h3_high_gdp_density_test)
summary_text <- capture.output(summary(h3_high_gdp_density_test))
writeLines(summary_text, "Robusthedstests/H3 tests - Appendiks/high_gdp_density_test.md")

# Gem output for h3_high_gdp_density_test
sink("Robusthedstests/H3 tests - Appendiks/high_gdp_density_test.md")
cat("# Densitetstest for høj GDP gruppe\n\n")
summary(h3_high_gdp_density_test)
sink()

summary(h3_low_gdp_density_test)
summary_text <- capture.output(summary(h3_low_gdp_density_test))
writeLines(summary_text, "Robusthedstests/H3 tests - Appendiks/low_gdp_density_test.md")


# Save density plots
ggsave("Robusthedstests/H3 tests - Appendiks/h3_high_gdp_density.png", plot = h3_high_gdp_density_plot$Estplot, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H3 tests - Appendiks/h3_low_gdp_density.png", plot = h3_low_gdp_density_plot$Estplot, width = 10, height = 6, dpi = 300)

h3_high_gdp_density_test_alternativ <- DCdensity(h3_high_gdp$centered_lagged_pervote_samlet, c = 0, verbose = TRUE)
h3_low_gdp_density_test_alternativ <- DCdensity(h3_low_gdp$centered_lagged_pervote_samlet, c = 0, verbose = TRUE)

##Høj GDP
# Start omdirigering af output til fil
sink("Robusthedstests/h3 tests - Appendiks/densitetstest_forskellige_bw_high_gdp.md")

# Skriv en overskrift til filen
cat("# Densitetstest med forskellige båndbredder\n\n")
cat("Test af manipulation ved tærsklen med høj gdp.\n\n")

# Kør tests for forskellige båndbredder
for(bw in seq(0.5, 3, by = 0.5)) { 
  cat("\n## Båndbredde:", bw, "\n\n") 
  test <- rddensity(h3_high_gdp$centered_lagged_pervote_samlet, h = bw) 
  print(summary(test)) 
}

# Stop omdirigering af output
sink()

cat("Output gemt i robusthedstests/h3 tests - Appendiks/densitetstest_forskellige_bw_high_gdp.md\n")

##Lav GDP
# Start omdirigering af output til fil
sink("robusthedstests/H3 tests - Appendiks/densitetstest_forskellige_bw_low_gdp.md")

# Skriv en overskrift til filen
cat("# Densitetstest med forskellige båndbredder\n\n")
cat("Test af manipulation ved tærsklen med lav gdp.\n\n")

# Kør tests for forskellige båndbredder
for(bw in seq(0.5, 3, by = 0.5)) { 
  cat("\n## Båndbredde:", bw, "\n\n") 
  test <- rddensity(h3_low_gdp$centered_lagged_pervote_samlet, h = bw) 
  print(summary(test)) 
}

# Stop omdirigering af output
sink()

cat("Output gemt i robusthedstests/h3 - Appendiks/densitetstest_forskellige_bw_low_gdp.md\n")

# For høj BNP data
alternativ_density_plot_high_gdp <- ggplot(h3_high_gdp, aes(x = centered_lagged_pervote_samlet)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, alpha = 0.5) +
  geom_density() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Density Test for Running Variable (High GDP)",
    subtitle = paste("McCrary test p-value:", round(h3_high_gdp_density_test_alternativ, 4)),
    x = "Green Party Vote Share (Centered)",
    y = "Density"
  ) +
  theme_minimal()

# For lav BNP data
alternativ_density_plot_low_gdp <- ggplot(h3_low_gdp, aes(x = centered_lagged_pervote_samlet)) +
  geom_histogram(aes(y = after_stat(density)), bins = 30, alpha = 0.5) +
  geom_density() +
  geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
  labs(
    title = "Density Test for Running Variable (Low GDP)",
    subtitle = paste("McCrary test p-value:", round(h3_low_gdp_density_test_alternativ, 4)),
    x = "Green Party Vote Share (Centered)",
    y = "Density"
  ) +
  theme_minimal()

ggsave("Robusthedstests/H3 tests - Appendiks/h3_high_gdp_density_alternativ.png", plot = alternativ_density_plot_high_gdp$Estplot, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H3 tests - Appendiks/h3_low_gdp_density_alternativ.png", plot = alternativ_density_plot_low_gdp$Estplot, width = 10, height = 6, dpi = 300)

# 3.10 Density Tests for H3 (Economic Index) ----------------
# Add McCrary density test for good economy
h3_good_economy_density_test <- rddensity(clean_data_good_economy$centered_lagged_pervote_samlet, c = 0, binoW = 0.25, binoWStep = 0.25, fitselect = "restricted", vce = "jackknife")
h3_good_economy_density_summary <- summary(h3_good_economy_density_test)
h3_good_economy_density_plot <- rdplotdensity(h3_good_economy_density_test, 
                                            clean_data_good_economy$centered_lagged_pervote_samlet,
                                            title = "H3: Density Test (Good Economic Conditions)")

# Add McCrary density test for bad economy
h3_bad_economy_density_test <- rddensity(clean_data_bad_economy$centered_lagged_pervote_samlet, c = 0, binoW = 0.25, binoWStep = 0.25, fitselect = "restricted", vce = "jackknife")
h3_bad_economy_density_summary <- summary(h3_bad_economy_density_test)
h3_bad_economy_density_plot <- rdplotdensity(h3_bad_economy_density_test, 
                                           clean_data_bad_economy$centered_lagged_pervote_samlet,
                                           title = "H3: Density Test (Poor Economic Conditions)")

summary(h3_good_economy_density_test)
summary_text <- capture.output(summary(h3_good_economy_density_test))
writeLines(summary_text, "Robusthedstests/H3 tests - Appendiks/h3_good_economy_density.md")

summary(h3_bad_economy_density_test)
summary_text <- capture.output(summary(h3_bad_economy_density_test))
writeLines(summary_text, "Robusthedstests/H3 tests - Appendiks/h3_bad_economy_density.md")

# Save density plots
ggsave("Robusthedstests/H3 tests - Appendiks/h3_good_economy_density.png", plot = h3_good_economy_density_plot$Estplot, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H3 tests - Appendiks/h3_bad_economy_density.png", plot = h3_bad_economy_density_plot$Estplot, width = 10, height = 6, dpi = 300)

##God økonomi
# Start omdirigering af output til fil
sink("robusthedstests/H3 tests - Appendiks/densitetstest_forskellige_bw_good_economy.md")

# Skriv en overskrift til filen
cat("# Densitetstest med forskellige båndbredder\n\n")
cat("Test af manipulation ved tærsklen med god økonomi.\n\n")

# Kør tests for forskellige båndbredder
for(bw in seq(0.5, 3, by = 0.5)) { 
  cat("\n## Båndbredde:", bw, "\n\n") 
  test <- rddensity(clean_data_good_economy$centered_lagged_pervote_samlet, h = bw) 
  print(summary(test)) 
}

# Stop omdirigering af output
sink()

cat("Output gemt i robusthedstests/h3 tests - Appendiks/densitetstest_forskellige_bw_good_economy.md\n")

##Bad økonomi
# Start omdirigering af output til fil
sink("robusthedstests/H3 tests - Appendiks/densitetstest_forskellige_bw_bad_economy.md")

# Skriv en overskrift til filen
cat("# Densitetstest med forskellige båndbredder\n\n")
cat("Test af manipulation ved tærsklen med dårlig økonomi.\n\n")

# Kør tests for forskellige båndbredder
for(bw in seq(0.5, 3, by = 0.5)) { 
  cat("\n## Båndbredde:", bw, "\n\n") 
  test <- rddensity(clean_data_bad_economy$centered_lagged_pervote_samlet, h = bw) 
  print(summary(test)) 
}

# Stop omdirigering af output
sink()

cat("Output gemt i robusthedstests/h3 tests - Appendiks/densitetstest_forskellige_bw_bad_economy.md\n")


# 3.11 Covariate Balance Tests for H3 (GDP Growth) ----------------
# Define covariates to check
h3_balance_covariates <- c("rile_lowe", "GDP_per_capita", "Unemployment")

# High GDP Growth
h3_high_gdp_balance_results <- data.frame(
  Covariate = character(),
  RDD_Estimate = numeric(),
  Std_Error = numeric(),
  P_value = numeric()
)

for (cov in h3_balance_covariates) {
  if (cov %in% names(h3_high_gdp)) {
    tryCatch({
      balance_check <- rdrobust(
        y = h3_high_gdp[[cov]],
        x = h3_high_gdp$centered_lagged_pervote_samlet,
        c = 0,
        p = 1,
        kernel = "triangular",
        bwselect = "mserd"
      )
      
      h3_high_gdp_balance_results <- rbind(h3_high_gdp_balance_results, data.frame(
        Covariate = cov,
        RDD_Estimate = balance_check$Estimate[1],
        Std_Error = balance_check$se[1],
        P_value = balance_check$pv[1]
      ))
    }, error = function(e) {
      cat("Error checking balance for", cov, "in high GDP growth group:", e$message, "\n")
    })
  }
}

# Low GDP Growth
h3_low_gdp_balance_results <- data.frame(
  Covariate = character(),
  RDD_Estimate = numeric(),
  Std_Error = numeric(),
  P_value = numeric()
)

for (cov in h3_balance_covariates) {
  if (cov %in% names(h3_low_gdp)) {
    tryCatch({
      balance_check <- rdrobust(
        y = h3_low_gdp[[cov]],
        x = h3_low_gdp$centered_lagged_pervote_samlet,
        c = 0,
        p = 1,
        kernel = "triangular",
        bwselect = "mserd"
      )
      
      h3_low_gdp_balance_results <- rbind(h3_low_gdp_balance_results, data.frame(
        Covariate = cov,
        RDD_Estimate = balance_check$Estimate[1],
        Std_Error = balance_check$se[1],
        P_value = balance_check$pv[1]
      ))
    }, error = function(e) {
      cat("Error checking balance for", cov, "in low GDP growth group:", e$message, "\n")
    })
  }
}

# Print and save balance test results
if (requireNamespace("knitr", quietly = TRUE)) {
  knitr::kable(h3_high_gdp_balance_results, caption = "H3: Covariate Balance Tests (High GDP Growth)")
  knitr::kable(h3_low_gdp_balance_results, caption = "H3: Covariate Balance Tests (Low GDP Growth)")
}

write.csv(h3_high_gdp_balance_results, "Robusthedstests/H3 tests - Appendiks/h3_high_gdp_balance_tests.csv", row.names = FALSE)
write.csv(h3_low_gdp_balance_results, "Robusthedstests/H3 tests - Appendiks/h3_low_gdp_balance_tests.csv", row.names = FALSE)

# 3.12 Covariate Balance Tests for H3 (Economic Index) ----------------
# Good Economy
h3_good_economy_balance_results <- data.frame(
  Covariate = character(),
  RDD_Estimate = numeric(),
  Std_Error = numeric(),
  P_value = numeric()
)

for (cov in h3_balance_covariates) {
  if (cov %in% names(clean_data_good_economy)) {
    tryCatch({
      balance_check <- rdrobust(
        y = clean_data_good_economy[[cov]],
        x = clean_data_good_economy$centered_lagged_pervote_samlet,
        c = 0,
        p = 1,
        kernel = "triangular",
        bwselect = "mserd"
      )
      
      h3_good_economy_balance_results <- rbind(h3_good_economy_balance_results, data.frame(
        Covariate = cov,
        RDD_Estimate = balance_check$Estimate[1],
        Std_Error = balance_check$se[1],
        P_value = balance_check$pv[1]
      ))
    }, error = function(e) {
      cat("Error checking balance for", cov, "in good economy group:", e$message, "\n")
    })
  }
}

# Bad Economy
h3_bad_economy_balance_results <- data.frame(
  Covariate = character(),
  RDD_Estimate = numeric(),
  Std_Error = numeric(),
  P_value = numeric()
)

for (cov in h3_balance_covariates) {
  if (cov %in% names(clean_data_bad_economy)) {
    tryCatch({
      balance_check <- rdrobust(
        y = clean_data_bad_economy[[cov]],
        x = clean_data_bad_economy$centered_lagged_pervote_samlet,
        c = 0,
        p = 1,
        kernel = "triangular",
        bwselect = "mserd"
      )
      
      h3_bad_economy_balance_results <- rbind(h3_bad_economy_balance_results, data.frame(
        Covariate = cov,
        RDD_Estimate = balance_check$Estimate[1],
        Std_Error = balance_check$se[1],
        P_value = balance_check$pv[1]
      ))
    }, error = function(e) {
      cat("Error checking balance for", cov, "in bad economy group:", e$message, "\n")
    })
  }
}

# Print and save balance test results
if (requireNamespace("knitr", quietly = TRUE)) {
  knitr::kable(h3_good_economy_balance_results, caption = "H3: Covariate Balance Tests (Good Economy)")
  knitr::kable(h3_bad_economy_balance_results, caption = "H3: Covariate Balance Tests (Bad Economy)")
}

write.csv(h3_good_economy_balance_results, "Robusthedstests/H3 tests - Appendiks/h3_good_economy_balance_tests.csv", row.names = FALSE)
write.csv(h3_bad_economy_balance_results, "Robusthedstests/H3 tests - Appendiks/h3_bad_economy_balance_tests.csv", row.names = FALSE)



# 3.23 Visual RDD Plots for H3 (GDP Growth) ----------------
# Create clear RDD plots for main paper
h3_high_gdp_rdd_plot <- plot_rdd(
  data = h3_high_gdp,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered at threshold)",
  y_label = "Climate Position",
  title = "Effect Under High GDP Growth"
)

h3_low_gdp_rdd_plot <- plot_rdd(
  data = h3_low_gdp,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered at threshold)",
  y_label = "Climate Position",
  title = "Effect Under Low GDP Growth"
)

# Save RDD plots
ggsave("Robusthedstests/H3 tests - Appendiks/h3_high_gdp_rdd_plot.png", plot = h3_high_gdp_rdd_plot, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H3 tests - Appendiks/h3_low_gdp_rdd_plot.png", plot = h3_low_gdp_rdd_plot, width = 10, height = 6, dpi = 300)

# Create zoomed-in versions for better threshold visualization
h3_high_gdp_rdd_zoom <- jump_plot_cutoff(
  data = h3_high_gdp,
  force_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  polynomial = 1,
  window = 3
)

h3_low_gdp_rdd_zoom <- jump_plot_cutoff(
  data = h3_low_gdp,
  force_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  polynomial = 1,
  window = 3
)

# Save zoomed RDD plots
ggsave("Robusthedstests/H3 tests - Appendiks/h3_high_gdp_rdd_zoom.png", plot = h3_high_gdp_rdd_zoom, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H3 tests - Appendiks/h3_low_gdp_rdd_zoom.png", plot = h3_low_gdp_rdd_zoom, width = 10, height = 6, dpi = 300)

# 3.24 Visual RDD Plots for H3 (Economic Index) ----------------
h3_good_economy_rdd_plot <- plot_rdd(
  data = clean_data_good_economy,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered at threshold)",
  y_label = "Climate Position",
  title = "Effect Under Good Economic Conditions"
)

h3_bad_economy_rdd_plot <- plot_rdd(
  data = clean_data_bad_economy,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered at threshold)",
  y_label = "Climate Position",
  title = "Effect Under Poor Economic Conditions"
)

# Save RDD plots
ggsave("Robusthedstests/H3 tests - Appendiks/h3_good_economy_rdd_plot.png", plot = h3_good_economy_rdd_plot, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H3 tests - Appendiks/h3_bad_economy_rdd_plot.png", plot = h3_bad_economy_rdd_plot, width = 10, height = 6, dpi = 300)

# Create zoomed-in versions for better threshold visualization
h3_good_economy_rdd_zoom <- jump_plot_cutoff(
  data = clean_data_good_economy,
  force_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  polynomial = 1,
  window = 3
)

h3_bad_economy_rdd_zoom <- jump_plot_cutoff(
  data = clean_data_bad_economy,
  force_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  polynomial = 1,
  window = 3
)

# Save zoomed RDD plots
ggsave("Robusthedstests/H3 tests - Appendiks/h3_good_economy_rdd_zoom.png", plot = h3_good_economy_rdd_zoom, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H3 tests - Appendiks/h3_bad_economy_rdd_zoom.png", plot = h3_bad_economy_rdd_zoom, width = 10, height = 6, dpi = 300)

# 3.25 Combined Visual Comparison for H3 ----------------
# Combine GDP growth plots in a single figure
if (requireNamespace("gridExtra", quietly = TRUE)) {
  h3_gdp_combined <- gridExtra::grid.arrange(
    h3_high_gdp_rdd_plot, h3_low_gdp_rdd_plot,
    ncol = 2,
    top = "H3: Effect of Green Party Entry by GDP Growth"
  )
  
  h3_economy_combined <- gridExtra::grid.arrange(
    h3_good_economy_rdd_plot, h3_bad_economy_rdd_plot,
    ncol = 2,
    top = "H3: Effect of Green Party Entry by Economic Conditions"
  )
  
  # Save combined plots
  ggsave("Robusthedstests/H3 tests - Appendiks/h3_gdp_combined.png", plot = h3_gdp_combined, width = 12, height = 6, dpi = 300)
  ggsave("Robusthedstests/H3 tests - Appendiks/h3_economy_combined.png", plot = h3_economy_combined, width = 12, height = 6, dpi = 300)
}

# 3.26 Outcome Placebo Tests for H3 (GDP Growth) ----------------
# Using variables that shouldn't be affected by treatment
placebo_vars <- c("rile_lowe", "per410") 

# High GDP Growth
h3_high_gdp_outcome_placebo <- run_outcome_placebo_test(
  data = h3_high_gdp,
  real_outcome_var = "miljø_afhængig",
  placebo_outcome_vars = placebo_vars,
  running_var = "centered_lagged_pervote_samlet",
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)

h3_high_gdp_outcome_placebo_plot <- plot_outcome_placebo_test(
  h3_high_gdp_outcome_placebo,
  title = "H3: Outcome Placebo Test (High GDP Growth)"
)

# Low GDP Growth
h3_low_gdp_outcome_placebo <- run_outcome_placebo_test(
  data = h3_low_gdp,
  real_outcome_var = "miljø_afhængig",
  placebo_outcome_vars = placebo_vars,
  running_var = "centered_lagged_pervote_samlet",
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)

h3_low_gdp_outcome_placebo_plot <- plot_outcome_placebo_test(
  h3_low_gdp_outcome_placebo,
  title = "H3: Outcome Placebo Test (Low GDP Growth)"
)

# Save outcome placebo plots
ggsave("Robusthedstests/H3 tests - Appendiks/h3_high_gdp_outcome_placebo.png", plot = h3_high_gdp_outcome_placebo_plot, width = 8, height = 6, dpi = 300)
ggsave("Robusthedstests/H3 tests - Appendiks/h3_low_gdp_outcome_placebo.png", plot = h3_low_gdp_outcome_placebo_plot, width = 8, height = 6, dpi = 300)


# Korrekt oprettet sammenligning af økonomiske betingelser
# Kør hver rdrobust separat og fang eventuelle fejl
high_gdp_rdd <- tryCatch(rdrobust(
  y = h3_high_gdp$miljø_afhængig,
  x = h3_high_gdp$centered_lagged_pervote_samlet,
  c = 0, p = 1, h = 2, kernel = "triangular"
), error = function(e) {
  cat("Fejl i High GDP RDD:", e$message, "\n")
  return(NULL)
})

low_gdp_rdd <- tryCatch(rdrobust(
  y = h3_low_gdp$miljø_afhængig,
  x = h3_low_gdp$centered_lagged_pervote_samlet,
  c = 0, p = 1, h = 2, kernel = "triangular"
), error = function(e) {
  cat("Fejl i Low GDP RDD:", e$message, "\n")
  return(NULL)
})

good_economy_rdd <- tryCatch(rdrobust(
  y = clean_data_good_economy$miljø_afhængig,
  x = clean_data_good_economy$centered_lagged_pervote_samlet,
  c = 0, p = 1, h = 2, kernel = "triangular"
), error = function(e) {
  cat("Fejl i Good Economy RDD:", e$message, "\n")
  return(NULL)
})

bad_economy_rdd <- tryCatch(rdrobust(
  y = clean_data_bad_economy$miljø_afhængig,
  x = clean_data_bad_economy$centered_lagged_pervote_samlet,
  c = 0, p = 1, h = 2, kernel = "triangular"
), error = function(e) {
  cat("Fejl i Bad Economy RDD:", e$message, "\n")
  return(NULL)
})

# Tjek resultaterne
cat("High GDP RDD:", ifelse(!is.null(high_gdp_rdd), "Succes", "Fejl"), "\n")
cat("Low GDP RDD:", ifelse(!is.null(low_gdp_rdd), "Succes", "Fejl"), "\n")
cat("Good Economy RDD:", ifelse(!is.null(good_economy_rdd), "Succes", "Fejl"), "\n")
cat("Bad Economy RDD:", ifelse(!is.null(bad_economy_rdd), "Succes", "Fejl"), "\n")

# Opret en tom dataframe til at begynde med
h3_comparison_data <- data.frame(
  Condition = character(),
  Estimate = numeric(),
  SE = numeric(),
  P_value = numeric(),
  stringsAsFactors = FALSE
)

# Tilføj resultater fra high GDP RDD hvis det fungerede
if (!is.null(high_gdp_rdd)) {
  h3_comparison_data <- rbind(h3_comparison_data, data.frame(
    Condition = "High GDP Growth",
    Estimate = high_gdp_rdd$Estimate[1],
    SE = high_gdp_rdd$se[1],
    P_value = high_gdp_rdd$pv[1],
    stringsAsFactors = FALSE
  ))
}

# Tilføj resultater fra low GDP RDD hvis det fungerede
if (!is.null(low_gdp_rdd)) {
  h3_comparison_data <- rbind(h3_comparison_data, data.frame(
    Condition = "Low GDP Growth",
    Estimate = low_gdp_rdd$Estimate[1],
    SE = low_gdp_rdd$se[1],
    P_value = low_gdp_rdd$pv[1],
    stringsAsFactors = FALSE
  ))
}

# Tilføj resultater fra good economy RDD hvis det fungerede
if (!is.null(good_economy_rdd)) {
  h3_comparison_data <- rbind(h3_comparison_data, data.frame(
    Condition = "Good Economy",
    Estimate = good_economy_rdd$Estimate[1],
    SE = good_economy_rdd$se[1],
    P_value = good_economy_rdd$pv[1],
    stringsAsFactors = FALSE
  ))
}

# Tilføj resultater fra bad economy RDD hvis det fungerede
if (!is.null(bad_economy_rdd)) {
  h3_comparison_data <- rbind(h3_comparison_data, data.frame(
    Condition = "Poor Economy",
    Estimate = bad_economy_rdd$Estimate[1],
    SE = bad_economy_rdd$se[1],
    P_value = bad_economy_rdd$pv[1],
    stringsAsFactors = FALSE
  ))
}

# Vis antal rækker i den endelige dataframe
cat("Antal rækker i h3_comparison_data:", nrow(h3_comparison_data), "\n")

# Beregn 95% konfidensintervaller
h3_comparison_data$CI_lower <- h3_comparison_data$Estimate - 1.96 * h3_comparison_data$SE
h3_comparison_data$CI_upper <- h3_comparison_data$Estimate + 1.96 * h3_comparison_data$SE

# Tilføj signifikansmarkør
h3_comparison_data$Significance <- ifelse(h3_comparison_data$P_value < 0.05, "*", 
                                        ifelse(h3_comparison_data$P_value < 0.1, "†", ""))

# Formater resultater for pæn visning
h3_comparison_data$Result <- sprintf("%.3f%s (%.3f)",
                                   h3_comparison_data$Estimate,
                                   h3_comparison_data$Significance,
                                   h3_comparison_data$SE)

# Vis den pæne tabel
if (requireNamespace("knitr", quietly = TRUE)) {
  print(knitr::kable(h3_comparison_data[, c("Condition", "Result", "P_value", "CI_lower", "CI_upper")],
                    caption = "H3: Sammenligning af effekter på tværs af økonomiske betingelser",
                    digits = 3))
}

# Skab en visuel sammenligning hvis der er resultater
if (nrow(h3_comparison_data) > 0) {
  # Create dot-whisker plot
  h3_comparison_plot <- ggplot(h3_comparison_data, aes(x = Estimate, y = Condition)) +
    geom_point(size = 3) +
    geom_errorbarh(aes(xmin = CI_lower, xmax = CI_upper), height = 0.2) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
    labs(
      title = "H3: Behandlingseffekter på tværs af økonomiske betingelser",
      x = "Estimeret effekt (med 95% CI)",
      y = ""
    ) +
    theme_minimal()
  
  # Gem sammenlignende plot
  ggsave("Robusthedstests/H3 tests - Appendiks/h3_treatment_effects_comparison.png", plot = h3_comparison_plot, width = 10, height = 6, dpi = 300)
  
  # Vis plottet i R
  print(h3_comparison_plot)
} else {
  cat("Ingen resultater at plotte\n")
}

# ============================================================================
# 4. H4: PARTY IDEOLOGY EFFECT
# ============================================================================
# Opret først hovedmappen Robusthedstests, hvis den ikke allerede eksisterer
dir.create("Robusthedstests", showWarnings = FALSE)

# Opret derefter undermappen H4 tests - Appendiks
dir.create("Robusthedstests/H4 tests - Appendiks", showWarnings = FALSE)

# 4.2 Coefficient Stability Plots for H4 ----------------
left_party_stability_plot <- create_coefficient_stability_plot(
  data = clean_data_left_party,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomials = c(1, 2, 3),
  covariates = c("country", "edate"),
  title = "H4: Effect on Left-wing Parties"
)

right_party_stability_plot <- create_coefficient_stability_plot(
  data = clean_data_right_party,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomials = c(1, 2, 3),
  covariates = c("country", "edate"),
  title = "H4: Effect on Right-wing Parties"
)

# Save plots
pdf("h4_left_party_stability.pdf", width = 10, height = 6)
print(left_party_stability_plot$plot)
dev.off()

pdf("h4_right_party_stability.pdf", width = 10, height = 6)
print(right_party_stability_plot$plot)
dev.off()

# 4.3 Direct Comparison of Party Ideology Effects ----------------
h4_ideology_comparison_plot <- compare_coefficient_stability(
  data_list = list(clean_data_left_party, clean_data_right_party),
  labels = c("Left-wing Parties", "Right-wing Parties"),
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomial = 1,
  covariates = c("country", "edate"),
  title = "H4: Effect of Green Parties Moderated by Party Ideology"
)

# Save comparison plot
ggsave("Robusthedstests/H4 tests - Appendiks/h4_ideology_comparison.png", plot = h4_ideology_comparison_plot, width = 10, height = 6, dpi = 300)

# 4.4 Multi-polynomial Comparisons ----------------
# Ideology with different polynomial orders
h4_comparison_plot_p1 <- compare_coefficient_stability(
  data_list = list(clean_data_left_party, clean_data_right_party),
  labels = c("Left-wing Parties", "Right-wing Parties"),
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomial = 1,
  covariates = c("country", "edate"),
  title = "H4: Effect of Green Parties (Polynomial Order 1)"
)

h4_comparison_plot_p2 <- compare_coefficient_stability(
  data_list = list(clean_data_left_party, clean_data_right_party),
  labels = c("Left-wing Parties", "Right-wing Parties"),
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomial = 2,
  covariates = c("country", "edate"),
  title = "H4: Effect of Green Parties (Polynomial Order 2)"
)

# Combine plots in grid if gridExtra is available
if (requireNamespace("gridExtra", quietly = TRUE)) {
  ideology_poly_comparison <- gridExtra::grid.arrange(
    h4_comparison_plot_p1, h4_comparison_plot_p2,
    ncol = 2,
    top = "H4: Effect of Green Parties Moderated by Party Ideology"
  )
  
  # Save the combined plot
  ggsave("Robusthedstests/H4 tests - Appendiks/h4_ideology_polynomial_comparison.png", ideology_poly_comparison, width = 12, height = 6, dpi = 300)
}

# 4.5 Placebo Threshold Tests for H4 (Party Ideology) ----------------
h4_left_placebo <- run_placebo_threshold_test(
  data = clean_data_left_party,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  true_cutpoint = 0,
  placebo_range = c(-4, 4),
  placebo_step = 0.5,
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)

h4_right_placebo <- run_placebo_threshold_test(
  data = clean_data_right_party,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  true_cutpoint = 0,
  placebo_range = c(-4, 4),
  placebo_step = 0.5,
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)

# Plot placebo results
h4_left_placebo_plot <- plot_placebo_threshold_test(
  h4_left_placebo,
  title = "H4: Placebo Test (Left-wing Parties)"
)

h4_right_placebo_plot <- plot_placebo_threshold_test(
  h4_right_placebo,
  title = "H4: Placebo Test (Right-wing Parties)"
)

# Save placebo plots
ggsave("Robusthedstests/H4 tests - Appendiks/h4_left_placebo.png", plot = h4_left_placebo_plot, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H4 tests - Appendiks/h4_right_placebo.png", plot = h4_right_placebo_plot, width = 10, height = 6, dpi = 300)

# 4.6 Density Tests for H4 (Party Ideology) ----------------
# Add McCrary density test for left-wing parties
h4_left_density_test <- rddensity(clean_data_left_party$centered_lagged_pervote_samlet, c = 0, binoW = 0.25, binoWStep = 0.25, fitselect = "restricted", vce = "jackknife")
h4_left_density_summary <- summary(h4_left_density_test)
h4_left_density_plot <- rdplotdensity(h4_left_density_test, 
                                    clean_data_left_party$centered_lagged_pervote_samlet,
                                    title = "H4: Density Test (Left-wing Parties)")

# Add McCrary density test for right-wing parties
h4_right_density_test <- rddensity(clean_data_right_party$centered_lagged_pervote_samlet, c = 0, binoW = 0.25, binoWStep = 0.25, fitselect = "restricted", vce = "jackknife")
h4_right_density_summary <- summary(h4_right_density_test)
h4_right_density_plot <- rdplotdensity(h4_right_density_test, 
                                     clean_data_right_party$centered_lagged_pervote_samlet,
                                     title = "H4: Density Test (Right-wing Parties)")

summary(h4_left_density_test)
summary_text <- capture.output(summary(h4_left_density_test))
writeLines(summary_text, "Robusthedstests/H4 tests - Appendiks/h4_left_density.md")

summary(h4_right_density_test)
summary_text <- capture.output(summary(h4_right_density_test))
writeLines(summary_text, "Robusthedstests/H4 tests - Appendiks/h4_right_density.md")

# Save density plots
ggsave("Robusthedstests/H4 tests - Appendiks/h4_left_density.png", plot = h4_left_density_plot$Estplot, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H4 tests - Appendiks/h4_right_density.png", plot = h4_right_density_plot$Estplot, width = 10, height = 6, dpi = 300)

# 4.7 Covariate Balance Tests for H4 (Party Ideology) ----------------
# Define covariates to check
h4_balance_covariates <- c("rile_lowe", "GDP_per_capita", "Unemployment", "avg_pervote_main")

# Left-wing Parties
h4_left_balance_results <- data.frame(
  Covariate = character(),
  RDD_Estimate = numeric(),
  Std_Error = numeric(),
  P_value = numeric()
)

for (cov in h4_balance_covariates) {
  if (cov %in% names(clean_data_left_party)) {
    tryCatch({
      balance_check <- rdrobust(
        y = clean_data_left_party[[cov]],
        x = clean_data_left_party$centered_lagged_pervote_samlet,
        c = 0,
        p = 1,
        kernel = "triangular",
        bwselect = "mserd"
      )
      
      h4_left_balance_results <- rbind(h4_left_balance_results, data.frame(
        Covariate = cov,
        RDD_Estimate = balance_check$Estimate[1],
        Std_Error = balance_check$se[1],
        P_value = balance_check$pv[1]
      ))
    }, error = function(e) {
      cat("Error checking balance for", cov, "in left-wing parties:", e$message, "\n")
    })
  }
}

# Right-wing Parties
h4_right_balance_results <- data.frame(
  Covariate = character(),
  RDD_Estimate = numeric(),
  Std_Error = numeric(),
  P_value = numeric()
)

for (cov in h4_balance_covariates) {
  if (cov %in% names(clean_data_right_party)) {
    tryCatch({
      balance_check <- rdrobust(
        y = clean_data_right_party[[cov]],
        x = clean_data_right_party$centered_lagged_pervote_samlet,
        c = 0,
        p = 1,
        kernel = "triangular",
        bwselect = "mserd"
      )
      
      h4_right_balance_results <- rbind(h4_right_balance_results, data.frame(
        Covariate = cov,
        RDD_Estimate = balance_check$Estimate[1],
        Std_Error = balance_check$se[1],
        P_value = balance_check$pv[1]
      ))
    }, error = function(e) {
      cat("Error checking balance for", cov, "in right-wing parties:", e$message, "\n")
    })
  }
}

# Print and save balance test results
if (requireNamespace("knitr", quietly = TRUE)) {
  knitr::kable(h4_left_balance_results, caption = "H4: Covariate Balance Tests (Left-wing Parties)")
  knitr::kable(h4_right_balance_results, caption = "H4: Covariate Balance Tests (Right-wing Parties)")
}

write.csv(h4_left_balance_results, "Robusthedstests/H4 tests - Appendiks/h4_left_balance_tests.csv", row.names = FALSE)
write.csv(h4_right_balance_results, "Robusthedstests/H4 tests - Appendiks/h4_right_balance_tests.csv", row.names = FALSE)

# 4.13 Visual RDD Plots for H4 (Party Ideology) ----------------
# Create clear RDD plots for main paper
h4_left_rdd_plot <- plot_rdd(
  data = clean_data_left_party,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered at threshold)",
  y_label = "Climate Position",
  title = "Effect on Left-wing Parties"
)

h4_right_rdd_plot <- plot_rdd(
  data = clean_data_right_party,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered at threshold)",
  y_label = "Climate Position",
  title = "Effect on Right-wing Parties"
)

# Save RDD plots
ggsave("Robusthedstests/H4 tests - Appendiks/h4_left_rdd_plot.png", plot = h4_left_rdd_plot, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H4 tests - Appendiks/h4_right_rdd_plot.png", plot = h4_right_rdd_plot, width = 10, height = 6, dpi = 300)

# Create zoomed-in versions for better threshold visualization
h4_left_rdd_zoom <- jump_plot_cutoff(
  data = clean_data_left_party,
  force_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  polynomial = 1,
  window = 3
)

h4_right_rdd_zoom <- jump_plot_cutoff(
  data = clean_data_right_party,
  force_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  polynomial = 1,
  window = 3
)

# Save zoomed RDD plots
ggsave("Robusthedstests/H4 tests - Appendiks/h4_left_rdd_zoom.png", plot = h4_left_rdd_zoom, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H4 tests - Appendiks/h4_right_rdd_zoom.png", plot = h4_right_rdd_zoom, width = 10, height = 6, dpi = 300)

# 4.14 Combined Visual Comparison for H4 ----------------
# Combine ideology plots in a single figure
if (requireNamespace("gridExtra", quietly = TRUE)) {
  h4_ideology_combined <- gridExtra::grid.arrange(
    h4_left_rdd_plot, h4_right_rdd_plot,
    ncol = 2,
    top = "H4: Effect of Green Party Entry by Party Ideology"
  )
  
  # Save combined plots
  ggsave("Robusthedstests/H4 tests - Appendiks/h4_ideology_combined.png", plot = h4_ideology_combined, width = 12, height = 6, dpi = 300)
}

# 4.15 Outcome Placebo Tests for H4 (Party Ideology) ----------------
# Using variables that shouldn't be affected by treatment
placebo_vars <- c("rile_lowe", "per410") 

# Left-wing Parties
h4_left_outcome_placebo <- run_outcome_placebo_test(
  data = clean_data_left_party,
  real_outcome_var = "miljø_afhængig",
  placebo_outcome_vars = placebo_vars,
  running_var = "centered_lagged_pervote_samlet",
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)

h4_left_outcome_placebo_plot <- plot_outcome_placebo_test(
  h4_left_outcome_placebo,
  title = "H4: Outcome Placebo Test (Left-wing Parties)"
)

# Right-wing Parties
h4_right_outcome_placebo <- run_outcome_placebo_test(
  data = clean_data_right_party,
  real_outcome_var = "miljø_afhængig",
  placebo_outcome_vars = placebo_vars,
  running_var = "centered_lagged_pervote_samlet",
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)

h4_right_outcome_placebo_plot <- plot_outcome_placebo_test(
  h4_right_outcome_placebo,
  title = "H4: Outcome Placebo Test (Right-wing Parties)"
)

# Save outcome placebo plots
ggsave("Robusthedstests/H4 tests - Appendiks/h4_left_outcome_placebo.png", plot = h4_left_outcome_placebo_plot, width = 8, height = 6, dpi = 300)
ggsave("Robusthedstests/H4 tests - Appendiks/h4_right_outcome_placebo.png", plot = h4_right_outcome_placebo_plot, width = 8, height = 6, dpi = 300)

# 4.16 Summary of Test Results for H4 ----------------
# Create summary table of all H4 test results
# Kør hver rdrobust separat først
left_wing_rdd <- tryCatch(rdrobust(
  y = clean_data_left_party$miljø_afhængig,
  x = clean_data_left_party$centered_lagged_pervote_samlet,
  c = 0, p = 1, h = 2, kernel = "triangular"
), error = function(e) {
  cat("Fejl i Left-wing Parties RDD:", e$message, "\n")
  return(NULL)
})

right_wing_rdd <- tryCatch(rdrobust(
  y = clean_data_right_party$miljø_afhængig,
  x = clean_data_right_party$centered_lagged_pervote_samlet,
  c = 0, p = 1, h = 2, kernel = "triangular"
), error = function(e) {
  cat("Fejl i Right-wing Parties RDD:", e$message, "\n")
  return(NULL)
})

# Tjek om analyserne lykkedes
cat("Left-wing RDD:", ifelse(!is.null(left_wing_rdd), "Succes", "Fejl"), "\n")
cat("Right-wing RDD:", ifelse(!is.null(right_wing_rdd), "Succes", "Fejl"), "\n")

# Opret summary tabel med sikker håndtering af resultater
h4_test_summary <- data.frame(
  Subgroup = c("Left-wing Parties", "Right-wing Parties"),
  Main_RDD_Effect = c(
    ifelse(!is.null(left_wing_rdd), 
           sprintf("%.3f (p=%.3f)", left_wing_rdd$Estimate[1], left_wing_rdd$pv[1]), 
           "N/A"),
    ifelse(!is.null(right_wing_rdd), 
           sprintf("%.3f (p=%.3f)", right_wing_rdd$Estimate[1], right_wing_rdd$pv[1]), 
           "N/A")
  ),
  Placebo_p_value = c(
    ifelse(exists("h4_left_placebo") && !is.null(h4_left_placebo$empirical_p_value), 
           h4_left_placebo$empirical_p_value, NA),
    ifelse(exists("h4_right_placebo") && !is.null(h4_right_placebo$empirical_p_value), 
           h4_right_placebo$empirical_p_value, NA)
  ),
  Density_p_value = c(
    ifelse(exists("h4_left_density_summary") && !is.null(h4_left_density_summary$p_value), 
           h4_left_density_summary$p_value, NA),
    ifelse(exists("h4_right_density_summary") && !is.null(h4_right_density_summary$p_value), 
           h4_right_density_summary$p_value, NA)
  )
)

# Tilføj additional kolonner som f.eks. Permutation_p_value hvis de findes
if (exists("h4_left_permutation") && exists("h4_right_permutation")) {
  h4_test_summary$Permutation_p_value <- c(
    ifelse(!is.null(h4_left_permutation$p_value_effect), h4_left_permutation$p_value_effect, NA),
    ifelse(!is.null(h4_right_permutation$p_value_effect), h4_right_permutation$p_value_effect, NA)
  )
}

# Print og gem summary tabel
if (requireNamespace("knitr", quietly = TRUE)) {
  print(knitr::kable(h4_test_summary, 
                    caption = "H4: Summary of Test Results by Party Ideology"))
}

write.csv(h4_test_summary, "Robusthedstests/H4 tests - Appendiks/h4_test_summary.csv", row.names = FALSE)

# Opret også et dot-whisker plot for sammenligning hvis RDD'erne var succesfulde
if (!is.null(left_wing_rdd) || !is.null(right_wing_rdd)) {
  # Forbered data
  h4_comparison_data <- data.frame(
    Ideology = character(),
    Estimate = numeric(),
    SE = numeric(),
    stringsAsFactors = FALSE
  )
  
  # Tilføj resultater, hvis de findes
  if (!is.null(left_wing_rdd)) {
    h4_comparison_data <- rbind(h4_comparison_data, data.frame(
      Ideology = "Left-wing Parties",
      Estimate = left_wing_rdd$Estimate[1],
      SE = left_wing_rdd$se[1],
      stringsAsFactors = FALSE
    ))
  }
  
  if (!is.null(right_wing_rdd)) {
    h4_comparison_data <- rbind(h4_comparison_data, data.frame(
      Ideology = "Right-wing Parties",
      Estimate = right_wing_rdd$Estimate[1],
      SE = right_wing_rdd$se[1],
      stringsAsFactors = FALSE
    ))
  }
  
  # Beregn konfidensintervaller
  h4_comparison_data$CI_lower <- h4_comparison_data$Estimate - 1.96 * h4_comparison_data$SE
  h4_comparison_data$CI_upper <- h4_comparison_data$Estimate + 1.96 * h4_comparison_data$SE
  
  # Skab dot-whisker plot
  h4_comparison_plot <- ggplot(h4_comparison_data, aes(x = Estimate, y = Ideology)) +
    geom_point(size = 3) +
    geom_errorbarh(aes(xmin = CI_lower, xmax = CI_upper), height = 0.2) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
    labs(
      title = "H4: Treatment Effects by Party Ideology",
      x = "Estimated Effect (with 95% CI)",
      y = ""
    ) +
    theme_minimal()
  
  # Gem plot
  ggsave("Robusthedstests/H4 tests - Appendiks/h4_treatment_effects_comparison.png", plot = h4_comparison_plot, width = 10, height = 6, dpi = 300)
  
  # Vis plottet
  print(h4_comparison_plot)
}

# 4.17 Compare treatment effects across ideologies ----------------
# Kør hver rdrobust separat og fang eventuelle fejl
if (!exists("left_wing_rdd")) {
  left_wing_rdd <- tryCatch(rdrobust(
    y = clean_data_left_party$miljø_afhængig,
    x = clean_data_left_party$centered_lagged_pervote_samlet,
    c = 0, p = 1, h = 2, kernel = "triangular"
  ), error = function(e) {
    cat("Fejl i Left-wing Parties RDD:", e$message, "\n")
    return(NULL)
  })
}

if (!exists("right_wing_rdd")) {
  right_wing_rdd <- tryCatch(rdrobust(
    y = clean_data_right_party$miljø_afhængig,
    x = clean_data_right_party$centered_lagged_pervote_samlet,
    c = 0, p = 1, h = 2, kernel = "triangular"
  ), error = function(e) {
    cat("Fejl i Right-wing Parties RDD:", e$message, "\n")
    return(NULL)
  })
}

# Tjek om analyserne lykkedes
cat("Left-wing RDD:", ifelse(!is.null(left_wing_rdd), "Succes", "Fejl"), "\n")
cat("Right-wing RDD:", ifelse(!is.null(right_wing_rdd), "Succes", "Fejl"), "\n")

# Opret en tom dataframe til at begynde med
h4_comparison_data <- data.frame(
  Ideology = character(),
  Estimate = numeric(),
  SE = numeric(),
  stringsAsFactors = FALSE
)

# Tilføj resultater fra left-wing RDD hvis det fungerede
if (!is.null(left_wing_rdd)) {
  h4_comparison_data <- rbind(h4_comparison_data, data.frame(
    Ideology = "Left-wing Parties",
    Estimate = left_wing_rdd$Estimate[1],
    SE = left_wing_rdd$se[1],
    stringsAsFactors = FALSE
  ))
}

# Tilføj resultater fra right-wing RDD hvis det fungerede
if (!is.null(right_wing_rdd)) {
  h4_comparison_data <- rbind(h4_comparison_data, data.frame(
    Ideology = "Right-wing Parties",
    Estimate = right_wing_rdd$Estimate[1],
    SE = right_wing_rdd$se[1],
    stringsAsFactors = FALSE
  ))
}

# Vis antal rækker i den endelige dataframe
cat("Antal rækker i h4_comparison_data:", nrow(h4_comparison_data), "\n")

# Kun fortsæt hvis der er data at arbejde med
if (nrow(h4_comparison_data) > 0) {
  # Beregn 95% konfidensintervaller
  h4_comparison_data$CI_lower <- h4_comparison_data$Estimate - 1.96 * h4_comparison_data$SE
  h4_comparison_data$CI_upper <- h4_comparison_data$Estimate + 1.96 * h4_comparison_data$SE
  
  # Tilføj p-værdier
  h4_comparison_data$P_value <- c(
    if (!is.null(left_wing_rdd) && "Left-wing Parties" %in% h4_comparison_data$Ideology) left_wing_rdd$pv[1] else NA,
    if (!is.null(right_wing_rdd) && "Right-wing Parties" %in% h4_comparison_data$Ideology) right_wing_rdd$pv[1] else NA
  )[match(h4_comparison_data$Ideology, c("Left-wing Parties", "Right-wing Parties"))]
  
  # Tilføj signifikansmarkør
  h4_comparison_data$Significance <- ifelse(h4_comparison_data$P_value < 0.05, "*", 
                                          ifelse(h4_comparison_data$P_value < 0.1, "†", ""))
  
  # Formater resultater for pæn visning
  h4_comparison_data$Result <- sprintf("%.3f%s (%.3f)",
                                     h4_comparison_data$Estimate,
                                     h4_comparison_data$Significance,
                                     h4_comparison_data$SE)
  
  # Vis den pæne tabel
  if (requireNamespace("knitr", quietly = TRUE)) {
    print(knitr::kable(h4_comparison_data[, c("Ideology", "Result", "P_value", "CI_lower", "CI_upper")],
                      caption = "H4: Sammenligning af effekter på tværs af partiideologi",
                      digits = 3))
  }
  
  # Opret dot-whisker plot - ret variabelnavnet fra 'Condition' til 'Ideology'
  h4_comparison_plot <- ggplot(h4_comparison_data, aes(x = Estimate, y = Ideology)) +
    geom_point(size = 3) +
    geom_errorbarh(aes(xmin = CI_lower, xmax = CI_upper), height = 0.2) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
    labs(
      title = "H4: Treatment Effects by Party Ideology",
      x = "Estimated Effect (with 95% CI)",
      y = ""
    ) +
    theme_minimal()
  
  # Gem sammenlignende plot
  ggsave("Robusthedstests/H4 tests - Appendiks/h4_treatment_effects_comparison.png", plot = h4_comparison_plot, width = 10, height = 6, dpi = 300)
  
  # Vis plottet
  print(h4_comparison_plot)
} else {
  cat("Ingen resultater at vise eller plotte for H4 sammenligning\n")
}

# ============================================================================
# 5. H5: PARTY SIZE EFFECT
# ============================================================================
# Opret først hovedmappen Robusthedstests, hvis den ikke allerede eksisterer
dir.create("Robusthedstests", showWarnings = FALSE)

# Opret derefter undermappen H4 tests - Appendiks
dir.create("Robusthedstests/H5 tests - Appendiks", showWarnings = FALSE)

# 5.1 Coefficient Stability Plots for H5 ----------------
large_party_stability_plot <- create_coefficient_stability_plot(
  data = large_parties,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomials = c(1, 2, 3),
  covariates = c("country", "edate"),
  title = "H5: Effect on Large Parties"
)

small_party_stability_plot <- create_coefficient_stability_plot(
  data = small_parties,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomials = c(1, 2, 3),
  covariates = c("country", "edate"),
  title = "H5: Effect on Small Parties"
)

# Save plots
pdf("Robusthedstests/H5 tests - Appendiks/h5_large_party_stability_plot.pdf", width = 10, height = 6)
print(large_party_stability_plot$plot)
dev.off()

pdf("Robusthedstests/H5 tests - Appendiks/h5_small_party_stability.pdf", width = 10, height = 6)
print(small_party_stability_plot$plot)
dev.off()

# 5.2 Prepare Data for H5 ----------------
h5_size_comparison_plot <- compare_coefficient_stability(
  data_list = list(large_parties, small_parties),
  labels = c("Large Parties", "Small Parties"),
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomial = 1,
  covariates = c("country", "edate"),
  title = "H4: Effect of Green Parties Moderated by Party Size"
)

# Save comparison plot
ggsave("Robusthedstests/H5 tests - Appendiks/h5_size_comparison.png", plot = h4_ideology_comparison_plot, width = 10, height = 6, dpi = 300)

# 5.4 Multi-polynomial Comparisons ----------------
# Ideology with different polynomial orders
h5_comparison_plot_p1 <- compare_coefficient_stability(
  data_list = list(large_parties, small_parties),
  labels = c("Large Parties", "Small Parties"),
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomial = 1,
  covariates = c("country", "edate"),
  title = "H5: Effect of Green Parties (Polynomial Order 1)"
)

h5_comparison_plot_p2 <- compare_coefficient_stability(
  data_list = list(large_parties, small_parties),
  labels = c("Large Parties", "Small Parties"),
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  bw_list = seq(1, 3, by = 0.5),
  polynomial = 2,
  covariates = c("country", "edate"),
  title = "H5: Effect of Green Parties (Polynomial Order 2)"
)

# Combine plots in grid if gridExtra is available
if (requireNamespace("gridExtra", quietly = TRUE)) {
  size_poly_comparison <- gridExtra::grid.arrange(
    h5_comparison_plot_p1, h5_comparison_plot_p2,
    ncol = 2,
    top = "H5: Effect of Green Parties Moderated by Party Size"
  )
  
  # Save the combined plot
  ggsave("Robusthedstests/H5 tests - Appendiks/h5_size_polynomial_comparison.png", ideology_poly_comparison, width = 12, height = 6, dpi = 300)
}

# 5.5 Placebo Threshold Tests for H5 (Party Size) ----------------
h5_large_placebo <- run_placebo_threshold_test(
  data = large_parties,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  true_cutpoint = 0,
  placebo_range = c(-4, 4),
  placebo_step = 0.5,
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)

h5_small_placebo <- run_placebo_threshold_test(
  data = small_parties,
  outcome_var = "miljø_afhængig",
  running_var = "centered_lagged_pervote_samlet",
  true_cutpoint = 0,
  placebo_range = c(-4, 4),
  placebo_step = 0.5,
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)

# Plot placebo results
h5_large_placebo_plot <- plot_placebo_threshold_test(
  h5_large_placebo,
  title = "H5: Placebo Test (Large Parties)"
)

h5_small_placebo_plot <- plot_placebo_threshold_test(
  h5_small_placebo,
  title = "H5: Placebo Test (Small Parties)"
)

# Save placebo plots
ggsave("Robusthedstests/H5 tests - Appendiks/h5_large_placebo_plot.png", plot = h5_large_placebo_plot, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H5 tests - Appendiks/h5_small_placebo_plot.png", plot = h5_small_placebo_plot, width = 10, height = 6, dpi = 300)

# 5.6 Density Tests for H5 (Party Size) ----------------
# Add McCrary density test for large parties
h5_large_density_test <- rddensity(large_parties$centered_lagged_pervote_samlet, c = 0, binoW = 0.25, binoWStep = 0.25, fitselect = "restricted", vce = "jackknife")
h5_large_density_summary <- summary(h5_large_density_test)
h5_large_density_plot <- rdplotdensity(h5_large_density_test, 
                                    large_parties$centered_lagged_pervote_samlet,
                                    title = "H5: Density Test (Large Parties)")

# Add McCrary density test for right-wing parties
h5_small_density_test <- rddensity(small_parties$centered_lagged_pervote_samlet, c = 0, binoW = 0.25, binoWStep = 0.25, fitselect = "restricted", vce = "jackknife")
h5_small_density_summary <- summary(h5_small_density_test)
h5_small_density_plot <- rdplotdensity(h5_small_density_test, 
                                     small_parties$centered_lagged_pervote_samlet,
                                     title = "H5: Density Test (Small Parties)")

summary(h5_large_density_test)
summary_text <- capture.output(summary(h5_large_density_test))
writeLines(summary_text, "Robusthedstests/H5 tests - Appendiks/h5_large_density.md")

summary(h5_small_density_test)
summary_text <- capture.output(summary(h5_small_density_test))
writeLines(summary_text, "Robusthedstests/H5 tests - Appendiks/h5_small_density.md")

# Save density plots
ggsave("Robusthedstests/H5 tests - Appendiks/h5_large_density.png", plot = h5_large_density_plot$Estplot, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H5 tests - Appendiks/h5_small_density.png", plot = h5_small_density_plot$Estplot, width = 10, height = 6, dpi = 300)

# 5.7 Covariate Balance Tests for H5 (Party Size) ----------------
# Define covariates to check
h5_balance_covariates <- c("rile_lowe", "avg_pervote_main")

# Left-wing Parties
h5_large_balance_results <- data.frame(
  Covariate = character(),
  RDD_Estimate = numeric(),
  Std_Error = numeric(),
  P_value = numeric()
)

for (cov in h5_balance_covariates) {
  if (cov %in% names(large_parties)) {
    tryCatch({
      balance_check <- rdrobust(
        y = large_parties[[cov]],
        x = large_parties$centered_lagged_pervote_samlet,
        c = 0,
        p = 1,
        kernel = "triangular",
        bwselect = "mserd"
      )
      
      h4_left_balance_results <- rbind(h5_large_balance_results, data.frame(
        Covariate = cov,
        RDD_Estimate = balance_check$Estimate[1],
        Std_Error = balance_check$se[1],
        P_value = balance_check$pv[1]
      ))
    }, error = function(e) {
      cat("Error checking balance for", cov, "in large parties:", e$message, "\n")
    })
  }
}

# Right-wing Parties
h5_small_balance_results <- data.frame(
  Covariate = character(),
  RDD_Estimate = numeric(),
  Std_Error = numeric(),
  P_value = numeric()
)

for (cov in h5_balance_covariates) {
  if (cov %in% names(small_parties)) {
    tryCatch({
      balance_check <- rdrobust(
        y = small_parties[[cov]],
        x = small_parties$centered_lagged_pervote_samlet,
        c = 0,
        p = 1,
        kernel = "triangular",
        bwselect = "mserd"
      )
      
      h4_right_balance_results <- rbind(h5_small_balance_results, data.frame(
        Covariate = cov,
        RDD_Estimate = balance_check$Estimate[1],
        Std_Error = balance_check$se[1],
        P_value = balance_check$pv[1]
      ))
    }, error = function(e) {
      cat("Error checking balance for", cov, "in small parties:", e$message, "\n")
    })
  }
}

# Print and save balance test results
if (requireNamespace("knitr", quietly = TRUE)) {
  knitr::kable(h5_large_balance_results, caption = "H5: Covariate Balance Tests (Large Parties)")
  knitr::kable(h5_small_balance_results, caption = "H5: Covariate Balance Tests (Small Parties)")
}

write.csv(h5_large_balance_results, "Robusthedstests/H5 tests - Appendiks/h5_large_balance_results.csv", row.names = FALSE)
write.csv(h5_small_balance_results, "Robusthedstests/H5 tests - Appendiks/h5_small_balance_results.csv", row.names = FALSE)

# 5.8 Visual RDD Plots for H5 (Party Size) ----------------
# Create clear RDD plots for main paper
h5_large_rdd_plot <- plot_rdd(
  data = large_parties,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered at threshold)",
  y_label = "Climate Position",
  title = "Effect on Large Parties"
)

h5_small_rdd_plot <- plot_rdd(
  data = small_parties,
  x_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  x_limit = 10,
  x_label = "Green Party Vote Share (centered at threshold)",
  y_label = "Climate Position",
  title = "Effect on Small Parties"
)

# Save RDD plots
ggsave("Robusthedstests/H5 tests - Appendiks/h5_large_rdd_plot.png", plot = h5_large_rdd_plot, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H5 tests - Appendiks/h5_small_rdd_plot.png", plot = h5_small_rdd_plot, width = 10, height = 6, dpi = 300)

# Create zoomed-in versions for better threshold visualization
h5_large_rdd_zoom <- jump_plot_cutoff(
  data = large_parties,
  force_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  polynomial = 1,
  window = 3
)

h5_small_rdd_zoom <- jump_plot_cutoff(
  data = small_parties,
  force_var = "centered_lagged_pervote_samlet",
  y_var = "miljø_afhængig",
  group_var = "factor_lagged_i_parlament",
  polynomial = 1,
  window = 3
)

# Save zoomed RDD plots
ggsave("Robusthedstests/H5 tests - Appendiks/h5_large_rdd_zoom.png", plot = h5_large_rdd_zoom, width = 10, height = 6, dpi = 300)
ggsave("Robusthedstests/H5 tests - Appendiks/h5_small_rdd_zoom.png", plot = h5_small_rdd_zoom, width = 10, height = 6, dpi = 300)

# 5.9 Combined Visual Comparison for H5 ----------------
# Combine size plots in a single figure
if (requireNamespace("gridExtra", quietly = TRUE)) {
  h5_size_combined <- gridExtra::grid.arrange(
    h5_large_rdd_plot, h5_small_rdd_plot,
    ncol = 2,
    top = "H5: Effect of Green Party Entry by Party Size"
  )
  
  # Save combined plots
  ggsave("Robusthedstests/H5 tests - Appendiks/h5_size_combined.png", plot = h5_size_combined, width = 12, height = 6, dpi = 300)
}

# 5.10 Outcome Placebo Tests for H5 (Party Size) ----------------
# Using variables that shouldn't be affected by treatment
placebo_vars <- c("rile_lowe", "per410") 

# Large Parties
h5_large_outcome_placebo <- run_outcome_placebo_test(
  data = large_parties,
  real_outcome_var = "miljø_afhængig",
  placebo_outcome_vars = placebo_vars,
  running_var = "centered_lagged_pervote_samlet",
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)

h5_large_outcome_placebo_plot <- plot_outcome_placebo_test(
  h5_large_outcome_placebo,
  title = "H5: Outcome Placebo Test (Large Parties)"
)

# Small Parties
h5_small_outcome_placebo <- run_outcome_placebo_test(
  data = small_parties,
  real_outcome_var = "miljø_afhængig",
  placebo_outcome_vars = placebo_vars,
  running_var = "centered_lagged_pervote_samlet",
  polynomial = 1,
  bandwidth = 2,
  covariates = c("country", "edate")
)

h5_small_outcome_placebo_plot <- plot_outcome_placebo_test(
  h5_small_outcome_placebo,
  title = "H5: Outcome Placebo Test (Small Parties)"
)

ggsave("Robusthedstests/H5 tests - Appendiks/h5_large_outcome_placebo.png", plot = h5_large_outcome_placebo_plot, width = 8, height = 6, dpi = 300)

# 5.11 Summary of Test Results for H5 ----------------
# Kør hver rdrobust separat først (hvis ikke allerede gjort i tidligere kode)
# Bemærk: Hvis du allerede har kørt disse i 5.12, kan du genbruge resultaterne
if (!exists("large_parties_rdd")) {
  large_parties_rdd <- tryCatch(rdrobust(
    y = large_parties$miljø_afhængig,
    x = large_parties$centered_lagged_pervote_samlet,
    c = 0, p = 1, h = 2, kernel = "triangular"
  ), error = function(e) {
    cat("Fejl i Large Parties RDD:", e$message, "\n")
    return(NULL)
  })
}

if (!exists("small_parties_rdd")) {
  small_parties_rdd <- tryCatch(rdrobust(
    y = small_parties$miljø_afhængig,
    x = small_parties$centered_lagged_pervote_samlet,
    c = 0, p = 1, h = 2, kernel = "triangular"
  ), error = function(e) {
    cat("Fejl i Small Parties RDD:", e$message, "\n")
    return(NULL)
  })
}

# Tjek om analyserne lykkedes
cat("Large Parties RDD:", ifelse(!is.null(large_parties_rdd), "Succes", "Fejl"), "\n")
cat("Small Parties RDD:", ifelse(!is.null(small_parties_rdd), "Succes", "Fejl"), "\n")

# Opret summary tabel med sikker håndtering af resultater
h5_test_summary <- data.frame(
  Subgroup = c("Large Parties", "Small Parties"),
  Main_RDD_Effect = c(
    ifelse(!is.null(large_parties_rdd), 
           sprintf("%.3f (p=%.3f)", large_parties_rdd$Estimate[1], large_parties_rdd$pv[1]), 
           "N/A"),
    ifelse(!is.null(small_parties_rdd), 
           sprintf("%.3f (p=%.3f)", small_parties_rdd$Estimate[1], small_parties_rdd$pv[1]), 
           "N/A")
  ),
  Placebo_p_value = c(
    ifelse(exists("h5_large_placebo") && !is.null(h5_large_placebo$empirical_p_value), 
           h5_large_placebo$empirical_p_value, NA),
    ifelse(exists("h5_small_placebo") && !is.null(h5_small_placebo$empirical_p_value), 
           h5_small_placebo$empirical_p_value, NA)
  ),
  Density_p_value = c(
    ifelse(exists("h5_large_density_summary") && !is.null(h5_large_density_summary$p_value), 
           h5_large_density_summary$p_value, NA),
    ifelse(exists("h5_small_density_summary") && !is.null(h5_small_density_summary$p_value), 
           h5_small_density_summary$p_value, NA)
  )
)

# Tilføj additional kolonner som f.eks. Permutation_p_value hvis de findes
if (exists("h5_large_permutation") && exists("h5_small_permutation")) {
  h5_test_summary$Permutation_p_value <- c(
    ifelse(!is.null(h5_large_permutation$p_value_effect), h5_large_permutation$p_value_effect, NA),
    ifelse(!is.null(h5_small_permutation$p_value_effect), h5_small_permutation$p_value_effect, NA)
  )
}

# Print og gem summary tabel
if (requireNamespace("knitr", quietly = TRUE)) {
  print(knitr::kable(h5_test_summary, 
                    caption = "H5: Summary of Test Results by Party Size"))
}

write.csv(h5_test_summary, "Robusthedstests/H5 tests - Appendiks/h5_test_summary.csv", row.names = FALSE)

# 5.12 Compare treatment effects across party sizes ----------------
# Kør hver rdrobust separat og fang eventuelle fejl
large_parties_rdd <- tryCatch(rdrobust(
  y = large_parties$miljø_afhængig,
  x = large_parties$centered_lagged_pervote_samlet,
  c = 0, p = 1, h = 2, kernel = "triangular"
), error = function(e) {
  cat("Fejl i Large Parties RDD:", e$message, "\n")
  return(NULL)
})

small_parties_rdd <- tryCatch(rdrobust(
  y = small_parties$miljø_afhængig,
  x = small_parties$centered_lagged_pervote_samlet,
  c = 0, p = 1, h = 2, kernel = "triangular"
), error = function(e) {
  cat("Fejl i Small Parties RDD:", e$message, "\n")
  return(NULL)
})

# Tjek om analyserne lykkedes
cat("Large Parties RDD:", ifelse(!is.null(large_parties_rdd), "Succes", "Fejl"), "\n")
cat("Small Parties RDD:", ifelse(!is.null(small_parties_rdd), "Succes", "Fejl"), "\n")

# Opret en tom dataframe til at begynde med
h5_comparison_data <- data.frame(
  Size = character(),
  Estimate = numeric(),
  SE = numeric(),
  stringsAsFactors = FALSE
)

# Tilføj resultater fra large parties RDD hvis det fungerede
if (!is.null(large_parties_rdd)) {
  h5_comparison_data <- rbind(h5_comparison_data, data.frame(
    Size = "Large Parties",
    Estimate = large_parties_rdd$Estimate[1],
    SE = large_parties_rdd$se[1],
    stringsAsFactors = FALSE
  ))
}

# Tilføj resultater fra small parties RDD hvis det fungerede
if (!is.null(small_parties_rdd)) {
  h5_comparison_data <- rbind(h5_comparison_data, data.frame(
    Size = "Small Parties",
    Estimate = small_parties_rdd$Estimate[1],
    SE = small_parties_rdd$se[1],
    stringsAsFactors = FALSE
  ))
}

# Vis antal rækker i den endelige dataframe
cat("Antal rækker i h5_comparison_data:", nrow(h5_comparison_data), "\n")

# Kun fortsæt hvis der er data at arbejde med
if (nrow(h5_comparison_data) > 0) {
  # Beregn 95% konfidensintervaller
  h5_comparison_data$CI_lower <- h5_comparison_data$Estimate - 1.96 * h5_comparison_data$SE
  h5_comparison_data$CI_upper <- h5_comparison_data$Estimate + 1.96 * h5_comparison_data$SE
  
  # Tilføj p-værdier
  h5_comparison_data$P_value <- c(
    if (!is.null(large_parties_rdd) && "Large Parties" %in% h5_comparison_data$Size) large_parties_rdd$pv[1] else NA,
    if (!is.null(small_parties_rdd) && "Small Parties" %in% h5_comparison_data$Size) small_parties_rdd$pv[1] else NA
  )[match(h5_comparison_data$Size, c("Large Parties", "Small Parties"))]
  
  # Tilføj signifikansmarkør
  h5_comparison_data$Significance <- ifelse(h5_comparison_data$P_value < 0.05, "*", 
                                          ifelse(h5_comparison_data$P_value < 0.1, "†", ""))
  
  # Formater resultater for pæn visning
  h5_comparison_data$Result <- sprintf("%.3f%s (%.3f)",
                                     h5_comparison_data$Estimate,
                                     h5_comparison_data$Significance,
                                     h5_comparison_data$SE)
  
  # Vis den pæne tabel
  if (requireNamespace("knitr", quietly = TRUE)) {
    print(knitr::kable(h5_comparison_data[, c("Size", "Result", "P_value", "CI_lower", "CI_upper")],
                      caption = "H5: Sammenligning af effekter på tværs af partistørrelser",
                      digits = 3))
  }
  
  # Create dot-whisker plot
  h5_comparison_plot <- ggplot(h5_comparison_data, aes(x = Estimate, y = Size)) +
    geom_point(size = 3) +
    geom_errorbarh(aes(xmin = CI_lower, xmax = CI_upper), height = 0.2) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
    labs(
      title = "H5: Treatment Effects by Party Size",
      x = "Estimated Effect (with 95% CI)",
      y = ""
    ) +
    theme_minimal()
  
  # Save comparison plot
  ggsave("Robusthedstests/H5 tests - Appendiks/h5_treatment_effects_comparison.png", plot = h5_comparison_plot, width = 10, height = 6, dpi = 300)
  
  # Vis plottet
  print(h5_comparison_plot)
} else {
  cat("Ingen resultater at vise eller plotte for H5 sammenligning\n")
}

# ============================================================================
# 6. SUMMARY OF RESULTS
# ============================================================================

# Create tables summarizing placebo p-values, permutation p-values, etc.
#placebo_summary <- data.frame(
#  Model = c(
#    "H1: All parties",
#    "H2: No radical right parties",
#    "H2: With radical right parties",
#    # Continue with all models
#  ),
#  Placebo_p_value = c(
#    h1_placebo_threshold$empirical_p_value,
#    h2_no_rrp_placebo$empirical_p_value,
#    h2_with_rrp_placebo$empirical_p_value,
#    # Continue with all values
#  )
#)
#print(placebo_summary)
#write.csv(placebo_summary, "placebo_summary.csv", row.names = FALSE)

# Similar summaries for permutation tests, density tests, etc.

```



